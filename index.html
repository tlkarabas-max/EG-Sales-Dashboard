<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Performance Dashboard - Enhanced</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; }
    .header { background: white; padding: 15px 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 24px; font-weight: 600; }
    .login-container { max-width: 900px; margin: 100px auto; padding: 20px; }
    .login-header { text-align: center; margin-bottom: 40px; }
    .login-header h2 { font-size: 32px; color: #333; }
    .login-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; max-width: 800px; margin: 0 auto; }
    .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
    .login-box h3 { color: #007bff; font-size: 24px; margin-bottom: 10px; }
    .login-box p { color: #6c757d; margin-bottom: 30px; font-size: 14px; }
    .login-form { display: flex; flex-direction: column; gap: 15px; }
    .login-form input, .login-form select { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; width: 100%; }
    .login-btn { padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer; color: white; transition: all 0.3s; }
    .staff-login-btn { background: #28a745; }
    .staff-login-btn:hover { background: #218838; }
    .admin-login-btn { background: #007bff; }
    .admin-login-btn:hover { background: #0056b3; }
    .logout-btn { background: white; color: #dc3545; border: 1px solid #dc3545; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; }
    .logout-btn:hover { background: #dc3545; color: white; }
    .hidden { display: none !important; }
    .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 5px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 350px; animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    .notification.success { background: #28a745; color: white; }
    .notification.error { background: #dc3545; color: white; }
    .staff-container { padding: 30px; max-width: 1400px; margin: 0 auto; }
    
    /* Enhanced Staff Dashboard Styles */
    .welcome-section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .period-selector-staff { margin-top: 10px; padding: 8px 16px; border-radius: 5px; border: 1px solid #ddd; font-size: 14px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; transition: transform 0.3s; position: relative; }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .stat-label { color: #666; font-size: 12px; text-transform: uppercase; margin-bottom: 10px; font-weight: 600; }
    .stat-value { font-size: 48px; font-weight: bold; color: #007bff; margin-bottom: 10px; }
    .stat-goal { font-size: 14px; color: #666; margin-bottom: 15px; }
    .status-badge { padding: 4px 8px; border-radius: 15px; font-size: 12px; font-weight: 600; display: inline-block; margin-bottom: 10px; color: white; }
    .status-green { background: #28a745; }
    .status-yellow { background: #ffc107; color: #333; }
    .status-red { background: #dc3545; }
    
    /* Metric displays */
    .metric-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 13px; }
    .metric-label { color: #666; }
    .metric-value { font-weight: 600; color: #333; }
    .hours-indicator { position: absolute; top: 10px; right: 10px; background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    
    .efficiency-section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .efficiency-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px; }
    .efficiency-card { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    .efficiency-value { font-size: 24px; font-weight: bold; color: #28a745; margin-bottom: 5px; }
    .efficiency-label { font-size: 12px; color: #666; }
    
    .comparison-table { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .comparison-table h3 { color: #333; margin-bottom: 15px; font-size: 18px; }
    .comparison-table table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .comparison-table th { padding: 10px; text-align: left; border: 1px solid #dee2e6; font-weight: 600; background: #f8f9fa; }
    .comparison-table td { padding: 10px; border: 1px solid #dee2e6; text-align: center; }
    .user-row { background: #e3f2fd; font-weight: bold; }
    
    .bonus-section { background: linear-gradient(135deg, #374151, #4b5563); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
    .bonus-total { font-size: 36px; font-weight: bold; margin-bottom: 20px; }
    .bonus-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
    .bonus-item { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center; }
    
    .tips-section { background: #e3f2fd; padding: 20px; border-radius: 10px; border-left: 4px solid #2196f3; }
    .tips-section h3 { color: #1976d2; margin-bottom: 10px; font-size: 16px; }
    .tips-section ul { list-style: none; padding: 0; }
    .tips-section li { padding: 5px 0; color: #555; font-size: 14px; }
    .tips-section li:before { content: "‚úì "; color: #1976d2; font-weight: bold; margin-right: 8px; }
    
    /* Admin Dashboard Styles */
    .admin-container { padding: 30px; max-width: 1400px; margin: 0 auto; }
    .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .admin-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .admin-card h3 { color: #333; margin-bottom: 15px; font-size: 18px; }
    .team-table { width: 100%; border-collapse: collapse; }
    .team-table th { padding: 12px; text-align: left; background: #f8f9fa; border-bottom: 2px solid #dee2e6; font-size: 13px; }
    .team-table td { padding: 12px; border-bottom: 1px solid #dee2e6; font-size: 13px; }
    .performance-bar { height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; }
    .performance-fill { height: 100%; background: #28a745; transition: width 0.3s; }
    
    .trend-indicator { display: inline-block; margin-left: 5px; font-size: 12px; }
    .trend-up { color: #28a745; }
    .trend-down { color: #dc3545; }
    .trend-neutral { color: #6c757d; }
    
    @media (max-width: 768px) {
      .login-grid { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr; }
      .bonus-breakdown { grid-template-columns: 1fr; }
      .efficiency-grid { grid-template-columns: 1fr; }
    }
    
    /* Fix layout issues */
    .staff-container > * {
      margin-bottom: 20px;
      clear: both;
    }
    
    .comparison-table {
      clear: both;
      width: 100%;
      margin-bottom: 20px;
    }
    
    .bonus-section {
      clear: both;
      width: 100%;
      margin-bottom: 20px;
    }
    
    .tips-section {
      clear: both;
      width: 100%;
      margin-bottom: 20px;
    }
    
    /* Ensure proper spacing between sections */
    .stats-grid {
      margin-bottom: 30px !important;
    }
    
    /* Fix table overflow */
    .comparison-table table {
      width: 100%;
      table-layout: auto;
    }
    
    .comparison-table td, .comparison-table th {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Fix Performance Tips positioning */
    .tips-section {
      clear: both;
      width: 100%;
      margin: 20px 0;
      position: relative;
    }
    
    /* Fix grid layout for side-by-side sections */
    .staff-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    /* Stack Team Comparison and Bonus sections vertically */
    .comparison-table {
      width: 100%;
      margin-bottom: 20px;
    }
    
    .bonus-section {
      width: 100%;
      max-width: none;
      margin-bottom: 20px;
    }

    /* Quick Actions Panel Styles */
    .quick-actions {
      position: fixed;
      right: 20px;
      bottom: 20px;
      background: white;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      z-index: 1000;
      transition: all 0.3s ease;
    }
    
    .quick-actions.minimized {
      padding: 10px;
    }
    
    .quick-actions.minimized .quick-actions-buttons {
      display: none;
    }
    
    .quick-actions-header {
      cursor: pointer;
      text-align: center;
      font-size: 20px;
      margin-bottom: 10px;
    }
    
    .quick-actions.minimized .quick-actions-header {
      margin-bottom: 0;
    }
    
    .quick-actions-buttons {
      display: flex;
      gap: 10px;
    }
    
    .quick-action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      border: none;
      background: #f0f2f5;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 60px;
    }
    
    .quick-action-btn:hover {
      background: #e3f2fd;
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .action-icon {
      font-size: 24px;
      margin-bottom: 4px;
    }
    
    .action-label {
      font-size: 11px;
      color: #666;
      font-weight: 600;
    }
    
    @media print {
      .quick-actions {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- LOGIN SECTION - Always visible unless logged in -->
  <div id="loginSection">
    <div class="header">
      <h1>Performance Dashboard</h1>
    </div>
    <div class="login-container">
      <div class="login-header">
        <h2>Performance Dashboard Login</h2>
      </div>
      <div class="login-grid">
        <div class="login-box">
          <h3>Staff Login</h3>
          <p>Experience Guides - Access your personal dashboard</p>
          <div class="login-form">
            <select id="staffSelect">
              <option value="">Select your name...</option>
              <!-- Options will be populated dynamically from CSV data -->
            </select>
            <input type="password" id="staffPassword" placeholder="Enter your Staff ID">
<button class="login-btn staff-login-btn" onclick="loginStaff()">Login as Staff</button>
          </div>
        </div>
        <div class="login-box">
          <h3>Admin Login</h3>
          <p>Managers - Access all dashboards and reports</p>
          <div class="login-form">
            <input type="password" id="adminPassword" placeholder="Enter admin password">
            <button class="login-btn admin-login-btn" onclick="loginAdmin()">Login as Admin</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- STAFF VIEW - Hidden until staff login -->
  <div id="staffView" class="hidden">
    <div class="header">
      <h1 id="staffTitle">Performance Dashboard</h1>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
    
    <div class="staff-container">
      <div class="welcome-section">
        <h2>Welcome, <span id="staffName">Staff Member</span>!</h2>
        <p>Your Performance for <span id="staffPeriodDisplay">Current Period</span></p>
        <label for="staffPeriodSelector">Select Period:</label>
        <div id="staffPeriodDropdown"></div>
      </div>
      
      <div class="tips-section">
        <h3>Performance Tips</h3>
        <ul id="performanceTips">
          <li>Loading personalized tips...</li>
        </ul>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="hours-indicator" id="hoursWorked">0 hrs</div>
          <div class="stat-label">ENHANCEMENTS</div>
          <div class="stat-value" id="enhanceValue">0</div>
          <div class="stat-goal">Goal: <span id="enhanceAdjusted">0</span></div>
          <div class="status-badge" id="enhanceStatus">0%</div>
          <div id="enhanceMessage">Loading...</div>
        </div>

        <div class="stat-card">
          <div class="stat-label">MEMBERSHIPS</div>
          <div class="stat-value" id="memberValue">0</div>
          <div class="stat-goal">Conv Goal: <span id="convGoal">0%</span> | Actual: <span id="convActual">0%</span></div>
          <div class="status-badge" id="memberStatus">0%</div>
          <div id="memberMessage">Loading...</div>
          <div class="metric-row">
            <span class="metric-label">Eligible Guests:</span>
            <span class="metric-value" id="eligibleGuestsCount">0</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-label">REBOOK RATE</div>
          <div class="stat-value" id="rebookValue">0%</div>
          <div class="stat-goal">Target: 20%</div>
          <div class="status-badge" id="rebookStatus">Loading</div>
          <div id="rebookMessage">Loading...</div>
          <div class="metric-row">
            <span class="metric-label">Total Guests:</span>
            <span class="metric-value" id="totalGuestsServed">0</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-label">PERFORMANCE SCORE</div>
          <div class="stat-value" id="overallValue">0%</div>
          <div class="stat-goal">Adjusted for Hours & Conversion</div>
          <div class="status-badge" id="overallStatus">Loading</div>
          <div id="overallMessage">Loading...</div>
          <div class="metric-row">
            <span class="metric-label">Trend:</span>
            <span class="metric-value" id="performanceTrend">--</span>
          </div>
        </div>
      </div>
      
      <div class="comparison-table">
        <h3>Team Comparison</h3>
        <table>
          <thead>
            <tr>
              <th>Metric</th>
              <th>You</th>
              <th>Team Avg</th>
              <th>Top Performer</th>
            </tr>
          </thead>
          <tbody>
            <tr class="user-row">
              <td>Conversion Rate</td>
              <td id="yourConv">0%</td>
              <td id="avgConv">0%</td>
              <td id="topConv">0%</td>
            </tr>
            <tr>
              <td>Enhancements/Hour</td>
              <td id="yourEnhPerHour">0.00</td>
              <td id="avgEnhPerHour">0.00</td>
              <td id="topEnhPerHour">0.00</td>
            </tr>
            <tr class="user-row">
              <td>Members/Hour</td>
              <td id="yourMemPerHour">0.00</td>
              <td id="avgMemPerHour">0.00</td>
              <td id="topMemPerHour">0.00</td>
            </tr>
            <tr>
              <td>Rebook Rate</td>
              <td id="yourRebook">0%</td>
              <td id="avgRebook">0%</td>
              <td id="topRebook">0%</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="bonus-section">
        <h3>My Bonus Earnings - <span id="bonusPeriodDisplay">Current Period</span></h3>
        <div class="bonus-total" id="totalBonus">$0.00</div>
        <div class="bonus-breakdown">
          <div class="bonus-item">
            <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">Enhancement</div>
            <div style="font-size: 24px; font-weight: bold;" id="enhanceBonus">$0.00</div>
          </div>
          <div class="bonus-item">
            <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">Membership</div>
            <div style="font-size: 24px; font-weight: bold;" id="membershipBonus">$0.00</div>
          </div>
          <div class="bonus-item">
            <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">Performance</div>
            <div style="font-size: 24px; font-weight: bold;" id="performanceBonus">$0.00</div>
          </div>
        </div>
      </div>

      <div id="performanceTrendChart"></div>
    </div>
  </div>
  
  <!-- ADMIN VIEW - Hidden until admin login -->
  <div id="adminView" class="hidden">
    <div class="header">
      <h1>Admin Dashboard - Team Overview</h1>
      <div style="display: flex; gap: 10px; align-items: center;">
        <div id="adminPeriodDropdown"></div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
    
    <div class="admin-container">
      <div class="admin-grid">
        <div class="admin-card">
          <h3>Team Summary</h3>
          <div style="display: flex; justify-content: space-between; margin: 10px 0;">
            <span>Total Staff:</span>
            <strong>7</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin: 10px 0;">
            <span>Total Hours:</span>
            <strong id="totalHours">0</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin: 10px 0;">
            <span>Avg Conversion:</span>
            <strong id="avgConvAdmin">0%</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin: 10px 0;">
            <span>Avg Rebook Rate:</span>
            <strong id="avgRebookAdmin">0%</strong>
          </div>
        </div>
        
        <div class="admin-card">
          <h3>Top Performers (Adjusted)</h3>
          <ol id="topPerformers" style="padding-left: 20px;">
            <li>Loading...</li>
          </ol>
        </div>
        
        <div class="admin-card">
          <h3>Total Individual Bonuses</h3>
          <div style="font-size: 32px; font-weight: bold; color: #4a5568; text-align: center; margin: 20px 0;">
            <span id="totalTeamBonus">$0.00</span>
          </div>
          <p style="text-align: center; color: #666; font-size: 14px;">Sum of All Staff Bonuses</p>
        </div>
      </div>
      
      <div class="admin-card">
        <h3>Full Team Performance</h3>
        <table class="team-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Hours</th>
              <th>Members</th>
              <th>Conv %</th>
              <th>Goal %</th>
              <th>Enhance</th>
              <th>Enh Goal</th>
              <th>Rebook Goal</th>
              <th>Rebook</th>
              <th>Bonus</th>
              <th>Score</th>
            </tr>
          </thead>
          <tbody id="teamTableBody">
            <tr>
              <td colspan="11" style="text-align: center;">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Data Upload Section -->
      <div class="admin-card" style="margin-top: 20px;">
        <h3 style="font-size: 18px; margin-bottom: 20px; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px;">
          <span style="color: #007bff;">üìä</span> Data Management Center
        </h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
          <!-- Left Column - File Uploads -->
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
            <h4 style="font-size: 15px; margin-bottom: 15px; color: #495057; font-weight: 600;">
              Import Data Files
            </h4>
            
            <div style="display: flex; flex-direction: column; gap: 10px;">
              <!-- Appointment Data -->
              <div class="upload-item" style="display: flex; align-items: center; gap: 10px;">
                <button onclick="document.getElementById('appointmentFile').click()" 
                        style="flex: 1; background: white; color: #495057; border: 1px solid #ced4da; 
                               padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; 
                               text-align: left; display: flex; align-items: center; gap: 8px;
                               transition: all 0.2s;"
                        onmouseover="this.style.background='#e3f2fd'; this.style.borderColor='#2196f3';"
                        onmouseout="this.style.background='white'; this.style.borderColor='#ced4da';">
                  <span style="font-size: 16px;">üìÖ</span>
                  <span>Appointment Data</span>
                  <span style="margin-left: auto; color: #6c757d; font-size: 12px;">CSV</span>
                </button>
                <input type="file" id="appointmentFile" accept=".csv" style="display: none;" 
                       onchange="handleAppointmentUpload(event)">
              </div>
              
              <!-- Membership Data -->
              <div class="upload-item" style="display: flex; align-items: center; gap: 10px;">
                <button onclick="document.getElementById('membershipFile').click()" 
                        style="flex: 1; background: white; color: #495057; border: 1px solid #ced4da; 
                               padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; 
                               text-align: left; display: flex; align-items: center; gap: 8px;
                               transition: all 0.2s;"
                        onmouseover="this.style.background='#fff3e0'; this.style.borderColor='#ff9800';"
                        onmouseout="this.style.background='white'; this.style.borderColor='#ced4da';">
                  <span style="font-size: 16px;">üë•</span>
                  <span>Membership Data</span>
                  <span style="margin-left: auto; color: #6c757d; font-size: 12px;">CSV</span>
                </button>
                <input type="file" id="membershipFile" accept=".csv" style="display: none;" 
                       onchange="handleMembershipUpload(event)">
              </div>
              
              <!-- Sales Data -->
              <div class="upload-item" style="display: flex; align-items: center; gap: 10px;">
                <button onclick="document.getElementById('salesFile').click()" 
                        style="flex: 1; background: white; color: #495057; border: 1px solid #ced4da; 
                               padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; 
                               text-align: left; display: flex; align-items: center; gap: 8px;
                               transition: all 0.2s;"
                        onmouseover="this.style.background='#e8f5e9'; this.style.borderColor='#4caf50';"
                        onmouseout="this.style.background='white'; this.style.borderColor='#ced4da';">
                  <span style="font-size: 16px;">üí∞</span>
                  <span>Sales Data</span>
                  <span style="margin-left: auto; color: #6c757d; font-size: 12px;">CSV</span>
                </button>
                <input type="file" id="salesFile" accept=".csv" style="display: none;" 
                       onchange="handleSalesUpload(event)">
              </div>
              
              <!-- OOT Data -->
              <div class="upload-item" style="display: flex; align-items: center; gap: 10px;">
                <button onclick="document.getElementById('ootFile').click()" 
                        style="flex: 1; background: white; color: #495057; border: 1px solid #ced4da; 
                               padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; 
                               text-align: left; display: flex; align-items: center; gap: 8px;
                               transition: all 0.2s;"
                        onmouseover="this.style.background='#f3e5f5'; this.style.borderColor='#9c27b0';"
                        onmouseout="this.style.background='white'; this.style.borderColor='#ced4da';">
                  <span style="font-size: 16px;">üìç</span>
                  <span>OOT Data</span>
                  <span style="margin-left: auto; color: #6c757d; font-size: 12px;">CSV</span>
                </button>
                <input type="file" id="ootFile" accept=".csv" style="display: none;" 
                       onchange="handleOOTUpload(event)">
              </div>
              
              <!-- Payroll Hours -->
              <div class="upload-item" style="display: flex; align-items: center; gap: 10px;">
                <button onclick="document.getElementById('payrollFile').click()" 
                        style="flex: 1; background: white; color: #495057; border: 1px solid #ced4da; 
                               padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; 
                               text-align: left; display: flex; align-items: center; gap: 8px;
                               transition: all 0.2s;"
                        onmouseover="this.style.background='#fef4e7'; this.style.borderColor='#fd7e14';"
                        onmouseout="this.style.background='white'; this.style.borderColor='#ced4da';">
                  <span style="font-size: 16px;">‚è∞</span>
                  <span>Payroll Hours</span>
                  <span style="margin-left: auto; color: #6c757d; font-size: 12px;">CSV</span>
                </button>
                <input type="file" id="payrollFile" accept=".csv" style="display: none;" 
                       onchange="handlePayrollUpload(event)">
              </div>
              
              <!-- Bonus Structure -->
              <div class="upload-item" style="display: flex; align-items: center; gap: 10px;">
                <button onclick="document.getElementById('bonusFile').click()" 
                        id="bonusUploadBtn"
                        style="flex: 1; background: white; color: #495057; border: 1px solid #ced4da; 
                               padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; 
                               text-align: left; display: flex; align-items: center; gap: 8px;
                               transition: all 0.2s;"
                        onmouseover="this.style.background='#e0f7fa'; this.style.borderColor='#00acc1';"
                        onmouseout="this.style.background='white'; this.style.borderColor='#ced4da';">
                  <span style="font-size: 16px;">üíµ</span>
                  <span>Bonus Structure</span>
                  <span style="margin-left: auto; color: #6c757d; font-size: 12px;">CSV</span>
                </button>
                <input type="file" id="bonusFile" accept=".csv" style="display: none;" 
                       onchange="handleBonusUpload(event)">
              </div>
            </div>
          </div>

          <!-- Middle Column - Processing & Management -->
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
            <h4 style="font-size: 15px; margin-bottom: 15px; color: #495057; font-weight: 600;">
              Processing & Management
            </h4>
            
            <div style="display: flex; flex-direction: column; gap: 10px;">
              <!-- Validate Data Button -->
              <button onclick="DataValidator.showValidationPreview()" 
                      style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                             color: white; border: none; padding: 12px 20px; 
                             border-radius: 6px; cursor: pointer; font-size: 14px; 
                             font-weight: 600; display: flex; align-items: center; 
                             justify-content: center; gap: 8px; transition: all 0.3s;
                             box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);"
                      onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(102, 126, 234, 0.4)';"
                      onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(102, 126, 234, 0.3)';">
                <span>‚úì</span> Validate Data First
              </button>
              
              <!-- Process All Data Button -->
              <button onclick="processAllData()" 
                      style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
                             color: white; border: none; padding: 12px 20px; 
                             border-radius: 6px; cursor: pointer; font-size: 14px; 
                             font-weight: 600; display: flex; align-items: center; 
                             justify-content: center; gap: 8px; transition: all 0.3s;
                             box-shadow: 0 2px 4px rgba(245, 87, 108, 0.3);"
                      onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(245, 87, 108, 0.4)';"
                      onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(245, 87, 108, 0.3)';">
                <span>‚ö°</span> Process All Data
              </button>
              
              <!-- Staff List Upload -->
              <button onclick="document.getElementById('staffListFile').click()" 
                      style="background: white; color: #495057; 
                             border: 2px solid #dee2e6; padding: 12px 20px; 
                             border-radius: 6px; cursor: pointer; font-size: 14px; 
                             font-weight: 600; display: flex; align-items: center; 
                             justify-content: center; gap: 8px; transition: all 0.3s;"
                      onmouseover="this.style.borderColor='#6c757d'; this.style.color='#6c757d'; this.style.background='#f8f9fa';"
                      onmouseout="this.style.borderColor='#dee2e6'; this.style.color='#495057'; this.style.background='white';">
                <span>üë§</span> Update Staff List CSV
              </button>
              <input type="file" id="staffListFile" accept=".csv" style="display: none;" 
                     onchange="handleStaffListUpload(event)">
              
              <!-- Divider -->
              <div style="border-top: 1px solid #dee2e6; margin: 5px 0;"></div>
              
              <!-- Staff Management Button -->
              <button onclick="openSimpleStaffManager()" 
                      style="background: white; color: #495057; 
                             border: 2px solid #dee2e6; padding: 12px 20px; 
                             border-radius: 6px; cursor: pointer; font-size: 14px; 
                             font-weight: 600; display: flex; align-items: center; 
                             justify-content: center; gap: 8px; transition: all 0.3s;"
                      onmouseover="this.style.borderColor='#007bff'; this.style.color='#007bff'; this.style.background='#f8f9fa';"
                      onmouseout="this.style.borderColor='#dee2e6'; this.style.color='#495057'; this.style.background='white';">
                <span>üë•</span> Quick Add/Remove Staff
              </button>
              
              <!-- Status Indicator -->
              <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #6c757d;">
                  <span style="width: 8px; height: 8px; background: #28a745; border-radius: 50%; display: inline-block;"></span>
                  <span>System Ready</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Right Column - Upload Timestamps -->
          <div id="uploadTimestampsDisplay" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
            <!-- This will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Staff Manager Popup -->
  <div id="simpleStaffManager" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10000; width: 500px; max-width: 90%;">
    <h3 style="margin-bottom: 20px; color: #333;">Staff Management Center</h3>
    
    <!-- Add New Staff Section -->
    <div style="margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
      <h4 style="font-size: 16px; margin-bottom: 15px; color: #28a745;">‚ûï Add New Staff Member</h4>
      <input type="text" id="quickStaffName" placeholder="Full Name (e.g., John Smith)" 
             style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
      <input type="email" id="quickStaffEmail" placeholder="Email (e.g., john.smith@company.com)" 
             style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
      <select id="quickStaffTenure" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
        <option value="0">New Hire (0-1 months)</option>
        <option value="1">1 month</option>
        <option value="2">2 months</option>
        <option value="3">3-6 months</option>
        <option value="6">6-12 months</option>
        <option value="12">1+ years</option>
      </select>
      <button onclick="addStaffMember()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: 600;">
        Add Staff Member
      </button>
    </div>
    
    <!-- Remove Staff Section -->
    <div style="margin-bottom: 20px; padding: 20px; background: #fff5f5; border-radius: 8px;">
      <h4 style="font-size: 16px; margin-bottom: 15px; color: #dc3545;">‚ûñ Remove Staff Member</h4>
      <select id="quickRemoveSelect" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
        <option value="">Select staff to remove...</option>
      </select>
      <button onclick="removeStaffMember()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: 600;">
        Remove Selected Staff
      </button>
    </div>
    
    <button onclick="closeSimpleStaffManager()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: 600;">
      Close
    </button>
  </div>

  <!-- Quick Actions Panel -->
  <div class="quick-actions" id="quickActionsPanel" style="display: none;">
    <div class="quick-actions-header" onclick="toggleQuickActions()">
      <span>‚ö°</span>
    </div>
    <div class="quick-actions-buttons">
      <button onclick="exportToCSV()" class="quick-action-btn" title="Export Data">
        <span class="action-icon">üìä</span>
        <span class="action-label">Export</span>
      </button>
      <button onclick="printDashboard()" class="quick-action-btn" title="Print">
        <span class="action-icon">üñ®Ô∏è</span>
        <span class="action-label">Print</span>
      </button>
      <button onclick="refreshData()" class="quick-action-btn" title="Refresh">
        <span class="action-icon">üîÑ</span>
        <span class="action-label">Refresh</span>
      </button>
    </div>
  </div>

  <!-- Firebase Authentication Scripts - CORRECTED URLS -->
<script src="https://cdn.jsdelivr.net/npm/firebase@10.7.1/firebase-app-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/firebase@10.7.1/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/firebase@10.7.1/firebase-database-compat.js"></script>
  <!-- Main Application Script -->
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD35d3diHbqdj2yrU8Mq1NQGvC4SXfZLr0",
      authDomain: "salesdashboard-e28a1.firebaseapp.com",
      databaseURL: "https://salesdashboard-e28a1-default-rtdb.firebaseio.com",
      projectId: "salesdashboard-e28a1",
      storageBucket: "salesdashboard-e28a1.appspot.com",
      messagingSenderId: "497089067660",
      appId: "1:497089067660:web:92cee755dbbad692b5d9a9",
      measurementId: "G-9MZZ5DV3FW"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // Global approved staff list
    window.APPROVED_STAFF = [
      'Angela McNally',
      'Anna Mercadante', 
      'Madison Jeske',
      'Di Fisher',
      'Edward Franklin',
      'Jessica Watts',
      'Nicole Rice'
    ];

    // Global variables
    let BONUS_RATES = {
      enhancement: { tier1: 0.70, tier2: 0.80, tier3: 0.90 },
      membership: { tier1: 10, tier2: 15, tier3: 20 },
      performanceBonus: 50
    };

    let currentUser = null;
    let currentPeriod = 'current';
    let staffData = {};
    let periodData = {};
    let uploadedData = {
      appointments: null,
      memberships: null,
      sales: null,
      oot: null,
      payroll: null,
      bonusStructure: null,
      staffList: null
    };
    let uploadTimestamps = {
      appointments: null,
      memberships: null,
      sales: null,
      oot: null,
      payroll: null,
      bonusStructure: null,
      staffList: null
    };
    let payrollData = null;
    let payPeriods = [];
    let parsedAppointments = null;
    let parsedMemberships = null;
    let parsedSales = null;
    let parsedOOT = null;

    const PERFORMANCE_THRESHOLDS = {
      excellent: 100,
      good: 80,
      acceptable: 60
    };

    const CONVERSION_CONFIG = {
      localNonMemberRate: 0.366
    };

    const DEFAULT_STAFF_STRUCTURE = {
      enhance: 0,
      enhanceGoal: 10,
      member: 0,
      memberGoal: 3,
      rebook: 0,
      hours: 0,
      eligibleGuests: 0,
      totalGuests: 0,
      prevPerformance: 0,
      tenureMonths: 0,
      bonus: 0
    };

// Helper functions
function normalizeName(name) {
  if (!name) return '';
  // Convert to lowercase and normalize spaces
  return name.toLowerCase().trim().replace(/\s+/g, ' ');
}

function showNotification(message, type = 'info') {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.style.animation = 'slideOut 0.3s ease';
    setTimeout(() => notification.remove(), 300);
  }, 3000);
}

// Replace your existing parseCSV function around line 865 with this improved version:
function parseCSV(text) {
  // Handle different input types
  if (typeof text === 'object') {
    console.warn('parseCSV received an object instead of string, skipping parse');
    return [];
  }
  
  if (typeof text !== 'string') {
    console.error('parseCSV expects a string, got:', typeof text);
    return [];
  }
  
  if (!text || text.trim() === '') {
    console.warn('parseCSV received empty string');
    return [];
  }
  
  try {
    const result = Papa.parse(text, {
      header: true,
      skipEmptyLines: true
    });
    
    if (result.errors && result.errors.length > 0) {
      console.warn('CSV parsing warnings:', result.errors);
    }
    
    return result.data || [];
  } catch (error) {
    console.error('CSV parsing error:', error);
    return [];
  }
}

function parseDateConsistent(dateStr) {
  if (!dateStr) return null;
  const cleaned = String(dateStr).trim();

  // MM/DD/YY or MM/DD/YYYY
  const mdy = cleaned.match(/^(\d{1,2})\/(\d{1,2})\/(\d{2,4})$/);
  if (mdy) {
    let year = parseInt(mdy[3], 10);
    if (year < 100) year += 2000;
    return new Date(year, mdy[1] - 1, mdy[2]);
  }

  // MM-DD-YY or MM-DD-YYYY
  const mdyDash = cleaned.match(/^(\d{1,2})-(\d{1,2})-(\d{2,4})$/);
  if (mdyDash) {
    let year = parseInt(mdyDash[3], 10);
    if (year < 100) year += 2000;
    return new Date(year, mdyDash[1] - 1, mdyDash[2]);
  }

  // YYYY-MM-DD
  const ymd = cleaned.match(/^(\d{4})-(\d{1,2})-(\d{1,2})$/);
  if (ymd) {
    return new Date(parseInt(ymd[1], 10), ymd[2] - 1, ymd[3]);
  }

  // MM.DD.YYYY
  const mdyDot = cleaned.match(/^(\d{1,2})\.(\d{1,2})\.(\d{4})$/);
  if (mdyDot) {
    return new Date(parseInt(mdyDot[3], 10), mdyDot[1] - 1, mdyDot[2]);
  }

  // Excel serial number
  const serialNumber = parseFloat(cleaned);
  if (!isNaN(serialNumber) && serialNumber > 25569 && serialNumber < 100000) {
    return new Date((serialNumber - 25569) * 86400 * 1000);
  }

  // Fallback to Date constructor
  let date = new Date(cleaned);
  if (!isNaN(date.getTime())) {
    return date;
  }

  return null;
}

    function formatTimestamp(timestamp) {
      if (!timestamp) return 'Never';
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
      
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    function updateUploadTimestamps() {
      const container = document.getElementById('uploadTimestampsDisplay');
      if (!container) return;
      
      let html = '<h4 style="font-size: 15px; margin-bottom: 15px; color: #495057; font-weight: 600;">üìÖ Last Upload Times</h4>';
      html += '<div style="display: flex; flex-direction: column; gap: 8px; font-size: 13px;">';
      
      const files = [
        { name: 'Appointments', key: 'appointments', icon: 'üìÖ' },
        { name: 'Memberships', key: 'memberships', icon: 'üë•' },
        { name: 'Sales', key: 'sales', icon: 'üí∞' },
        { name: 'OOT', key: 'oot', icon: 'üìç' },
        { name: 'Payroll', key: 'payroll', icon: '‚è∞' },
        { name: 'Bonus', key: 'bonusStructure', icon: 'üíµ' }
      ];
      
      files.forEach(file => {
        const timestamp = uploadTimestamps[file.key];
        const statusColor = timestamp ? '#16a34a' : '#dc2626';
        const statusIcon = timestamp ? '‚úì' : '‚úó';
        
        html += `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 4px;">
            <span>${file.icon} ${file.name}:</span>
            <span style="color: ${statusColor}; font-weight: 500; font-size: 12px;">
              ${statusIcon} ${formatTimestamp(timestamp)}
            </span>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    // Initialize default staff
    function initializeDefaultStaff() {
      window.APPROVED_STAFF.forEach(staffName => {
        const normalized = normalizeName(staffName);
        staffData[normalized] = { ...DEFAULT_STAFF_STRUCTURE };
      });
    }

    // Calculation functions
    function getConversionGoal(tenureMonths) {
      if (tenureMonths >= 3) return 10.0;
      if (tenureMonths >= 2) return 7.0;
      return 5.0;
    }

    function calculateFairEnhancementGoal(hoursWorked, tenureMonths) {
      const enhancementsPerHour = 0.35;
      const calculatedGoal = Math.round(hoursWorked * enhancementsPerHour);
      
      if (tenureMonths >= 3) {
        return Math.max(calculatedGoal, 5);
      } else {
        return Math.max(calculatedGoal, 3);
      }
    }

    function calculatePerformanceScore(data) {
      if (!data.hours || data.hours === 0) {
        return 0;
      }
      
      const convGoal = getConversionGoal(data.tenureMonths);
      const actualConv = data.eligibleGuests > 0 ? 
        (data.member / data.eligibleGuests * 100) : 0;
      
      const convScore = Math.min((actualConv / convGoal) * 40, 40);
      const enhancePerHour = data.enhance / data.hours;
      const enhanceScore = Math.min(enhancePerHour * 60, 30);
      const rebookScore = Math.min((data.rebook / 20) * 20, 20);
      const productivityScore = Math.min(((data.member + data.enhance) / data.hours) * 10, 10);
      
      return Math.round(convScore + enhanceScore + rebookScore + productivityScore);
    }

    function calculateBonus(staffData) {
      if (!staffData || staffData.enhance === undefined || staffData.member === undefined) {
        return {
          enhanceBonus: 0,
          membershipBonus: 0,
          performanceBonus: 0,
          total: 0,
          status: 'error',
          message: 'Missing required data'
        };
      }
      
      const enhanceGoal = staffData.enhanceGoal || calculateFairEnhancementGoal(staffData.hours || 0, staffData.tenureMonths || 6);
      const enhancePercent = enhanceGoal > 0 ? (staffData.enhance / enhanceGoal * 100) : 0;
      
      let enhanceRate;
      if (enhancePercent >= 90) {
        enhanceRate = BONUS_RATES.enhancement.tier3;
      } else if (enhancePercent >= 80) {
        enhanceRate = BONUS_RATES.enhancement.tier2;
      } else {
        enhanceRate = BONUS_RATES.enhancement.tier1;
      }
      
      const enhanceBonus = staffData.enhance * enhanceRate;
      
      let membershipBonus = 0;
      const memberships = staffData.member || 0;
      
      if (memberships >= 15) {
        membershipBonus = memberships * BONUS_RATES.membership.tier3;
      } else if (memberships >= 10) {
        membershipBonus = memberships * BONUS_RATES.membership.tier2;
      } else if (memberships >= 1) {
        membershipBonus = memberships * BONUS_RATES.membership.tier1;
      }
      
      let performanceBonus = 0;
      if (staffData.hours && staffData.eligibleGuests !== undefined) {
        const performanceScore = calculatePerformanceScore(staffData);
        if (performanceScore >= PERFORMANCE_THRESHOLDS.good) {
          performanceBonus = BONUS_RATES.performanceBonus;
        }
      }
      
      return {
        enhanceBonus: parseFloat(enhanceBonus.toFixed(2)),
        membershipBonus: parseFloat(membershipBonus.toFixed(2)),
        performanceBonus: parseFloat(performanceBonus.toFixed(2)),
        total: parseFloat((enhanceBonus + membershipBonus + performanceBonus).toFixed(2)),
        status: 'calculated',
        enhanceRate,
        enhancePercent: enhancePercent.toFixed(1),
        membershipTier: memberships >= 15 ? 3 : memberships >= 10 ? 2 : 1
      };
    }

 // Replace the periodOptions array around line 1097 with this corrected version:
const periodOptions = [
  { value: "current", label: "Sep 21 - Oct 4, 2025 (Current)", disabled: false },
  { value: "sep7", label: "Sep 7- Sep 20, 2025", disabled: false },
  { value: "aug24", label: "Aug 24 - Sep 6, 2025", disabled: false },
  { value: "aug10", label: "Aug 10-23, 2025", disabled: false },
  { value: "jul27", label: "Jul 27 - Aug 9, 2025", disabled: false },
  { value: "jul13", label: "Jul 13-26, 2025", disabled: false },
  { value: "jun29", label: "Jun 29 - Jul 12, 2025", disabled: false },
  { value: "jun15", label: "Jun 15-28, 2025", disabled: false },
  { value: "jun1", label: "Jun 1-14, 2025", disabled: false },
  { value: "may18", label: "May 18-31, 2025", disabled: false },
  { value: "may4", label: "May 4-17, 2025", disabled: false },
  { value: "apr20", label: "Apr 20 - May 3, 2025", disabled: false },
  { value: "apr6", label: "Apr 6-19, 2025", disabled: false },
  { value: "mar23", label: "Mar 23 - Apr 5, 2025", disabled: false },
  { value: "mar9", label: "Mar 9-22, 2025", disabled: false },
  { value: "feb23", label: "Feb 23 - Mar 8, 2025", disabled: false },
  { value: "feb9", label: "Feb 9-22, 2025", disabled: false },
  { value: "jan26", label: "Jan 26 - Feb 8, 2025", disabled: false },
  { value: "jan12", label: "Jan 12-25, 2025", disabled: false },
  { value: "jan1", label: "Jan 1-11, 2025", disabled: false },
  
  // Future periods
  { value: "oct5", label: "Oct 5-18, 2025", disabled: false },
  { value: "oct19", label: "Oct 19 - Nov 1, 2025", disabled: false },
  { value: "nov2", label: "Nov 2-15, 2025", disabled: false },
  { value: "nov16", label: "Nov 16-29, 2025", disabled: false },
  { value: "nov30", label: "Nov 30 - Dec 13, 2025", disabled: false },
  { value: "dec14", label: "Dec 14-27, 2025", disabled: false },
  { value: "dec28", label: "Dec 28 - Jan 10, 2026", disabled: false }
];

    function createStaffDropdown() {
      const select = document.createElement('select');
      select.id = "staffPeriodSelector";
      select.style.padding = "8px";
      select.style.borderRadius = "5px";
      select.style.border = "1px solid #ddd";
      select.onchange = changeStaffPeriod;

      periodOptions.forEach(period => {
        const option = document.createElement('option');
        option.value = period.value;
        option.textContent = period.label;
        if (period.disabled) option.disabled = true;
        select.appendChild(option);
      });

      const container = document.getElementById('staffPeriodDropdown');
      if (container) {
        container.appendChild(select);
      }
    }

    function createAdminDropdown() {
      const select = document.createElement('select');
      select.id = "periodSelector";
      select.style.padding = "8px";
      select.style.borderRadius = "5px";
      select.style.border = "1px solid #ddd";
      select.onchange = changePeriod;

      periodOptions.forEach(period => {
        const option = document.createElement('option');
        option.value = period.value;
        option.textContent = period.label;
        if (period.disabled) option.disabled = true;
        select.appendChild(option);
      });

      const container = document.getElementById('adminPeriodDropdown');
      if (container) {
        container.appendChild(select);
      }
    }

    // Login functions
    function loginStaff() {
      const name = document.getElementById('staffSelect').value;
      const password = document.getElementById('staffPassword').value;
      
      if (!name) {
        showNotification('Please select your name', 'error');
        return;
      }
      
      const emailName = name.toLowerCase().replace(' ', '.');
      const email = `${emailName}@salesdashboard.com`;
      
      auth.signInWithEmailAndPassword(email, password)
        .then((userCredential) => {
          currentUser = name;
          showStaffDashboard();
          showNotification(`Welcome, ${name}!`, 'success');
        })
        .catch((error) => {
          console.error('Staff login error:', error.code);
          
          if (error.code === 'auth/wrong-password') {
            showNotification('Incorrect password', 'error');
          } else if (error.code === 'auth/user-not-found') {
            showNotification('User not found - contact admin', 'error');
          } else if (error.code === 'auth/too-many-requests') {
            showNotification('Too many failed attempts. Try again later.', 'error');
          } else {
            showNotification('Login failed: ' + error.message, 'error');
          }
        });
    }

    function loginAdmin() {
      const password = document.getElementById('adminPassword').value;
      
      if (!password) {
        showNotification('Please enter password', 'error');
        return;
      }
      
      auth.signInWithEmailAndPassword('admin@salesdashboard.com', password)
        .then((userCredential) => {
          currentUser = 'admin';
          loadStaffRegistry();
          loadAllDataFromFirebase();
          showAdminDashboard();
          showNotification('Admin access granted', 'success');
        })
        .catch((error) => {
          console.error('Login error:', error.code, error.message);
          
          if (error.code === 'auth/wrong-password') {
            showNotification('Incorrect admin password', 'error');
          } else if (error.code === 'auth/user-not-found') {
            showNotification('Admin user not found - check Firebase setup', 'error');
          } else if (error.code === 'auth/invalid-email') {
            showNotification('Invalid email format', 'error');
          } else if (error.code === 'auth/too-many-requests') {
            showNotification('Too many failed attempts. Try again later.', 'error');
          } else {
            showNotification('Login failed: ' + error.message, 'error');
          }
        });
    }

    function logout() {
      currentUser = null;
      currentPeriod = 'current';
      document.getElementById('loginSection').classList.remove('hidden');
      document.getElementById('staffView').classList.add('hidden');
      document.getElementById('adminView').classList.add('hidden');
      
      document.getElementById('staffSelect').value = '';
      document.getElementById('staffPassword').value = '';
      document.getElementById('adminPassword').value = '';
      
      uploadedData = {
        appointments: null,
        memberships: null,
        sales: null,
        oot: null,
        payroll: null,
        bonusStructure: null,
        staffList: null
      };
      
      showNotification('Logged out successfully', 'success');
    }

    // Dashboard display functions
    function showStaffDashboard() {
      document.getElementById('loginSection').classList.add('hidden');
      document.getElementById('staffView').classList.remove('hidden');
      document.getElementById('adminView').classList.add('hidden');
      
      const normalizedName = normalizeName(currentUser);
      const data = staffData[normalizedName] || { ...DEFAULT_STAFF_STRUCTURE };
      
   document.getElementById('staffName').textContent = currentUser;
document.getElementById('staffTitle').textContent = `Performance Dashboard - ${currentUser}`;
const hoursDisplay = data.isEstimated ? 
  `~${data.hours} hrs (est)` : 
  `${data.hours} hrs`;
document.getElementById('hoursWorked').textContent = hoursDisplay;

// Add a note if data is estimated
if (data.isEstimated) {
  const welcomeSection = document.querySelector('.welcome-section');
  if (welcomeSection && !document.getElementById('estimatedDataNote')) {
    const note = document.createElement('div');
    note.id = 'estimatedDataNote';
    note.style.cssText = 'background: #fff3cd; color: #856404; padding: 10px; border-radius: 5px; margin-top: 10px; font-size: 14px;';
    note.innerHTML = '‚ö†Ô∏è Note: Hours are estimated pending payroll data. Sales metrics are current.';
    welcomeSection.appendChild(note);
  }
}
      
      const convGoal = getConversionGoal(data.tenureMonths);
      const actualConv = data.eligibleGuests > 0 ? 
        (data.member / data.eligibleGuests * 100) : 0;
      const adjustedEnhanceGoal = calculateFairEnhancementGoal(data.hours, data.tenureMonths);
      
      document.getElementById('enhanceValue').textContent = data.enhance;
      document.getElementById('enhanceAdjusted').textContent = adjustedEnhanceGoal;
      
      const enhancePercent = Math.round((data.enhance / adjustedEnhanceGoal) * 100);
      const enhanceStatus = document.getElementById('enhanceStatus');
      const enhanceMessage = document.getElementById('enhanceMessage');
      
      if (enhancePercent >= 100) {
        enhanceStatus.textContent = '100% - Goal Achieved!';
        enhanceStatus.className = 'status-badge status-green';
        enhanceMessage.textContent = 'Excellent work!';
      } else if (enhancePercent >= 75) {
        enhanceStatus.textContent = `${enhancePercent}% - Almost There!`;
        enhanceStatus.className = 'status-badge status-green';
        enhanceMessage.textContent = `Keep pushing!`;
      } else {
        enhanceStatus.textContent = `${enhancePercent}% of adjusted goal`;
        enhanceStatus.className = 'status-badge status-yellow';
        enhanceMessage.textContent = `Focus on enhancements`;
      }
      
      document.getElementById('memberValue').textContent = data.member;
      document.getElementById('convGoal').textContent = `${convGoal}%`;
      document.getElementById('convActual').textContent = `${actualConv.toFixed(1)}%`;
      document.getElementById('eligibleGuestsCount').textContent = data.eligibleGuests;
      
      const convPercent = Math.round((actualConv / convGoal) * 100);
      const memberStatus = document.getElementById('memberStatus');
      const memberMessage = document.getElementById('memberMessage');
      
      if (convPercent >= 100) {
        memberStatus.textContent = 'Conversion Goal Met!';
        memberStatus.className = 'status-badge status-green';
        memberMessage.textContent = `Exceeding ${convGoal}% target!`;
      } else if (convPercent >= 75) {
        memberStatus.textContent = `${convPercent}% of Goal`;
        memberStatus.className = 'status-badge status-yellow';
        memberMessage.textContent = `Close to ${convGoal}% target`;
      } else {
        memberStatus.textContent = `${convPercent}% of Goal`;
        memberStatus.className = 'status-badge status-red';
        memberMessage.textContent = `Target: ${convGoal}% conversion`;
      }
      
      document.getElementById('rebookValue').textContent = `${data.rebook}%`;
      document.getElementById('totalGuestsServed').textContent = data.totalGuests;
      const rebookStatus = document.getElementById('rebookStatus');
      const rebookMessage = document.getElementById('rebookMessage');
      
      if (data.rebook >= 20) {
        rebookStatus.textContent = 'Target Met!';
        rebookStatus.className = 'status-badge status-green';
        rebookMessage.textContent = 'Great client relationships!';
      } else {
        rebookStatus.textContent = 'Below Target';
        rebookStatus.className = 'status-badge status-yellow';
        rebookMessage.textContent = 'Focus on follow-ups';
      }
      
      const performanceScore = calculatePerformanceScore(data);
      document.getElementById('overallValue').textContent = `${performanceScore}%`;
      const overallStatus = document.getElementById('overallStatus');
      const overallMessage = document.getElementById('overallMessage');
      
      const trend = performanceScore - data.prevPerformance;
      const trendElement = document.getElementById('performanceTrend');
      if (trend > 0) {
        trendElement.innerHTML = `<span class="trend-up">‚Üë ${trend}%</span>`;
      } else if (trend < 0) {
        trendElement.innerHTML = `<span class="trend-down">‚Üì ${Math.abs(trend)}%</span>`;
      } else {
        trendElement.innerHTML = `<span class="trend-neutral">‚Üí 0%</span>`;
      }
      
      if (performanceScore >= 80) {
        overallStatus.textContent = 'Excellent!';
        overallStatus.className = 'status-badge status-green';
        overallMessage.textContent = 'Top performer!';
      } else if (performanceScore >= 60) {
        overallStatus.textContent = 'Good Work!';
        overallStatus.className = 'status-badge status-green';
        overallMessage.textContent = 'Above average';
      } else {
        overallStatus.textContent = 'Room to Grow';
        overallStatus.className = 'status-badge status-yellow';
        overallMessage.textContent = 'Keep improving';
      }
      
      updateComparisonTable(data);
      
      const bonusCalc = calculateBonus(data);
      document.getElementById('totalBonus').textContent = `${bonusCalc.total.toFixed(2)}`;
      document.getElementById('enhanceBonus').textContent = `${bonusCalc.enhanceBonus.toFixed(2)}`;
      document.getElementById('membershipBonus').textContent = `${bonusCalc.membershipBonus.toFixed(2)}`;
      document.getElementById('performanceBonus').textContent = `${bonusCalc.performanceBonus.toFixed(2)}`;
      
      generatePerformanceTips(data, actualConv, convGoal);
      document.getElementById('quickActionsPanel').style.display = 'block';
    }

    function showAdminDashboard() {
      document.getElementById('loginSection').classList.add('hidden');
      document.getElementById('staffView').classList.add('hidden');
      document.getElementById('adminView').classList.remove('hidden');
      
      const staffArray = Object.values(staffData);
      const totalHours = staffArray.reduce((sum, s) => sum + s.hours, 0);
      
      const avgConv = staffArray.reduce((sum, s) => {
        return sum + (s.eligibleGuests > 0 ? (s.member / s.eligibleGuests * 100) : 0);
      }, 0) / staffArray.length;
      
      const avgRebook = Math.round(staffArray.reduce((sum, s) => sum + s.rebook, 0) / staffArray.length);
      const totalBonus = staffArray.reduce((sum, s) => {
        const bonusCalc = calculateBonus(s);
        return sum + bonusCalc.total;
      }, 0);
      
      document.getElementById('totalHours').textContent = totalHours;
      document.getElementById('avgConvAdmin').textContent = `${avgConv.toFixed(1)}%`;
      document.getElementById('avgRebookAdmin').textContent = `${avgRebook}%`;
      document.getElementById('totalTeamBonus').textContent = `${totalBonus.toFixed(2)}`;
      
      const performers = Object.entries(staffData)
        .map(([name, data]) => ({ name, score: calculatePerformanceScore(data) }))
        .sort((a, b) => b.score - a.score)
        .slice(0, 3);
      
      document.getElementById('topPerformers').innerHTML = performers
        .map((p, i) => `<li>${p.name} (${p.score}%)</li>`)
        .join('');
      
      let tableHTML = '';
      Object.entries(staffData).forEach(([name, data]) => {
        const performance = calculatePerformanceScore(data);
        const actualConv = data.eligibleGuests > 0 ? 
          (data.member / data.eligibleGuests * 100) : 0;
        const convGoal = getConversionGoal(data.tenureMonths);
        const adjustedEnhanceGoal = calculateFairEnhancementGoal(data.hours, data.tenureMonths);
        
        const bonusCalc = calculateBonus(data);
        
        tableHTML += `
        <tr>
          <td>${name}</td>
          <td>${data.hours}</td>
          <td>${data.member}</td>
          <td style="font-weight: bold; color: ${actualConv >= convGoal ? '#28a745' : '#dc3545'}">
            ${actualConv.toFixed(1)}%
          </td>
          <td>${convGoal}%</td>
          <td style="color: ${data.enhance >= adjustedEnhanceGoal ? '#28a745' : '#dc3545'}">
            ${data.enhance}
          </td>
          <td>${adjustedEnhanceGoal}</td>
          <td>20%</td>
          <td style="color: ${data.rebook >= 20 ? '#28a745' : '#dc3545'}">${data.rebook}%</td>
          <td>${bonusCalc.total.toFixed(2)}</td>
          <td>
            <div class="performance-bar">
              <div class="performance-fill" style="width: ${performance}%"></div>
            </div>
            ${performance}%
          </td>
        </tr>`;
      });
      
      document.getElementById('teamTableBody').innerHTML = tableHTML;
      document.getElementById('quickActionsPanel').style.display = 'block';
      updateUploadTimestamps();
    }

    function updateComparisonTable(userData) {
      const allStaff = Object.values(staffData);
      
      const avgConv = allStaff.reduce((sum, s) => {
        return sum + (s.eligibleGuests > 0 ? (s.member / s.eligibleGuests * 100) : 0);
      }, 0) / allStaff.length;
      
      const avgMemPerHour = allStaff.reduce((sum, s) => sum + (s.member / s.hours), 0) / allStaff.length;
      const avgEnhPerHour = allStaff.reduce((sum, s) => sum + (s.enhance / s.hours), 0) / allStaff.length;
      const avgRebook = allStaff.reduce((sum, s) => sum + s.rebook, 0) / allStaff.length;
      
      const topConv = Math.max(...allStaff.map(s => s.eligibleGuests > 0 ? (s.member / s.eligibleGuests * 100) : 0));
      const topMemPerHour = Math.max(...allStaff.map(s => s.member / s.hours));
      const topEnhPerHour = Math.max(...allStaff.map(s => s.enhance / s.hours));
      const topRebook = Math.max(...allStaff.map(s => s.rebook));
      
      const yourConv = userData.eligibleGuests > 0 ? (userData.member / userData.eligibleGuests * 100) : 0;
      document.getElementById('yourConv').textContent = `${yourConv.toFixed(1)}%`;
      document.getElementById('avgConv').textContent = `${avgConv.toFixed(1)}%`;
      document.getElementById('topConv').textContent = `${topConv.toFixed(1)}%`;
      
      document.getElementById('yourMemPerHour').textContent = (userData.member / userData.hours).toFixed(3);
      document.getElementById('avgMemPerHour').textContent = avgMemPerHour.toFixed(3);
      document.getElementById('topMemPerHour').textContent = topMemPerHour.toFixed(3);
      
      document.getElementById('yourEnhPerHour').textContent = (userData.enhance / userData.hours).toFixed(3);
      document.getElementById('avgEnhPerHour').textContent = avgEnhPerHour.toFixed(3);
      document.getElementById('topEnhPerHour').textContent = topEnhPerHour.toFixed(3);
      
      document.getElementById('yourRebook').textContent = `${userData.rebook}%`;
      document.getElementById('avgRebook').textContent = `${Math.round(avgRebook)}%`;
      document.getElementById('topRebook').textContent = `${topRebook}%`;
    }

    function generatePerformanceTips(data, actualConv, convGoal) {
      const tips = [];
      
      if (actualConv < convGoal) {
        tips.push(`Focus on conversion: Your target is ${convGoal}%, currently at ${actualConv.toFixed(1)}%`);
        tips.push('Identify eligible guests early and tailor your approach');
      }
      
      if (data.rebook < 20) {
        tips.push('Build stronger connections - ask about future visit plans');
        tips.push('Follow up with guests after their experience');
      }
      
      if (data.enhance / data.hours < 0.2) {
        tips.push('Aim for at least one enhancement every 5 hours worked');
        tips.push('Identify enhancement opportunities during initial consultations');
      }
      
      if (data.hours < 60) {
        tips.push('Consider picking up additional shifts to increase opportunities');
      }
      
      if (tips.length === 0) {
        tips.push('You\'re performing well! Keep maintaining your high standards');
        tips.push('Consider mentoring newer team members');
      }
      
      document.getElementById('performanceTips').innerHTML = tips.map(tip => `<li>${tip}</li>`).join('');
    }

    function changeStaffPeriod() {
      const selector = document.getElementById('staffPeriodSelector');
      const selectedPeriod = selector.value;
      currentPeriod = selectedPeriod;
      
      const periodText = selector.options[selector.selectedIndex].text;
      document.getElementById('staffPeriodDisplay').textContent = periodText;
      document.getElementById('bonusPeriodDisplay').textContent = periodText;
      
      if (periodData[selectedPeriod] && periodData[selectedPeriod][currentUser]) {
        staffData[currentUser] = { ...periodData[selectedPeriod][currentUser] };
        showStaffDashboard();
        showNotification(`Viewing: ${periodText}`, 'success');
      } else {
        showNotification('No data available for this period', 'error');
      }
    }

    function changePeriod() {
      const selector = document.getElementById('periodSelector');
      const selectedPeriod = selector.value;
      currentPeriod = selectedPeriod;
      
      if (periodData[selectedPeriod]) {
        Object.keys(periodData[selectedPeriod]).forEach(name => {
          staffData[name] = { ...periodData[selectedPeriod][name] };
        });
        
        showAdminDashboard();
        
        const periodText = selector.options[selector.selectedIndex].text;
        showNotification(`Viewing: ${periodText}`, 'success');
      } else {
        showNotification('No data available for this period', 'error');
      }
    }

    // Staff management functions
    window.staffRegistry = window.staffRegistry || {};

    function openSimpleStaffManager() {
      document.getElementById('simpleStaffManager').style.display = 'block';
      populateRemoveDropdown();
    }

    function closeSimpleStaffManager() {
      document.getElementById('simpleStaffManager').style.display = 'none';
    }

    function populateRemoveDropdown() {
      const select = document.getElementById('quickRemoveSelect');
      if (!select) return;
      
      select.innerHTML = '<option value="">Select staff to remove...</option>';
      
      Object.keys(staffData).forEach(name => {
        select.innerHTML += `<option value="${name}">${name}</option>`;
      });
    }

    function addStaffMember() {
      const name = document.getElementById('quickStaffName').value.trim();
      const normalizedName = normalizeName(name);
      const email = document.getElementById('quickStaffEmail').value.trim();
      const tenure = parseInt(document.getElementById('quickStaffTenure').value) || 0;
      
      if (!name) {
        showNotification('Please enter a name', 'error');
        return;
      }
      
      if (!email || !email.includes('@')) {
        showNotification('Please enter a valid email', 'error');
        return;
      }
      
      if (staffData[normalizedName]) {
        showNotification('Staff member already exists', 'error');
        return;
      }
      
      staffData[normalizedName] = {
        enhance: 0,
        enhanceGoal: tenure >= 3 ? 10 : 5,
        member: 0,
        memberGoal: tenure >= 3 ? 3 : 2,
        rebook: 0,
        hours: 0,
        eligibleGuests: 0,
        totalGuests: 0,
        prevPerformance: 0,
        tenureMonths: tenure,
        bonus: 0
      };
      
      if (!window.dynamicStaffEmails) {
        window.dynamicStaffEmails = {};
      }
      window.dynamicStaffEmails[normalizedName] = email;
      
      if (typeof database !== 'undefined' && currentUser === 'admin') {
        const staffRef = database.ref(`dashboard/staffRegistry/${normalizedName}`);
        staffRef.set({
          email: email,
          tenureMonths: tenure,
          addedDate: new Date().toISOString(),
          addedBy: currentUser,
          active: true
        }).then(() => {
          console.log('Staff added to Firebase registry');
        }).catch(error => {
          console.error('Error saving to Firebase:', error);
        });
      }

      const loginSelect = document.getElementById('staffSelect');
      if (loginSelect) {
        let exists = false;
        for (let option of loginSelect.options) {
          if (option.value === normalizedName) {
            exists = true;
            break;
          }
        }
        if (!exists) {
          const newOption = document.createElement('option');
          newOption.value = normalizedName;
          newOption.textContent = name;
          loginSelect.appendChild(newOption);
        }
      }
      
      document.getElementById('quickStaffName').value = '';
      document.getElementById('quickStaffEmail').value = '';
      document.getElementById('quickStaffTenure').value = '0';
      
      populateRemoveDropdown();
      showNotification(`${name} added successfully`, 'success');

      if (currentUser === 'admin') {
        showAdminDashboard();
      }
    }

    function removeStaffMember() {
      const select = document.getElementById('quickRemoveSelect');
      const name = select.value;
      const normalizedName = normalizeName(name);

      if (!normalizedName) {
        showNotification('Please select a staff member to remove', 'error');
        return;
      }

      if (!confirm(`Are you sure you want to remove ${name}?`)) {
        return;
      }

      if (staffData.hasOwnProperty(normalizedName)) {
        delete staffData[normalizedName];
      } else {
        showNotification('Staff member not found.', 'error');
        return;
      }

      for (let i = 0; i < select.options.length; i++) {
        if (normalizeName(select.options[i].value) === normalizedName) {
          select.remove(i);
          break;
        }
      }

      if (typeof database !== 'undefined' && currentUser === 'admin') {
        const staffRef = database.ref(`dashboard/staffRegistry/${normalizedName}`);
        staffRef.update({
          active: false,
          deactivatedDate: new Date().toISOString(),
          deactivatedBy: currentUser
        }).then(() => {
          console.log('Staff marked as inactive in Firebase');
          showNotification('Staff member removed successfully.', 'success');
        }).catch(error => {
          console.error('Error updating Firebase:', error);
        });
      } else {
        showNotification('Staff member removed successfully.', 'success');
      }

      if (window.dynamicStaffEmails) {
        delete window.dynamicStaffEmails[normalizedName];
      }

      const loginSelect = document.getElementById('staffSelect');
      if (loginSelect) {
        for (let i = 0; i < loginSelect.options.length; i++) {
          if (loginSelect.options[i].value === normalizedName) {
            loginSelect.remove(i);
            break;
          }
        }
      }

      document.getElementById('quickRemoveSelect').value = '';
      populateRemoveDropdown();

      if (currentUser === 'admin') {
        showAdminDashboard();
      }
    }

    function loadStaffRegistry() {
      if (typeof database === 'undefined') return;
      
      database.ref('dashboard/staffRegistry').once('value')
        .then(snapshot => {
          const registry = snapshot.val();
          if (registry) {
            window.staffRegistry = registry;
            
            Object.entries(registry).forEach(([name, data]) => {
              if (data.active !== false && !staffData[name]) {
                staffData[name] = {
                  enhance: 0,
                  enhanceGoal: 5,
                  member: 0,
                  memberGoal: 2,
                  rebook: 0,
                  hours: 0,
                  eligibleGuests: 0,
                  totalGuests: 0,
                  prevPerformance: 0,
                  tenureMonths: data.tenureMonths || 0,
                  bonus: 0
                };
                
                if (data.email) {
                  if (!window.dynamicStaffEmails) {
                    window.dynamicStaffEmails = {};
                  }
                  window.dynamicStaffEmails[name] = data.email;
                }
              }
            });
            
            console.log('Staff registry loaded from Firebase');
          }
        })
        .catch(error => {
          console.error('Error loading staff registry:', error);
        });
    }

    // CSV Upload handlers (continued in next update)
    function handleAppointmentUpload(event) {
      const file = event.target.files[0];
      if (!file) {
        showNotification('No file selected.', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const fileContent = e.target.result;
        let parsedData;
        try {
          parsedData = parseCSV(fileContent);
          if (!parsedData || !Array.isArray(parsedData) || parsedData.length === 0) {
            showNotification('File is empty or could not be parsed.', 'error');
            return;
          }
        } catch (err) {
          showNotification('Error parsing file: ' + (err.message || err), 'error');
          return;
        }

        uploadedData.appointments = fileContent;
        uploadTimestamps.appointments = new Date().toISOString();
        saveDataToFirebase('appointments', fileContent);
        updateUploadTimestamps();
        showNotification('Appointment data loaded', 'success');
      };

      reader.onerror = function() {
        showNotification('Error reading file.', 'error');
      };

      reader.readAsText(file);
    }

    function handleMembershipUpload(event) {
      const file = event.target.files[0];
      if (!file) {
        showNotification('No file selected.', 'error');
        return;
      }

      const reader = new FileReader();
      reader.onload = function(e) {
        const fileContent = e.target.result;
        let parsedData;
        try {
          parsedData = parseCSV(fileContent);
          if (!parsedData || !Array.isArray(parsedData) || parsedData.length === 0) {
            showNotification('File is empty or could not be parsed.', 'error');
            return;
          }
        } catch (err) {
          showNotification('Error parsing file: ' + (err.message || err), 'error');
          return;
        }

        uploadedData.memberships = fileContent;
        uploadTimestamps.memberships = new Date().toISOString();
        saveDataToFirebase('memberships', fileContent);
        updateUploadTimestamps();
        showNotification('Membership data loaded', 'success');
      };

      reader.onerror = function() {
        showNotification('Error reading file.', 'error');
      };

      reader.readAsText(file);
    }

    function handleSalesUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        uploadedData.sales = e.target.result;
        uploadTimestamps.sales = new Date().toISOString();
        saveDataToFirebase('sales', e.target.result);
        updateUploadTimestamps();
        showNotification('Sales data loaded', 'success');
      };
      reader.readAsText(file);
    }

    function handleOOTUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        uploadedData.oot = e.target.result;
        uploadTimestamps.oot = new Date().toISOString();
        saveDataToFirebase('oot', e.target.result);
        updateUploadTimestamps();
        showNotification('OOT data loaded', 'success');
      };
      reader.readAsText(file);
    }

    function handlePayrollUpload(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function(e) {
        uploadedData.payroll = e.target.result;
        uploadTimestamps.payroll = new Date().toISOString();
        saveDataToFirebase('payroll', e.target.result);
        updateUploadTimestamps();
        payrollData = parseCSV(e.target.result);
        extractPayPeriods();
        showNotification('Payroll hours data loaded', 'success');
      };
      reader.readAsText(file);
    }

    function handleBonusUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        uploadedData.bonusStructure = e.target.result;
        localStorage.setItem('bonusStructure', e.target.result);
        
        try {
          const bonusData = parseCSV(e.target.result);
          updateBonusRates(bonusData);
          
          const btn = document.getElementById('bonusUploadBtn');
          if (btn) {
            btn.style.background = '#e8f5e9';
            btn.style.borderColor = '#4caf50';
            btn.innerHTML = 
              '<span style="font-size: 16px;">üíµ</span>' +
              '<span>Bonus Structure ‚úì</span>' +
              '<span style="margin-left: auto; color: #4caf50; font-size: 12px;">LOADED</span>';
          }
          showNotification('Bonus structure loaded and saved', 'success');
        } catch (error) {
          showNotification('Error loading bonus structure: ' + error.message, 'error');
        }
      };
      reader.readAsText(file);
    }

    function handleStaffListUpload(event) {
      const file = event.target.files[0];
      if (!file) return;
      
      const reader = new FileReader();
      reader.onload = function(e) {
        const csvData = e.target.result;
        const parsed = parseCSV(csvData);
        
        uploadedData.staffList = csvData;
        uploadTimestamps.staffList = new Date().toISOString();
        
        if (currentUser === 'admin') {
          saveDataToFirebase('staffList', csvData);
        }
        
        updateUploadTimestamps();
        updateStaffDropdown(parsed);
        localStorage.setItem('staffList', JSON.stringify(parsed));
        
        showNotification('Staff list updated successfully', 'success');
      };
      reader.readAsText(file);
    }

    function updateStaffDropdown(staffList) {
      const dropdown = document.getElementById('staffSelect');
      if (!dropdown) return;
      
      dropdown.innerHTML = '<option value="">Select your name...</option>';
      
      window.dynamicStaffEmails = {};
      
      if (!staffList || staffList.length === 0) {
        window.APPROVED_STAFF.forEach(name => {
          const normalized = normalizeName(name);
          dropdown.innerHTML += `<option value="${normalized}">${normalized}</option>`;
        });
        console.log(`Staff dropdown populated with ${window.APPROVED_STAFF.length} default staff members`);
        return;
      }

      let addedCount = 0;
      staffList.forEach(staff => {
        if (
          window.APPROVED_STAFF.map(normalizeName).includes(normalizeName(staff.Name)) &&
          (!staff.Status || staff.Status === 'Active')
        ) {
          const normalized = normalizeName(staff.Name);
          dropdown.innerHTML += `<option value="${normalized}">${normalized}</option>`;
          addedCount++;
        }
      });
      
      console.log(`Staff dropdown updated with ${addedCount} approved staff members`);
    }

    function populateLoginDropdown() {
      const select = document.getElementById('staffSelect');
      if (!select) return;
      
      select.innerHTML = '<option value="">Select your name...</option>';
      
      Object.keys(staffData).sort().forEach(name => {
        const option = document.createElement('option');
        option.value = name;
        option.textContent = staffData[name].originalName || name;
        select.appendChild(option);
      });
      
      console.log('Login dropdown populated with', Object.keys(staffData).length, 'staff members');
    }

    function updateBonusRates(bonusData) {
      BONUS_RATES = {
        enhancement: {},
        membership: {},
        performanceBonus: 0
      };
      
      bonusData.forEach(row => {
        const bonusType = (row['Bonus Type'] || '').toLowerCase().trim();
        const tier = parseInt(row['Tier'] || 0);
        const rate = parseFloat(row['Rate'] || 0);
        
        if (bonusType === 'enhancement' && tier) {
          BONUS_RATES.enhancement[`tier${tier}`] = rate;
        } else if (bonusType === 'membership' && tier) {
          BONUS_RATES.membership[`tier${tier}`] = rate;
        } else if (bonusType === 'performance') {
          BONUS_RATES.performanceBonus = rate;
        }
      });
      
      console.log('Updated bonus rates:', BONUS_RATES);
      
      if (staffData && Object.keys(staffData).length > 0) {
        recalculateAllBonuses();
      }
    }

    function recalculateAllBonuses() {
      if (typeof staffData !== 'undefined' && staffData) {
        Object.keys(staffData).forEach(name => {
          if (typeof calculateBonus === 'function') {
            const bonusCalc = calculateBonus(staffData[name]);
            staffData[name].bonus = bonusCalc.total;
          }
        });
      }
      
      if (typeof periodData !== 'undefined' && periodData) {
        Object.keys(periodData).forEach(period => {
          if (periodData[period]) {
            Object.keys(periodData[period]).forEach(name => {
              if (typeof calculateBonus === 'function') {
                const bonusCalc = calculateBonus(periodData[period][name]);
                periodData[period][name].bonus = bonusCalc.total;
              }
            });
          }
        });
      }
      
      if (typeof currentUser !== 'undefined') {
        if (currentUser === 'admin') {
          if (typeof showAdminDashboard === 'function') {
            showAdminDashboard();
          }
        } else if (currentUser && currentUser !== 'admin') {
          if (typeof showStaffDashboard === 'function') {
            showStaffDashboard();
          }
        }
      }
      
      showNotification('All bonuses recalculated with new rates', 'info');
    }

    function extractPayPeriods() {
      const uniquePeriods = new Set();
      payPeriods = [];
      
      if (!payrollData) return;
      
      payrollData.forEach(row => {
        const key = `${row['Period Start']}_${row['Period End']}`;
        if (!uniquePeriods.has(key) && row['Period Start'] && row['Period End']) {
          uniquePeriods.add(key);
          payPeriods.push({
            start: new Date(row['Period Start']),
            end: new Date(row['Period End']),
            label: `${row['Period Start']} - ${row['Period End']}`,
            startStr: row['Period Start'],
            endStr: row['Period End']
          });
        }
      });
      
      payPeriods.sort((a, b) => b.start - a.start);
    }

// Replace your extractStaffFromData function with this safer version:
function extractStaffFromData() {
  const staffSet = new Set();

  if (uploadedData.sales && typeof uploadedData.sales === 'string') {
    try {
      const salesData = parseCSV(uploadedData.sales);
      salesData.forEach(row => {
        if (row && row['ClosedBy']) {
          const fixedName = normalizeName(row['ClosedBy']);
          if (fixedName) staffSet.add(fixedName);
        }
      });
    } catch (error) {
      console.error('Error processing sales data:', error);
    }
  }

  if (uploadedData.payroll && typeof uploadedData.payroll === 'string') {
    try {
      const payrollData = parseCSV(uploadedData.payroll);
      payrollData.forEach(row => {
        if (row && row['Name']) {
          const fixedName = normalizeName(row['Name']);
          if (fixedName) staffSet.add(fixedName);
        }
      });
    } catch (error) {
      console.error('Error processing payroll data:', error);
    }
  }

  if (uploadedData.memberships && typeof uploadedData.memberships === 'string') {
    try {
      const memberData = parseCSV(uploadedData.memberships);
      memberData.forEach(row => {
        if (row && row['Sold By']) {
          const fixedName = normalizeName(row['Sold By']);
          if (fixedName) staffSet.add(fixedName);
        }
      });
    } catch (error) {
      console.error('Error processing membership data:', error);
    }
  }

  const staffList = Array.from(staffSet).filter(name => name && name.trim());
  
  console.log('Normalized staff from CSVs:', staffList);
  console.log('Normalized approved staff:', window.APPROVED_STAFF.map(normalizeName));

  staffList.forEach(staffName => {
    if (
      window.APPROVED_STAFF.map(normalizeName).includes(normalizeName(staffName)) &&
      !staffData[staffName]
    ) {
      staffData[staffName] = {
        enhance: 0,
        enhanceGoal: 10,
        member: 0,
        memberGoal: 3,
        rebook: 0,
        hours: 0,
        eligibleGuests: 0,
        totalGuests: 0,
        prevPerformance: 0,
        tenureMonths: 6,
        bonus: 0
      };
    }
  });

  console.log('Dynamically found staff:', staffList.length, 'members');
  return staffList;
}
    
    function validateCSVColumns(data, requiredColumns, dataType) {
      if (!data || data.length === 0) {
        showNotification(`No ${dataType} data found`, 'error');
        return false;
      }
      
      const actualColumns = Object.keys(data[0]);
      const missing = requiredColumns.filter(col => !actualColumns.includes(col));
      
      if (missing.length > 0) {
        showNotification(`Missing columns in ${dataType}: ${missing.join(', ')}`, 'error');
        console.error(`${dataType} has columns:`, actualColumns);
        console.error(`Missing required:`, missing);
        return false;
      }
      
      return true;
    }

    function processAllData() {
      if (!uploadedData.appointments && !uploadedData.memberships && !uploadedData.sales && !uploadedData.oot) {
        showNotification('Please upload at least one data file first', 'error');
        return;
      }
      
      const dynamicStaff = extractStaffFromData();
      populateLoginDropdown();
      
      Object.keys(periodData).forEach(period => {
        periodData[period] = {};
      });
      
      parsedAppointments = uploadedData.appointments ? parseCSV(uploadedData.appointments) : null;
      parsedMemberships = uploadedData.memberships ? parseCSV(uploadedData.memberships) : null;
      parsedSales = uploadedData.sales ? parseCSV(uploadedData.sales) : null;
      parsedOOT = uploadedData.oot ? parseCSV(uploadedData.oot) : null;
      
      if (parsedOOT && parsedOOT.length > 0) {
  const typeValues = [...new Set(parsedOOT.map(row => row['Type']))];
  console.log('Unique Type values in OOT file:', typeValues);
}
      
      const validations = [
        {
          data: parsedSales,
          columns: ['Sale Date', 'ClosedBy', 'Invoice No', 'Category', 'Member'],
          type: 'Sales'
        },
        {
          data: parsedMemberships,
          columns: ['Sale Date', 'Sold By'],
          type: 'Memberships'
        },
        {
  data: parsedOOT,
  columns: ['Sales Date', 'Invoice No', 'Type'], // Added Type column
  type: 'OOT'
}
      ];

// Add debug to see what's happening
console.log('Starting data processing...');
console.log('Staff in system:', Object.keys(staffData));
console.log('Sales data rows:', parsedSales ? parsedSales.length : 0);
console.log('Membership data rows:', parsedMemberships ? parsedMemberships.length : 0);
console.log('OOT data rows:', parsedOOT ? parsedOOT.length : 0);
if (parsedSales && parsedSales.length > 0) {
  console.log('Sample sale:', parsedSales[0]);
  console.log('Sample ClosedBy values:', [...new Set(parsedSales.slice(0,20).map(r => r['ClosedBy']))]);
}
      
      validations.forEach(validation => {
        if (validation.data && !validateCSVColumns(validation.data, validation.columns, validation.type)) {
          console.error(`Validation failed for ${validation.type}`);
        }
      });


const periodRanges = {
  jan1: { start: new Date('2025-01-01'), end: new Date('2025-01-11') },
  jan12: { start: new Date('2025-01-12'), end: new Date('2025-01-25') },
  jan26: { start: new Date('2025-01-26'), end: new Date('2025-02-08') },
  feb9: { start: new Date('2025-02-09'), end: new Date('2025-02-22') },
  feb23: { start: new Date('2025-02-23'), end: new Date('2025-03-08') },
  mar9: { start: new Date('2025-03-09'), end: new Date('2025-03-22') },
  mar23: { start: new Date('2025-03-23'), end: new Date('2025-04-05') },
  apr6: { start: new Date('2025-04-06'), end: new Date('2025-04-19') },
  apr20: { start: new Date('2025-04-20'), end: new Date('2025-05-03') },
  may4: { start: new Date('2025-05-04'), end: new Date('2025-05-17') },
  may18: { start: new Date('2025-05-18'), end: new Date('2025-05-31') },
  jun1: { start: new Date('2025-06-01'), end: new Date('2025-06-14') },
  jun15: { start: new Date('2025-06-15'), end: new Date('2025-06-28') },
  jun29: { start: new Date('2025-06-29'), end: new Date('2025-07-12') },
  jul13: { start: new Date('2025-07-13'), end: new Date('2025-07-26') },
  jul27: { start: new Date('2025-07-27'), end: new Date('2025-08-09') },
  aug10: { start: new Date('2025-08-10'), end: new Date('2025-08-23') },
  aug24: { start: new Date('2025-08-24'), end: new Date('2025-09-06') },
  sep7: { start: new Date('2025-09-07'), end: new Date('2025-09-20') },
  current: { start: new Date('2025-09-21'), end: new Date('2025-10-04') },
  oct5: { start: new Date('2025-10-05'), end: new Date('2025-10-18') },
  oct19: { start: new Date('2025-10-19'), end: new Date('2025-11-01') },
  nov2: { start: new Date('2025-11-02'), end: new Date('2025-11-15') },
  nov30: { start: new Date('2025-11-30'), end: new Date('2025-12-13') },
  dec14: { start: new Date('2025-12-14'), end: new Date('2025-12-27') },
  dec28: { start: new Date('2025-12-28'), end: new Date('2026-01-10') }
};
Object.keys(periodRanges).forEach(periodKey => {
  const period = periodRanges[periodKey];
  const periodStaffData = {};

  const periodSales = parsedSales ? 
    parsedSales.filter(row => {
      const rowDate = parseDateConsistent(row['Sale Date']);
      return rowDate >= period.start && rowDate <= period.end;
    }) : [];

const periodOOT = parsedOOT ? 
  parsedOOT.filter(row => {
    const rowDate = parseDateConsistent(row['Sales Date']);
    const type = row['Type'] ? row['Type'].toLowerCase().trim() : '';
    // More flexible matching
    return rowDate >= period.start && rowDate <= period.end && 
           (type.includes('out') || type === 'oot' || type === 'o');
  }) : [];
  
  const periodMemberships = parsedMemberships ? 
    parsedMemberships.filter(row => {
      const rowDate = parseDateConsistent(row['Sale Date']);
      if (!rowDate) return false;
      return rowDate >= period.start && rowDate <= period.end;
    }) : [];

  const periodPayroll = payrollData ?
    payrollData.filter(row => {
      if (!Object.keys(staffData).includes(normalizeName(row['Name']))) {
        return false;
      }
      const rowStart = parseDateConsistent(row['Period Start']);
      const rowEnd = parseDateConsistent(row['Period End']);
      if (!rowStart || !rowEnd) return false;
      return rowStart >= period.start && rowStart <= period.end;
    }) : [];

  const ootInvoices = new Set(periodOOT.map(row => row['Invoice No']));

 Object.keys(staffData).forEach(staffName => {
  const normalizedName = normalizeName(staffName);

  // Calculate staff hours from payroll
  const staffHours = periodPayroll
    .filter(row => row['Name'] && normalizeName(row['Name']) === normalizedName)
    .reduce((sum, row) => {
      const hours = row['Hourly Hours'];
      if (hours === '' || hours === null || hours === undefined) {
        return sum;
      }
      return sum + parseFloat(hours);
    }, 0);

  // Calculate memberships first
  const membershipsSold = periodMemberships
    .filter(row => row['Sold By'] && normalizeName(row['Sold By']) === normalizedName)
    .length;

  // Get staff sales
  const staffSales = periodSales.filter(row => 
    row['ClosedBy'] && normalizeName(row['ClosedBy']) === normalizedName
  );

// Calculate enhancements
const enhancementRows = staffSales.filter(row => {
  const category = (row['Category'] || '').toLowerCase().trim();
  return category === 'enhancement' || 
         category === 'enhancements' || 
         category.includes('enhancement');
});
const enhancements = enhancementRows.length;

// Add this debug code:
if (periodKey === 'sep7' && normalizedName === 'angela mcnally') {
  console.log(`Angela McNally - Sep 7-20 Debug:`);
  console.log(`  Total sales in period: ${staffSales.length}`);
  console.log(`  Categories found:`, [...new Set(staffSales.map(r => r['Category']))]);
  console.log(`  Enhancement rows found: ${enhancementRows.length}`);
  
  // Check if FirstVisit is being used for enhancements
  const firstVisitYes = staffSales.filter(row => 
    row['FirstVisit'] && row['FirstVisit'].toLowerCase() === 'yes'
  ).length;
  console.log(`  FirstVisit=Yes count: ${firstVisitYes}`);
  
  // Show a few sample sales
  console.log(`  Sample sales:`, staffSales.slice(0, 3).map(s => ({
    date: s['Sale Date'],
    category: s['Category'],
    firstVisit: s['FirstVisit']
  })));
}
  // Calculate rebook rate from appointments
  const staffAppointments = parsedAppointments ? 
    parsedAppointments.filter(row => {
      const rowDate = parseDateConsistent(row['Appointment Date']);
      const bookedBy = row['Booked By'] ? normalizeName(row['Booked By']) : '';
      return rowDate && rowDate >= period.start && rowDate <= period.end && bookedBy === normalizedName;
    }) : [];

  const totalAppointments = staffAppointments.length;
  const rebookedYes = staffAppointments.filter(row => 
    row['Rebooked'] && row['Rebooked'].toLowerCase().trim() === 'yes'
  ).length;

  const rebookRate = totalAppointments > 0 ? 
    Math.round((rebookedYes / totalAppointments) * 100) : 0;

  // Add this debug line here:
  if (periodKey === 'current') {
    console.log(`${normalizedName} - Appointments: ${totalAppointments}, Rebooked: ${rebookedYes}, Rate: ${rebookRate}%`);
  }

  // Estimate hours if payroll is missing
  let estimatedHours = staffHours;
  if (staffHours === 0) {
    // Count unique days with activity
    const uniqueDays = new Set();
    staffSales.forEach(sale => {
      const saleDate = parseDateConsistent(sale['Sale Date']);
      if (saleDate) {
        uniqueDays.add(saleDate.toDateString());
      }
    });

    // Estimate 8 hours per active day
    estimatedHours = uniqueDays.size * 8;

    // If still 0, check if there are memberships
    if (estimatedHours === 0 && membershipsSold > 0) {
      estimatedHours = 40; // Default hours for staff with memberships
    }

    // If still 0 but has enhancements, give default hours
    if (estimatedHours === 0 && enhancements > 0) {
      estimatedHours = 40; // Default hours for staff with enhancements
    }

    // Or use previous period average if available
    const prevPeriodData = periodData['sep7'] && periodData['sep7'][normalizedName];
    if (prevPeriodData && prevPeriodData.hours > 0 && estimatedHours === 0) {
      estimatedHours = prevPeriodData.hours; // Use previous period as estimate
    }
  }

  // Calculate unique guests and eligibility
  const uniqueGuestMap = new Map();
  staffSales.forEach(row => {
    const invoiceNo = row['Invoice No'];
    if (!invoiceNo) return;

    const isExistingMember = row['Member'] === 'Yes' || row['Member'] === 'TRUE';
    const isOOT = ootInvoices.has(invoiceNo);

    if (!uniqueGuestMap.has(invoiceNo)) {
      uniqueGuestMap.set(invoiceNo, {
        isEligible: !isExistingMember && !isOOT
      });
    }
  });

  const eligibleGuests = Array.from(uniqueGuestMap.values())
    .filter(guest => guest.isEligible).length;

  const originalData = periodData[periodKey] && periodData[periodKey][normalizedName] ? 
    periodData[periodKey][normalizedName] : staffData[normalizedName];

  periodStaffData[normalizedName] = {
    enhance: enhancements,
    enhanceGoal: calculateFairEnhancementGoal(
      estimatedHours > 0 ? estimatedHours : (originalData.hours || 40),
      originalData.tenureMonths || 6
    ),
    member: membershipsSold,
    memberGoal: originalData.memberGoal || 2,
    rebook: rebookRate,  // Now using calculated rate
    hours: estimatedHours > 0 ? Math.round(estimatedHours) : (originalData.hours || 40),
    eligibleGuests: eligibleGuests,
    totalGuests: staffSales.length,
    prevPerformance: originalData.prevPerformance || 0,
    tenureMonths: originalData.tenureMonths || 6,
    isEstimated: staffHours === 0 && estimatedHours > 0
  };

  const bonusCalc = calculateBonus(periodStaffData[normalizedName]);
  periodStaffData[normalizedName].bonus = bonusCalc.total;
});

  periodData[periodKey] = periodStaffData;
});
      
      if (periodData.current && Object.keys(periodData.current).length > 0) {
        staffData = { ...periodData.current };
        console.log('Updated staffData with current period data');
      }
      
      showAdminDashboard();
      showNotification('All periods processed from CSV data!', 'success');
    }

    // Quick Actions Functions
    function exportToCSV() {
      const rows = [['Name', 'Hours', 'Enhancements', 'Memberships', 'Conversion%', 'Rebook%', 'Bonus']];
      Object.entries(staffData).forEach(([name, data]) => {
        const conv = data.eligibleGuests > 0 ? (data.member / data.eligibleGuests * 100).toFixed(1) : '0';
        const bonusCalc = calculateBonus(data);
        rows.push([name, data.hours, data.enhance, data.member, conv, data.rebook, bonusCalc.total.toFixed(2)]);
      });
      
      const csvContent = rows.map(e => e.join(",")).join("\n");
      const blob = new Blob([csvContent], { type: 'text/csv' });
      const url = window.URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `performance_${currentPeriod}_${new Date().toISOString().split('T')[0]}.csv`;
      a.click();
      window.URL.revokeObjectURL(url);
      showNotification('Data exported successfully', 'success');
    }

    function printDashboard() {
      const quickActions = document.querySelector('.quick-actions');
      if (quickActions) quickActions.style.display = 'none';
      window.print();
      if (quickActions) quickActions.style.display = 'block';
    }

    function refreshData() {
      if (currentUser === 'admin') {
        showAdminDashboard();
      } else if (currentUser) {
        showStaffDashboard();
      }
      showNotification('Dashboard refreshed', 'success');
    }

    function toggleQuickActions() {
      const panel = document.querySelector('.quick-actions');
      if (panel.classList.contains('minimized')) {
        panel.classList.remove('minimized');
      } else {
        panel.classList.add('minimized');
      }
    }

    // Firebase functions
    function saveDataToFirebase(dataType, csvContent) {
      if (currentUser !== 'admin') {
        console.log('Only admin can save data');
        return;
      }
      
      const dataRef = database.ref(`dashboard/csvData/${dataType}`);
      dataRef.set({
        content: csvContent,
        timestamp: new Date().toISOString(),
        updatedBy: currentUser
      }).then(() => {
        console.log(`${dataType} saved to Firebase`);
      }).catch((error) => {
        console.error('Error saving to Firebase:', error);
      });
    }

 // ...existing code...
function loadAllDataFromFirebase() {
  showNotification('Loading data from cloud...', 'info');
  
  const dataTypes = ['appointments', 'memberships', 'sales', 'oot', 'payroll', 'bonusStructure', 'staffList'];
  let loadedCount = 0;
  
  dataTypes.forEach(dataType => {
    database.ref(`dashboard/csvData/${dataType}`).once('value')
      .then(snapshot => {
        const data = snapshot.val();
        if (data && data.content) {
          uploadedData[dataType] = data.content;
          uploadTimestamps[dataType] = data.timestamp;
          
          if (dataType === 'bonusStructure') {
            try {
              const bonusData = parseCSV(data.content);
              updateBonusRates(bonusData);
              
              const btn = document.getElementById('bonusUploadBtn');
              if (btn) {
                btn.style.background = '#e8f5e9';
                btn.style.borderColor = '#4caf50';
                btn.innerHTML = 
                  '<span style="font-size: 16px;">üíµ</span>' +
                  '<span>Bonus Structure ‚úì</span>' +
                  '<span style="margin-left: auto; color: #4caf50; font-size: 12px;">LOADED</span>';
              }
            } catch (error) {
              console.error('Error processing bonus data:', error);
            }
          }
          
          if (dataType === 'payroll') {
            payrollData = parseCSV(data.content);
            extractPayPeriods();
          }
        }
        
        loadedCount++;
        if (loadedCount === dataTypes.length) {
          updateUploadTimestamps();
          populateLoginDropdown();
          showNotification('All data loaded from cloud', 'success');
          
          if (uploadedData.sales || uploadedData.appointments) {
            setTimeout(() => {
              processAllData();
            }, 500);
          }
        }
      })
      .catch(error => {
        console.error(`Error loading ${dataType}:`, error);
        loadedCount++;
      });
  });
}

    // Data Validator
    window.DataValidator = {
      showValidationPreview: function() {
        console.log('Validation preview triggered');
        processAllData();
      }
    };

    // Authentication state listener
    auth.onAuthStateChanged((user) => {
      if (user) {
        console.log('User is signed in:', user.email);
      } else {
        document.getElementById('loginSection').classList.remove('hidden');
        document.getElementById('staffView').classList.add('hidden');
        document.getElementById('adminView').classList.add('hidden');
      }
    });

    // DOMContentLoaded event listener
    document.addEventListener('DOMContentLoaded', function() {
      console.log('Enhanced Performance Dashboard initialized');
      
      initializeDefaultStaff();
      createStaffDropdown();
      createAdminDropdown();
      
      const savedStaffList = localStorage.getItem('staffList');
      if (savedStaffList) {
        updateStaffDropdown(JSON.parse(savedStaffList));
        console.log('Staff list auto-loaded from saved settings');
      }
      
      const appointmentInput = document.getElementById('appointmentFile');
      if (appointmentInput) {
        console.log('Appointment input found at initialization');
      } else {
        console.log('ERROR: Appointment input NOT found at initialization');
      }
      
      const savedBonus = localStorage.getItem('bonusStructure');
      if (savedBonus) {
        uploadedData.bonusStructure = savedBonus;
        try {
          const bonusData = parseCSV(savedBonus);
          updateBonusRates(bonusData);
          
          const btn = document.getElementById('bonusUploadBtn');
          if (btn) {
            btn.style.background = '#e8f5e9';
            btn.style.borderColor = '#4caf50';
            btn.innerHTML = 
              '<span style="font-size: 16px;">üíµ</span>' +
              '<span>Bonus Structure ‚úì</span>' +
              '<span style="margin-left: auto; color: #4caf50; font-size: 12px;">LOADED</span>';
          }
          
          console.log('Bonus structure auto-loaded from saved settings');
        } catch (error) {
          console.error('Error loading saved bonus structure:', error);
        }
      }
    });
  </script>
</body>
</html>
