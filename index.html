

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Performance Dashboard - Enhanced</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; }
    .header { background: white; padding: 15px 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 24px; font-weight: 600; }
    .login-container { max-width: 900px; margin: 100px auto; padding: 20px; }
    .login-header { text-align: center; margin-bottom: 40px; }
    .login-header h2 { font-size: 32px; color: #333; }
    .login-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; max-width: 800px; margin: 0 auto; }
    .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
    .login-box h3 { color: #007bff; font-size: 24px; margin-bottom: 10px; }
    .login-box p { color: #6c757d; margin-bottom: 30px; font-size: 14px; }
    .login-form { display: flex; flex-direction: column; gap: 15px; }
    .login-form input, .login-form select { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; width: 100%; }
    .login-btn { padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer; color: white; transition: all 0.3s; }
    .staff-login-btn { background: #28a745; }
    .staff-login-btn:hover { background: #218838; }
    .admin-login-btn { background: #007bff; }
    .admin-login-btn:hover { background: #0056b3; }
    .logout-btn { background: white; color: #dc3545; border: 1px solid #dc3545; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; }
    .logout-btn:hover { background: #dc3545; color: white; }
    .hidden { display: none !important; }
    .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 5px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 350px; animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    .notification.success { background: #28a745; color: white; }
    .notification.error { background: #dc3545; color: white; }
    .staff-container { padding: 30px; max-width: 1400px; margin: 0 auto; }
    
    /* Enhanced Staff Dashboard Styles */
    .welcome-section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .period-selector-staff { margin-top: 10px; padding: 8px 16px; border-radius: 5px; border: 1px solid #ddd; font-size: 14px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; transition: transform 0.3s; position: relative; }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .stat-label { color: #666; font-size: 12px; text-transform: uppercase; margin-bottom: 10px; font-weight: 600; }
    .stat-value { font-size: 48px; font-weight: bold; color: #007bff; margin-bottom: 10px; }
    .stat-goal { font-size: 14px; color: #666; margin-bottom: 15px; }
    .status-badge { padding: 4px 8px; border-radius: 15px; font-size: 12px; font-weight: 600; display: inline-block; margin-bottom: 10px; color: white; }
    .status-green { background: #28a745; }
    .status-yellow { background: #ffc107; color: #333; }
    .status-red { background: #dc3545; }
    
    /* Metric displays */
    .metric-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 13px; }
    .metric-label { color: #666; }
    .metric-value { font-weight: 600; color: #333; }
    .hours-indicator { position: absolute; top: 10px; right: 10px; background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    
    .efficiency-section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .efficiency-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px; }
    .efficiency-card { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    .efficiency-value { font-size: 24px; font-weight: bold; color: #28a745; margin-bottom: 5px; }
    .efficiency-label { font-size: 12px; color: #666; }
    
    .comparison-table { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .comparison-table h3 { color: #333; margin-bottom: 15px; font-size: 18px; }
    .comparison-table table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .comparison-table th { padding: 10px; text-align: left; border: 1px solid #dee2e6; font-weight: 600; background: #f8f9fa; }
    .comparison-table td { padding: 10px; border: 1px solid #dee2e6; text-align: center; }
    .user-row { background: #e3f2fd; font-weight: bold; }
    
    .bonus-section { background: linear-gradient(135deg, #374151, #4b5563); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
    .bonus-total { font-size: 36px; font-weight: bold; margin-bottom: 20px; }
    .bonus-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
    .bonus-item { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center; }
    
    .tips-section { background: #e3f2fd; padding: 20px; border-radius: 10px; border-left: 4px solid #2196f3; }
    .tips-section h3 { color: #1976d2; margin-bottom: 10px; font-size: 16px; }
    .tips-section ul { list-style: none; padding: 0; }
    .tips-section li { padding: 5px 0; color: #555; font-size: 14px; }
    .tips-section li:before { content: "‚úì "; color: #1976d2; font-weight: bold; margin-right: 8px; }
    
    /* Admin Dashboard Styles */
    .admin-container { padding: 30px; max-width: 1400px; margin: 0 auto; }
    .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .admin-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .admin-card h3 { color: #333; margin-bottom: 15px; font-size: 18px; }
    .team-table { width: 100%; border-collapse: collapse; }
    .team-table th { padding: 12px; text-align: left; background: #f8f9fa; border-bottom: 2px solid #dee2e6; font-size: 13px; }
    .team-table td { padding: 12px; border-bottom: 1px solid #dee2e6; font-size: 13px; }
    .performance-bar { height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; }
    .performance-fill { height: 100%; background: #28a745; transition: width 0.3s; }
    
    .trend-indicator { display: inline-block; margin-left: 5px; font-size: 12px; }
    .trend-up { color: #28a745; }
    .trend-down { color: #dc3545; }
    .trend-neutral { color: #6c757d; }
    
    @media (max-width: 768px) {
      .login-grid { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr; }
      .bonus-breakdown { grid-template-columns: 1fr; }
      .efficiency-grid { grid-template-columns: 1fr; }
    }
    /* Fix layout issues */
.staff-container > * {
  margin-bottom: 20px;
  clear: both;
}

.comparison-table {
  clear: both;
  width: 100%;
  margin-bottom: 20px;
}

.bonus-section {
  clear: both;
  width: 100%;
  margin-bottom: 20px;
}

.tips-section {
  clear: both;
  width: 100%;
  margin-bottom: 20px;
}

/* Ensure proper spacing between sections */
.stats-grid {
  margin-bottom: 30px !important;
}

/* Fix table overflow */
.comparison-table table {
  width: 100%;
  table-layout: auto;
}

.comparison-table td, .comparison-table th {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}
/* Fix Performance Tips positioning */
.tips-section {
  clear: both;
  width: 100%;
  margin: 20px 0;
  position: relative;
}

/* Fix grid layout for side-by-side sections */
.staff-container {
  display: flex;
  flex-direction: column;
  gap: 20px;
}

/* Stack Team Comparison and Bonus sections vertically */
.comparison-table {
  width: 100%;
  margin-bottom: 20px;
}

.bonus-section {
  width: 100%;
  max-width: none;
  margin-bottom: 20px;
}
  </style>
</head>
<body>
  <div id="loginSection">
    <div class="header">
      <h1>Performance Dashboard</h1>
    </div>
    <div class="login-container">
      <div class="login-header">
        <h2>Performance Dashboard Login</h2>
      </div>
      <div class="login-grid">
        <div class="login-box">
          <h3>Staff Login</h3>
          <p>Experience Guides - Access your personal dashboard</p>
          <div class="login-form">
            <select id="staffSelect">
              <option value="">Select your name...</option>
              <option value="Angela McNally">Angela McNally</option>
              <option value="Anna Mercadante">Anna Mercadante</option>
              <option value="Madison Jeske">Madison Jeske</option>
              <option value="Di Fisher">Di Fisher</option>
              <option value="Edward Franklin">Edward Franklin</option>
              <option value="Mariaelena Parra">Mariaelena Parra</option>
              <option value="Cheyenne Bringham">Cheyenne Bringham</option>
            </select>
            <input type="password" id="staffPassword" placeholder="Enter your Staff ID">
            <button class="login-btn staff-login-btn" onclick="loginStaff()">Login as Staff</button>
          </div>
        </div>
        <div class="login-box">
          <h3>Admin Login</h3>
          <p>Managers - Access all dashboards and reports</p>
          <div class="login-form">
            <input type="password" id="adminPassword" placeholder="Enter admin password">
            <button class="login-btn admin-login-btn" onclick="loginAdmin()">Login as Admin</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <div id="staffView" class="hidden">
    <div class="header">
      <h1 id="staffTitle">Performance Dashboard</h1>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
    
    <div class="staff-container">
      <div class="welcome-section">
        <h2>Welcome, <span id="staffName">Staff Member</span>!</h2>
        <p>Your Performance for <span id="staffPeriodDisplay">Current Period</span></p>
        <select id="staffPeriodSelector" onchange="changeStaffPeriod()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
          <option value="current">Aug 24 - Sep 6, 2025 (Current)</option>
          <option value="aug10">Aug 10-23, 2025</option>
          <option value="jul27">Jul 27 - Aug 9, 2025</option>
          <option value="jul13">Jul 13-26, 2025</option>
          <option value="jun29">Jun 29 - Jul 12, 2025</option>
          <option value="jun15">Jun 15-28, 2025</option>
          <option value="jun1">Jun 1-14, 2025</option>
          <option value="may18">May 18-31, 2025</option>
          <option value="may4">May 4-17, 2025</option>
          <option value="apr20">Apr 20 - May 3, 2025</option>
          <option value="apr6">Apr 6-19, 2025</option>
          <option value="mar23">Mar 23 - Apr 5, 2025</option>
          <option value="mar9">Mar 9-22, 2025</option>
          <option value="feb23">Feb 23 - Mar 8, 2025</option>
          <option value="feb9">Feb 9-22, 2025</option>
          <option value="jan26">Jan 26 - Feb 8, 2025</option>
          <option value="jan12">Jan 12-25, 2025</option>
        </select>
      </div>
<div class="tips-section">
        <h3>Performance Tips</h3>
        <ul id="performanceTips">
          <li>Loading personalized tips...</li>
        </ul>
      </div>
      <!-- Add this after line 246 -->


<!-- Wrap existing content starting at line 247 -->

 <div class="stats-grid">
        <div class="stat-card">
          <div class="hours-indicator" id="hoursWorked">0 hrs</div>
          <div class="stat-label">ENHANCEMENTS</div>
          <div class="stat-value" id="enhanceValue">0</div>
          <div class="stat-goal">Goal: <span id="enhanceAdjusted">0</span></div>
          <div class="status-badge" id="enhanceStatus">0%</div>
          <div id="enhanceMessage">Loading...</div>
          
        </div>

        <div class="stat-card">
          <div class="stat-label">MEMBERSHIPS</div>
          <div class="stat-value" id="memberValue">0</div>
          <div class="stat-goal">Conv Goal: <span id="convGoal">0%</span> | Actual: <span id="convActual">0%</span></div>
          <div class="status-badge" id="memberStatus">0%</div>
          <div id="memberMessage">Loading...</div>
          <div class="metric-row">
            <span class="metric-label">Eligible Guests:</span>
            <span class="metric-value" id="eligibleGuestsCount">0</span>
          </div>
        </div>

     
        <div class="stat-card">
          <div class="stat-label">REBOOK RATE</div>
          <div class="stat-value" id="rebookValue">0%</div>
          <div class="stat-goal">Target: 20%</div>
          <div class="status-badge" id="rebookStatus">Loading</div>
          <div id="rebookMessage">Loading...</div>
          <div class="metric-row">
            <span class="metric-label">Total Guests:</span>
            <span class="metric-value" id="totalGuestsServed">0</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-label">PERFORMANCE SCORE</div>
          <div class="stat-value" id="overallValue">0%</div>
          <div class="stat-goal">Adjusted for Hours & Conversion</div>
          <div class="status-badge" id="overallStatus">Loading</div>
          <div id="overallMessage">Loading...</div>
          <div class="metric-row">
            <span class="metric-label">Trend:</span>
            <span class="metric-value" id="performanceTrend">--</span>
          </div>
        </div>
 </div>
      <div class="comparison-table">
        <h3>Team Comparison</h3>
        <table>
          <thead>
            <tr>
              <th>Metric</th>
              <th>You</th>
              <th>Team Avg</th>
              <th>Top Performer</th>
            </tr>
          </thead>
          <tbody>
            <tr class="user-row">
              <td>Conversion Rate</td>
              <td id="yourConv">0%</td>
              <td id="avgConv">0%</td>
              <td id="topConv">0%</td>
            </tr>
            <tr>
              <td>Enhancements/Hour</td>
              <td id="yourEnhPerHour">0.00</td>
              <td id="avgEnhPerHour">0.00</td>
              <td id="topEnhPerHour">0.00</td>
            </tr>
            <tr class="user-row">
              <td>Members/Hour</td>
              <td id="yourMemPerHour">0.00</td>
              <td id="avgMemPerHour">0.00</td>
              <td id="topMemPerHour">0.00</td>
            </tr>
            <tr>
              <td>Rebook Rate</td>
              <td id="yourRebook">0%</td>
              <td id="avgRebook">0%</td>
              <td id="topRebook">0%</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="bonus-section">
        <h3>My Bonus Earnings - <span id="bonusPeriodDisplay">Current Period</span></h3>
        <div class="bonus-total" id="totalBonus">$0.00</div>
        <div class="bonus-breakdown">
          <div class="bonus-item">
            <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">Enhancement</div>
            <div style="font-size: 24px; font-weight: bold;" id="enhanceBonus">$0.00</div>
          </div>
          <div class="bonus-item">
            <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">Membership</div>
            <div style="font-size: 24px; font-weight: bold;" id="membershipBonus">$0.00</div>
          </div>
          <div class="bonus-item">
            <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">Performance</div>
            <div style="font-size: 24px; font-weight: bold;" id="performanceBonus">$0.00</div>
          </div>
        </div>
      </div>
 
       <div id="performanceTrendChart"></div>
    </div>
  </div>
  <div id="adminView" class="hidden">
    <div class="header">
      <h1>Admin Dashboard - Team Overview</h1>
      <div style="display: flex; gap: 10px; align-items: center;">
        <select id="periodSelector" onchange="changePeriod()" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
          <option value="current">Aug 24 - Sep 6, 2025 (Current)</option>
          <option value="aug10">Aug 10-23, 2025</option>
          <option value="jul27">Jul 27 - Aug 9, 2025</option>
          <option value="jul13">Jul 13-26, 2025</option>
          <option value="jun29">Jun 29 - Jul 12, 2025</option>
          <option value="jun15">Jun 15-28, 2025</option>
          <option value="jun1">Jun 1-14, 2025</option>
          <option value="may18">May 18-31, 2025</option>
          <option value="may4">May 4-17, 2025</option>
          <option value="apr20">Apr 20 - May 3, 2025</option>
          <option value="apr6">Apr 6-19, 2025</option>
          <option value="mar23">Mar 23 - Apr 5, 2025</option>
          <option value="mar9">Mar 9-22, 2025</option>
          <option value="feb23">Feb 23 - Mar 8, 2025</option>
          <option value="feb9">Feb 9-22, 2025</option>
          <option value="jan26">Jan 26 - Feb 8, 2025</option>
          <option value="jan12">Jan 12-25, 2025</option>
          <option value="sep7" disabled>Sep 7-20, 2025 (Future)</option>
          <option value="sep21" disabled>Sep 21 - Oct 4, 2025 (Future)</option>
          <option value="oct5" disabled>Oct 5-18, 2025 (Future)</option>
          <option value="oct19" disabled>Oct 19 - Nov 1, 2025 (Future)</option>
          <option value="nov2" disabled>Nov 2-15, 2025 (Future)</option>
          <option value="nov16" disabled>Nov 16-29, 2025 (Future)</option>
          <option value="nov30" disabled>Nov 30 - Dec 13, 2025 (Future)</option>
          <option value="dec14" disabled>Dec 14-27, 2025 (Future)</option>
          <option value="dec28" disabled>Dec 28, 2025 - Jan 10, 2026 (Future)</option>
        </select>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
    
    
    <div class="admin-container">
      <div class="admin-grid">
        <div class="admin-card">
          <h3>Team Summary</h3>
          <div style="display: flex; justify-content: space-between; margin: 10px 0;">
            <span>Total Staff:</span>
            <strong>7</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin: 10px 0;">
            <span>Total Hours:</span>
            <strong id="totalHours">0</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin: 10px 0;">
            <span>Avg Conversion:</span>
            <strong id="avgConvAdmin">0%</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin: 10px 0;">
            <span>Avg Rebook Rate:</span>
            <strong id="avgRebookAdmin">0%</strong>
          </div>
        </div>
        
        <div class="admin-card">
          <h3>Top Performers (Adjusted)</h3>
          <ol id="topPerformers" style="padding-left: 20px;">
            <li>Loading...</li>
          </ol>
        </div>
        
        <div class="admin-card">
  <h3>Total Individual Bonuses</h3>
  <div style="font-size: 32px; font-weight: bold; color: #4a5568; text-align: center; margin: 20px 0;">
    <span id="totalTeamBonus">$0.00</span>
  </div>
  <p style="text-align: center; color: #666; font-size: 14px;">Sum of All Staff Bonuses</p>
</div>
      </div>
      
      <div class="admin-card">
        <h3>Full Team Performance</h3>
       <table class="team-table">
  <thead>
  <tr>
    <th>Name</th>
    <th>Hours</th>
    <th>Members</th>
    <th>Conv %</th>
    <th>Goal %</th>
    <th>Enhance</th>
    <th>Enh Goal</th>
    <th>Rebook Goal</th>
    <th>Rebook</th>
    <th>Bonus</th>
    <th>Score</th>
  </tr>
</thead>
  <tbody id="teamTableBody">
    <tr>
      <td colspan="11" style="text-align: center;">Loading...</td>
    </tr>
  </tbody>
</table>
      </div>

<div>
<!--Find and REPLACE the existing Data Upload Section (around line 2090-2150) with this code -->

<!-- Data Upload Section -->
<div class="admin-card" style="margin-top: 20px;">
  <h3 style="font-size: 18px; margin-bottom: 20px; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px;">
    <span style="color: #007bff;">üìä</span> Data Management Center
  </h3>
  
  <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
    <!-- Left Column - File Uploads -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
      <h4 style="font-size: 15px; margin-bottom: 15px; color: #495057; font-weight: 600;">
        Import Data Files
      </h4>
      
      <div style="display: flex; flex-direction: column; gap: 10px;">
        <!-- Appointment Data -->
        <div class="upload-item" style="display: flex; align-items: center; gap: 10px;">
          <button onclick="document.getElementById('appointmentFile').click()" 
                  style="flex: 1; background: white; color: #495057; border: 1px solid #ced4da; 
                         padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; 
                         text-align: left; display: flex; align-items: center; gap: 8px;
                         transition: all 0.2s;"
                  onmouseover="this.style.background='#e3f2fd'; this.style.borderColor='#2196f3';"
                  onmouseout="this.style.background='white'; this.style.borderColor='#ced4da';">
            <span style="font-size: 16px;">üìÖ</span>
            <span>Appointment Data</span>
            <span style="margin-left: auto; color: #6c757d; font-size: 12px;">CSV</span>
          </button>
          <input type="file" id="appointmentFile" accept=".csv" style="display: none;" 
                 onchange="handleAppointmentUpload(event)">
        </div>
        
        <!-- Membership Data -->
        <div class="upload-item" style="display: flex; align-items: center; gap: 10px;">
          <button onclick="document.getElementById('membershipFile').click()" 
                  style="flex: 1; background: white; color: #495057; border: 1px solid #ced4da; 
                         padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; 
                         text-align: left; display: flex; align-items: center; gap: 8px;
                         transition: all 0.2s;"
                  onmouseover="this.style.background='#fff3e0'; this.style.borderColor='#ff9800';"
                  onmouseout="this.style.background='white'; this.style.borderColor='#ced4da';">
            <span style="font-size: 16px;">üë•</span>
            <span>Membership Data</span>
            <span style="margin-left: auto; color: #6c757d; font-size: 12px;">CSV</span>
          </button>
          <input type="file" id="membershipFile" accept=".csv" style="display: none;" 
                 onchange="handleMembershipUpload(event)">
        </div>
        
        <!-- Sales Data -->
        <div class="upload-item" style="display: flex; align-items: center; gap: 10px;">
          <button onclick="document.getElementById('salesFile').click()" 
                  style="flex: 1; background: white; color: #495057; border: 1px solid #ced4da; 
                         padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; 
                         text-align: left; display: flex; align-items: center; gap: 8px;
                         transition: all 0.2s;"
                  onmouseover="this.style.background='#e8f5e9'; this.style.borderColor='#4caf50';"
                  onmouseout="this.style.background='white'; this.style.borderColor='#ced4da';">
            <span style="font-size: 16px;">üí∞</span>
            <span>Sales Data</span>
            <span style="margin-left: auto; color: #6c757d; font-size: 12px;">CSV</span>
          </button>
          <input type="file" id="salesFile" accept=".csv" style="display: none;" 
                 onchange="handleSalesUpload(event)">
        </div>
        
        <!-- OOT Data -->
        <div class="upload-item" style="display: flex; align-items: center; gap: 10px;">
          <button onclick="document.getElementById('ootFile').click()" 
                  style="flex: 1; background: white; color: #495057; border: 1px solid #ced4da; 
                         padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; 
                         text-align: left; display: flex; align-items: center; gap: 8px;
                         transition: all 0.2s;"
                  onmouseover="this.style.background='#f3e5f5'; this.style.borderColor='#9c27b0';"
                  onmouseout="this.style.background='white'; this.style.borderColor='#ced4da';">
            <span style="font-size: 16px;">üìç</span>
            <span>OOT Data</span>
            <span style="margin-left: auto; color: #6c757d; font-size: 12px;">CSV</span>
          </button>
          <input type="file" id="ootFile" accept=".csv" style="display: none;" 
                 onchange="handleOOTUpload(event)">
        </div>
        
        <!-- Payroll Hours -->
        <div class="upload-item" style="display: flex; align-items: center; gap: 10px;">
          <button onclick="document.getElementById('payrollFile').click()" 
                  style="flex: 1; background: white; color: #495057; border: 1px solid #ced4da; 
                         padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; 
                         text-align: left; display: flex; align-items: center; gap: 8px;
                         transition: all 0.2s;"
                  onmouseover="this.style.background='#fef4e7'; this.style.borderColor='#fd7e14';"
                  onmouseout="this.style.background='white'; this.style.borderColor='#ced4da';">
            <span style="font-size: 16px;">‚è∞</span>
            <span>Payroll Hours</span>
            <span style="margin-left: auto; color: #6c757d; font-size: 12px;">CSV</span>
          </button>
          <input type="file" id="payrollFile" accept=".csv" style="display: none;" 
                 onchange="handlePayrollUpload(event)">
        </div>
        
        <!-- Bonus Structure -->
        <div class="upload-item" style="display: flex; align-items: center; gap: 10px;">
          <button onclick="document.getElementById('bonusFile').click()" 
                  id="bonusUploadBtn"
                  style="flex: 1; background: white; color: #495057; border: 1px solid #ced4da; 
                         padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; 
                         text-align: left; display: flex; align-items: center; gap: 8px;
                         transition: all 0.2s;"
                  onmouseover="this.style.background='#e0f7fa'; this.style.borderColor='#00acc1';"
                  onmouseout="this.style.background='white'; this.style.borderColor='#ced4da';">
            <span style="font-size: 16px;">üíµ</span>
            <span>Bonus Structure</span>
            <span style="margin-left: auto; color: #6c757d; font-size: 12px;">CSV</span>
          </button>
          <input type="file" id="bonusFile" accept=".csv" style="display: none;" 
                 onchange="handleBonusUpload(event)">
        </div>
      </div>
    </div>
    
    <!-- Middle Column - Processing & Management -->
    <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
      <h4 style="font-size: 15px; margin-bottom: 15px; color: #495057; font-weight: 600;">
        Processing & Management
      </h4>
      
      <div style="display: flex; flex-direction: column; gap: 10px;">
        <!-- Validate Data Button -->
        <button onclick="DataValidator.showValidationPreview()" 
                style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                       color: white; border: none; padding: 12px 20px; 
                       border-radius: 6px; cursor: pointer; font-size: 14px; 
                       font-weight: 600; display: flex; align-items: center; 
                       justify-content: center; gap: 8px; transition: all 0.3s;
                       box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);"
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(102, 126, 234, 0.4)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(102, 126, 234, 0.3)';">
          <span>‚úì</span> Validate Data First
        </button>
        
        <!-- Process All Data Button -->
        <button onclick="processAllData()" 
                style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
                       color: white; border: none; padding: 12px 20px; 
                       border-radius: 6px; cursor: pointer; font-size: 14px; 
                       font-weight: 600; display: flex; align-items: center; 
                       justify-content: center; gap: 8px; transition: all 0.3s;
                       box-shadow: 0 2px 4px rgba(245, 87, 108, 0.3);"
                onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(245, 87, 108, 0.4)';"
                onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(245, 87, 108, 0.3)';">
          <span>‚ö°</span> Process All Data
        </button>
        
        <!-- Divider -->
        <div style="border-top: 1px solid #dee2e6; margin: 5px 0;"></div>
        
        <!-- Staff Management Button -->
        <button onclick="openSimpleStaffManager()" 
                style="background: white; color: #495057; 
                       border: 2px solid #dee2e6; padding: 12px 20px; 
                       border-radius: 6px; cursor: pointer; font-size: 14px; 
                       font-weight: 600; display: flex; align-items: center; 
                       justify-content: center; gap: 8px; transition: all 0.3s;"
                onmouseover="this.style.borderColor='#007bff'; this.style.color='#007bff'; this.style.background='#f8f9fa';"
                onmouseout="this.style.borderColor='#dee2e6'; this.style.color='#495057'; this.style.background='white';">
          <span>üë•</span> Manage Staff Members
        </button>
        
        <!-- Status Indicator -->
        <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
          <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #6c757d;">
            <span style="width: 8px; height: 8px; background: #28a745; border-radius: 50%; display: inline-block;"></span>
            <span>System Ready</span>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Right Column - Upload Timestamps -->
    <div id="uploadTimestampsDisplay" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
      <!-- This will be populated by JavaScript -->
    </div>
  </div>
  
  <!-- Pay Period Filter Section -->
  <div id="payPeriodFilter" style="display: none; background: white; padding: 15px; border-radius: 8px; border: 1px solid #dee2e6;">
    <h4 style="font-size: 14px; margin-bottom: 10px; color: #495057; font-weight: 600;">
      Filter by Pay Period
    </h4>
    <select id="payPeriodSelect" onchange="filterByPayPeriod(this.value)" 
            style="width: 100%; padding: 10px; border-radius: 6px; border: 1px solid #ced4da; 
                   font-size: 14px; background: white; color: #495057;">
      <option value="all">All Periods</option>
    </select>
  </div>
</div>
<!-- Simple Staff Manager Popup -->
<div id="simpleStaffManager" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10000; width: 400px;">
    <h3 style="margin-bottom: 20px;">Quick Staff Manager</h3>
    
    <div style="margin-bottom: 20px;">
        <h4 style="font-size: 14px; margin-bottom: 10px;">Add New Staff:</h4>
        <input type="text" id="quickStaffName" placeholder="Name" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <input type="text" id="quickStaffID" placeholder="Staff ID (e.g., 1008)" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px;">
        <button onclick="quickAddStaff()" style="background: #28a745; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Add Staff</button>
    </div>
    
    <div style="margin-bottom: 20px;">
        <h4 style="font-size: 14px; margin-bottom: 10px;">Remove Staff:</h4>
        <select id="quickRemoveSelect" style="width: 100%; padding: 8px; margin-bottom: 8px; border: 1px solid #ddd; border-radius: 4px;">
            <option value="">Select staff to remove...</option>
        </select>
        <button onclick="quickRemoveStaff()" style="background: #dc3545; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer;">Remove Selected</button>
    </div>
    
    <button onclick="closeSimpleStaffManager()" style="background: #6c757d; color: white; border: none; padding: 8px 15px; border-radius: 4px; cursor: pointer; width: 100%;">Close</button>
</div>

<script>
let BONUS_RATES = {
  enhancement: {},
  membership: {},
  performanceBonus: 0
};

const PERFORMANCE_THRESHOLDS = {
  excellent: 100,
  good: 80,
  acceptable: 60
};

const CONVERSION_CONFIG = {
  localNonMemberRate: 0.366
};

/**
 * CSV Data Error Handling Module
 * Robust error handling for dashboard CSV processing
 * 
 * INTEGRATION INSTRUCTIONS:
 * ========================
 * Place this module at the beginning of your <script> section,
 * right after your constant definitions (BONUS_RATES, etc.)
 * but BEFORE your main application logic.
 * 
 * In your HTML file structure:
 * 1. <script>
 * 2. const BONUS_RATES = { ... }  // Your existing constants
 * 3. >>> INSERT THIS MODULE HERE <<<
 * 4. let currentUser = null;  // Your existing variables
 * 5. // Rest of your application code
 */

// ============================================
// 1. VALIDATION UTILITIES
// ============================================

/**
 * Validates if a value exists and is not null/undefined
 */
function isValid(value) {
  return value !== null && value !== undefined && value !== '';
}

/**
 * Validates required fields in an object
 */
function validateRequiredFields(data, requiredFields) {
  const missing = [];
  for (const field of requiredFields) {
    if (!isValid(data[field])) {
      missing.push(field);
    }
  }
  return {
    isValid: missing.length === 0,
    missingFields: missing
  };
}

/**
 * Sanitizes and validates staff data
 */
function validateStaffData(staffData) {
  if (!staffData || typeof staffData !== 'object') {
    return {
      isValid: false,
      error: 'Invalid staff data object',
      data: null
    };
  }

  // Define required fields for different calculations
  const requiredFields = ['enhance', 'membership', 'performance'];
  const validation = validateRequiredFields(staffData, requiredFields);

  if (!validation.isValid) {
    return {
      isValid: false,
      error: `Missing required fields: ${validation.missingFields.join(', ')}`,
      data: staffData
    };
  }

  // Sanitize numeric values
  const sanitized = {
    ...staffData,
    enhance: parseFloat(staffData.enhance) || 0,
    membership: parseFloat(staffData.membership) || 0,
    performance: parseFloat(staffData.performance) || 0
  };

  return {
    isValid: true,
    error: null,
    data: sanitized
  };
}

// ============================================
// 2. SAFE CALCULATION FUNCTIONS
// ============================================

/**
 * Calculates bonus with comprehensive error handling
 */
function calculateBonus(staffData) {
  const defaultResult = {
    enhanceBonus: 0,
    membershipBonus: 0,
    performanceBonus: 0,
    total: 0,
    status: 'error',
    message: 'Invalid data'
  };

  try {
    // Validate input data
    const validation = validateStaffData(staffData);
    if (!validation.isValid) {
      return {
        ...defaultResult,
        message: validation.error
      };
    }

    const data = validation.data;
    
    // Safe bonus calculations
    const enhanceBonus = safeDivide(data.enhance, 100) * 500;
    const membershipBonus = safeDivide(data.membership, 100) * 300;
    const performanceBonus = safeDivide(data.performance, 100) * 200;
    
    return {
      enhanceBonus: Math.round(enhanceBonus * 100) / 100,
      membershipBonus: Math.round(membershipBonus * 100) / 100,
      performanceBonus: Math.round(performanceBonus * 100) / 100,
      total: Math.round((enhanceBonus + membershipBonus + performanceBonus) * 100) / 100,
      status: 'success',
      message: 'Calculation successful'
    };
  } catch (error) {
    console.error('Bonus calculation error:', error);
    return {
      ...defaultResult,
      message: error.message
    };
  }
}

/**
 * Safe division with default value
 */
function safeDivide(numerator, denominator, defaultValue = 0) {
  try {
    // Handle various edge cases
    if (!isValid(denominator) || denominator === 0) {
      return defaultValue;
    }
    
    const num = parseFloat(numerator) || 0;
    const den = parseFloat(denominator);
    
    if (isNaN(num) || isNaN(den) || den === 0) {
      return defaultValue;
    }
    
    return num / den;
  } catch (error) {
    console.error('Division error:', error);
    return defaultValue;
  }
}

/**
 * Safe percentage calculation
 */
function safePercentage(value, total, decimals = 2) {
  const percentage = safeDivide(value, total, 0) * 100;
  return Math.round(percentage * Math.pow(10, decimals)) / Math.pow(10, decimals);
}

// ============================================
// 3. DATE PARSING UTILITIES
// ============================================

/**
 * Robust date parsing with multiple format support
 */
function parseDateConsistent(dateStr, formats = null) {
  if (!dateStr) return null;

  try {
    // Clean the input
    const cleaned = String(dateStr).trim();
    
    // Try standard Date parsing first
    let date = new Date(cleaned);
    if (!isNaN(date.getTime())) {
      return date;
    }

    // Common date formats to try
    const commonFormats = formats || [
      /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/,  // MM/DD/YYYY or M/D/YYYY
      /^(\d{1,2})-(\d{1,2})-(\d{4})$/,     // MM-DD-YYYY
      /^(\d{4})-(\d{1,2})-(\d{1,2})$/,     // YYYY-MM-DD
      /^(\d{1,2})\.(\d{1,2})\.(\d{4})$/,   // DD.MM.YYYY
    ];

    // Try parsing with common formats
    for (const format of commonFormats) {
      const match = cleaned.match(format);
      if (match) {
        // Adjust based on format
        if (format.source.includes('(\\d{4})$')) {
          // Year at end (US format)
          date = new Date(match[3], match[1] - 1, match[2]);
        } else {
          // Year at beginning (ISO format)
          date = new Date(match[1], match[2] - 1, match[3]);
        }
        
        if (!isNaN(date.getTime())) {
          return date;
        }
      }
    }

    // Excel serial date number check
    const serialNumber = parseFloat(cleaned);
    if (!isNaN(serialNumber) && serialNumber > 25569 && serialNumber < 100000) {
      // Excel dates start from 1900-01-01
      date = new Date((serialNumber - 25569) * 86400 * 1000);
      if (!isNaN(date.getTime())) {
        return date;
      }
    }

    return null;
  } catch (error) {
    console.error('Date parsing error:', error, 'Input:', dateStr);
    return null;
  }
}

/**
 * Format date consistently
 */
function formatDate(date, format = 'MM/DD/YYYY') {
  if (!date || !(date instanceof Date) || isNaN(date.getTime())) {
    return '';
  }

  const month = String(date.getMonth() + 1).padStart(2, '0');
  const day = String(date.getDate()).padStart(2, '0');
  const year = date.getFullYear();

  switch (format) {
    case 'MM/DD/YYYY':
      return `${month}/${day}/${year}`;
    case 'YYYY-MM-DD':
      return `${year}-${month}-${day}`;
    case 'DD.MM.YYYY':
      return `${day}.${month}.${year}`;
    default:
      return `${month}/${day}/${year}`;
  }
}

// ============================================
// 4. CATEGORY MATCHING UTILITIES
// ============================================

/**
 * Flexible category matching with fuzzy logic
 */
function isEnhancement(category) {
  if (!category) return false;
  
  const cat = String(category).trim().toLowerCase();
  
  // Multiple matching patterns
  const patterns = [
    'enhancement',
    'enhance',
    'improvement',
    'upgrade'
  ];
  
  return patterns.some(pattern => cat.includes(pattern));
}

/**
 * Generic category matcher
 */
function matchesCategory(value, patterns, exact = false) {
  if (!value) return false;
  
  const normalized = String(value).trim().toLowerCase();
  
  if (!Array.isArray(patterns)) {
    patterns = [patterns];
  }
  
  const normalizedPatterns = patterns.map(p => String(p).trim().toLowerCase());
  
  if (exact) {
    return normalizedPatterns.includes(normalized);
  }
  
  return normalizedPatterns.some(pattern => 
    normalized.includes(pattern) || pattern.includes(normalized)
  );
}

// ============================================
// 5. CSV PROCESSING WITH ERROR HANDLING
// ============================================

/**
 * Process CSV data with comprehensive error handling
 */
function processCSVData(csvData, options = {}) {
  const results = {
    success: [],
    errors: [],
    warnings: [],
    totalRows: 0,
    processedRows: 0,
    failedRows: 0
  };

  try {
    // Validate CSV data exists
    if (!csvData || !Array.isArray(csvData) || csvData.length === 0) {
      throw new Error('No CSV data to process');
    }

    results.totalRows = csvData.length;

    // Process each row
    csvData.forEach((row, index) => {
      try {
        // Skip empty rows
        if (!row || Object.keys(row).length === 0) {
          results.warnings.push({
            row: index + 1,
            message: 'Empty row skipped'
          });
          return;
        }

        // Validate required columns based on options
        if (options.requiredColumns) {
          const validation = validateRequiredFields(row, options.requiredColumns);
          if (!validation.isValid) {
            throw new Error(`Missing columns: ${validation.missingFields.join(', ')}`);
          }
        }

        // Process the row (custom processing logic)
        const processedRow = processRow(row, options);
        
        results.success.push(processedRow);
        results.processedRows++;
        
      } catch (rowError) {
        results.errors.push({
          row: index + 1,
          data: row,
          error: rowError.message
        });
        results.failedRows++;
      }
    });

    return results;
    
  } catch (error) {
    console.error('CSV processing error:', error);
    return {
      ...results,
      criticalError: error.message
    };
  }
}

/**
 * Process individual row with error handling
 */
function processRow(row, options = {}) {
  const processed = {};
  
  // Process each field with error handling
  for (const [key, value] of Object.entries(row)) {
    try {
      // Clean the key
      const cleanKey = key.trim().toLowerCase().replace(/\s+/g, '_');
      
      // Process based on field type
      if (options.dateFields && options.dateFields.includes(cleanKey)) {
        processed[cleanKey] = parseDateConsistent(value);
      } else if (options.numericFields && options.numericFields.includes(cleanKey)) {
        processed[cleanKey] = parseFloat(value) || 0;
      } else {
        processed[cleanKey] = String(value).trim();
      }
    } catch (fieldError) {
      console.warn(`Field processing error for ${key}:`, fieldError);
      processed[key] = value; // Keep original value
    }
  }
  
  return processed;
}

// ============================================
// 6. MAIN PROCESSING FUNCTION
// ============================================

/**
 * Main function to process all data with error handling
 */
function processAllDataWithErrorHandling(csvFiles, options = {}) {
  const results = {
    success: false,
    data: null,
    errors: [],
    warnings: []
  };

  try {
    // Validate input
    if (!csvFiles || Object.keys(csvFiles).length === 0) {
      throw new Error('No CSV files provided');
    }

    // Process each CSV file
    const processedData = {};
    
    for (const [fileName, fileData] of Object.entries(csvFiles)) {
      try {
        console.log(`Processing ${fileName}...`);
        
        const fileResults = processCSVData(fileData, {
          ...options,
          fileName
        });
        
        if (fileResults.criticalError) {
          throw new Error(fileResults.criticalError);
        }
        
        processedData[fileName] = fileResults;
        
        // Collect warnings and errors
        if (fileResults.errors.length > 0) {
          results.errors.push({
            file: fileName,
            errors: fileResults.errors
          });
        }
        
        if (fileResults.warnings.length > 0) {
          results.warnings.push({
            file: fileName,
            warnings: fileResults.warnings
          });
        }
        
      } catch (fileError) {
        results.errors.push({
          file: fileName,
          error: fileError.message
        });
      }
    }

    // Final validation
    if (results.errors.length === 0) {
      results.success = true;
      results.data = processedData;
      showNotification('Data processed successfully', 'success');
    } else {
      showNotification('Data processed with errors. Check console for details.', 'warning');
    }

    return results;
    
  } catch (error) {
    console.error('Critical data processing error:', error);
    results.errors.push({
      type: 'critical',
      error: error.message
    });
    showNotification('Error processing data. Please check your CSV files.', 'error');
    return results;
  }
}

// ============================================
// 7. NOTIFICATION SYSTEM
// ============================================

/**
 * Show user notification
 */
function showNotification(message, type = 'info') {
  // If you have a notification system in your dashboard
  if (typeof window !== 'undefined' && window.showToast) {
    window.showToast(message, type);
    return;
  }

  // Fallback to console
  const logMethod = type === 'error' ? 'error' : type === 'warning' ? 'warn' : 'log';
  console[logMethod](`[${type.toUpperCase()}] ${message}`);

  // Optional: Create simple notification element
  if (typeof document !== 'undefined') {
    const notification = document.createElement('div');
    notification.className = `notification notification-${type}`;
    notification.textContent = message;
    notification.style.cssText = `
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 15px 20px;
      border-radius: 5px;
      z-index: 10000;
      animation: slideIn 0.3s ease;
      background: ${type === 'error' ? '#f44336' : type === 'warning' ? '#ff9800' : type === 'success' ? '#4caf50' : '#2196f3'};
      color: white;
      box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.style.animation = 'slideOut 0.3s ease';
      setTimeout(() => notification.remove(), 300);
    }, 3000);
  }
}

// ============================================
// 8. EXPORT FOR USE
// ============================================

// Export functions if using modules
if (typeof module !== 'undefined' && module.exports) {
  module.exports = {
    validateStaffData,
    calculateBonus,
    safeDivide,
    safePercentage,
    parseDateConsistent,
    formatDate,
    isEnhancement,
    matchesCategory,
    processCSVData,
    processAllData,
    showNotification
  };
}

// ============================================
// DATA VALIDATION PREVIEW MODULE
// ============================================

/**
 * Main validation controller
 */
const DataValidator = {
  // Store validation results
  validationResults: {
    sales: null,
    memberships: null,
    oot: null,
    payroll: null,
    appointments: null
  },

  // Known staff names for validation
  knownStaff: [
    'Angela McNally',
    'Anna Mercadante', 
    'Madison Jeske',
    'Di Fisher',
    'Edward Franklin',
    'Mariaelena Parra',
    'Cheyenne Bringham'
  ],

  /**
   * Validate all uploaded files
   */
  validateAllFiles: function() {
    const results = {};
    let hasData = false;

    // Validate each file type if uploaded
    if (uploadedData.sales) {
      results.sales = this.validateSalesData(parseCSV(uploadedData.sales));
      hasData = true;
    }
    if (uploadedData.appointments) {
      results.appointments = this.validateAppointmentData(parseCSV(uploadedData.appointments));
      hasData = true;
    }
    if (uploadedData.memberships) {
      results.memberships = this.validateMembershipData(parseCSV(uploadedData.memberships));
      hasData = true;
    }
    if (uploadedData.oot) {
      results.oot = this.validateOOTData(parseCSV(uploadedData.oot));
      hasData = true;
    }
    if (uploadedData.payroll) {
      results.payroll = this.validatePayrollData(parseCSV(uploadedData.payroll));
      hasData = true;
    }

    if (!hasData) {
      return null;
    }

    this.validationResults = results;
    return results;
  },

  /**
   * Validate Sales CSV
   */
  validateSalesData: function(data) {
    const issues = [];
    const warnings = [];
    const stats = {
      totalRows: data.length,
      validRows: 0,
      errorRows: 0,
      warningRows: 0
    };

    const requiredColumns = ['Sale Date', 'ClosedBy', 'Invoice No', 'Category', 'Member'];
    const presentColumns = data.length > 0 ? Object.keys(data[0]) : [];
    
    // Check for missing columns
    const missingColumns = requiredColumns.filter(col => !presentColumns.includes(col));
    if (missingColumns.length > 0) {
      issues.push({
        type: 'critical',
        message: `Missing required columns: ${missingColumns.join(', ')}`
      });
      stats.errorRows = data.length;
      return { issues, warnings, stats };
    }

    // Validate each row
    data.forEach((row, index) => {
      const rowNum = index + 2; // Account for header row
      let hasError = false;
      let hasWarning = false;

      // Check date format
      const date = parseDateConsistent(row['Sale Date']);
      if (!date) {
        issues.push({
          type: 'error',
          row: rowNum,
          message: `Invalid date: "${row['Sale Date']}"`
        });
        hasError = true;
      }

      // Check if ClosedBy is a known staff member
      if (row['ClosedBy'] && !this.knownStaff.includes(row['ClosedBy'])) {
        warnings.push({
          type: 'warning',
          row: rowNum,
          message: `Unknown staff member: "${row['ClosedBy']}"`
        });
        hasWarning = true;
      }

      // Check Category format
      const category = (row['Category'] || '').trim().toLowerCase();
      if (!category) {
        warnings.push({
          type: 'warning',
          row: rowNum,
          message: 'Empty category field'
        });
        hasWarning = true;
      }

      // Check Member field
      const memberValue = (row['Member'] || '').trim().toUpperCase();
      if (memberValue && !['YES', 'NO', 'TRUE', 'FALSE', '1', '0'].includes(memberValue)) {
        warnings.push({
          type: 'warning',
          row: rowNum,
          message: `Ambiguous Member value: "${row['Member']}"`
        });
        hasWarning = true;
      }

      // Update stats
      if (hasError) {
        stats.errorRows++;
      } else if (hasWarning) {
        stats.warningRows++;
        stats.validRows++;
      } else {
        stats.validRows++;
      }
    });

    return { issues, warnings, stats };
  },

  /**
   * Validate Membership CSV
   */
  validateMembershipData: function(data) {
    const issues = [];
    const warnings = [];
    const stats = {
      totalRows: data.length,
      validRows: 0,
      errorRows: 0,
      warningRows: 0
    };

    const requiredColumns = ['Sale Date', 'Sold By'];
    const presentColumns = data.length > 0 ? Object.keys(data[0]) : [];
    
    const missingColumns = requiredColumns.filter(col => !presentColumns.includes(col));
    if (missingColumns.length > 0) {
      issues.push({
        type: 'critical',
        message: `Missing required columns: ${missingColumns.join(', ')}`
      });
      stats.errorRows = data.length;
      return { issues, warnings, stats };
    }

    data.forEach((row, index) => {
      const rowNum = index + 2;
      let hasError = false;
      let hasWarning = false;

      // Validate date
      const date = parseDateConsistent(row['Sale Date']);
      if (!date) {
        issues.push({
          type: 'error',
          row: rowNum,
          message: `Invalid date: "${row['Sale Date']}"`
        });
        hasError = true;
      }

      // Check staff member
      if (row['Sold By'] && !this.knownStaff.includes(row['Sold By'])) {
        warnings.push({
          type: 'warning',
          row: rowNum,
          message: `Unknown staff member: "${row['Sold By']}"`
        });
        hasWarning = true;
      }

      if (hasError) {
        stats.errorRows++;
      } else if (hasWarning) {
        stats.warningRows++;
        stats.validRows++;
      } else {
        stats.validRows++;
      }
    });

    return { issues, warnings, stats };
  },

  /**
   * Validate OOT CSV
   */
  validateOOTData: function(data) {
    const issues = [];
    const warnings = [];
    const stats = {
      totalRows: data.length,
      validRows: 0,
      errorRows: 0,
      warningRows: 0
    };

    const requiredColumns = ['Sales Date', 'Invoice No'];
    const presentColumns = data.length > 0 ? Object.keys(data[0]) : [];
    
    const missingColumns = requiredColumns.filter(col => !presentColumns.includes(col));
    if (missingColumns.length > 0) {
      issues.push({
        type: 'critical',
        message: `Missing required columns: ${missingColumns.join(', ')}`
      });
      stats.errorRows = data.length;
      return { issues, warnings, stats };
    }

    data.forEach((row, index) => {
      const rowNum = index + 2;
      let hasError = false;

      const date = parseDateConsistent(row['Sales Date']);
      if (!date) {
        issues.push({
          type: 'error',
          row: rowNum,
          message: `Invalid date: "${row['Sales Date']}"`
        });
        hasError = true;
      }

      if (!row['Invoice No'] || row['Invoice No'].trim() === '') {
        issues.push({
          type: 'error',
          row: rowNum,
          message: 'Missing Invoice No'
        });
        hasError = true;
      }

      if (hasError) {
        stats.errorRows++;
      } else {
        stats.validRows++;
      }
    });

    return { issues, warnings, stats };
  },

/**
   * Validate Payroll CSV
   */
  validatePayrollData: function(data) {
    const issues = [];
    const warnings = [];
    const stats = {
      totalRows: data.length,
      validRows: 0,
      errorRows: 0,
      warningRows: 0,
      ignoredRows: 0
    };

    const requiredColumns = ['Name', 'Period Start', 'Period End', 'Hourly Hours'];
    const presentColumns = data.length > 0 ? Object.keys(data[0]) : [];
    
    const missingColumns = requiredColumns.filter(col => !presentColumns.includes(col));
    if (missingColumns.length > 0) {
      issues.push({
        type: 'critical',
        message: `Missing required columns: ${missingColumns.join(', ')}`
      });
      stats.errorRows = data.length;
      return { issues, warnings, stats };
    }

    let unknownStaffCount = {};
    
    data.forEach((row, index) => {
      const rowNum = index + 2;
      let hasError = false;
      let hasWarning = false;
      
      if (row['Name'] && !this.knownStaff.includes(row['Name'])) {
        unknownStaffCount[row['Name']] = (unknownStaffCount[row['Name']] || 0) + 1;
        stats.ignoredRows++;
        return;
      }
      
      const startDate = parseDateConsistent(row['Period Start']);
      const endDate = parseDateConsistent(row['Period End']);
      
      if (!startDate) {
        issues.push({
          type: 'error',
          row: rowNum,
          message: `Invalid start date: "${row['Period Start']}"`
        });
        hasError = true;
      }

      if (!endDate) {
        issues.push({
          type: 'error',
          row: rowNum,
          message: `Invalid end date: "${row['Period End']}"`
        });
        hasError = true;
      }

      const hoursValue = row['Hourly Hours'];
      const hours = hoursValue === '' || hoursValue === null || hoursValue === undefined ? 0 : parseFloat(hoursValue);
      
      if (isNaN(hours) && hoursValue !== '' && hoursValue !== null && hoursValue !== undefined) {
        issues.push({
          type: 'error',
          row: rowNum,
          message: `Invalid hours value: "${row['Hourly Hours']}"`
        });
        hasError = true;
      } else if (hours < 0) {
        warnings.push({
          type: 'warning',
          row: rowNum,
          message: `Negative hours: ${hours}`
        });
        hasWarning = true;
      } else if (hours > 168) {
        warnings.push({
          type: 'warning',
          row: rowNum,
          message: `Unusually high hours: ${hours}`
        });
        hasWarning = true;
      }

      if (hasError) {
        stats.errorRows++;
      } else if (hasWarning) {
        stats.warningRows++;
        stats.validRows++;
      } else {
        stats.validRows++;
      }
    });
    
    const unknownStaffList = Object.keys(unknownStaffCount);
    if (unknownStaffList.length > 0) {
      warnings.push({
        type: 'info',
        message: `Ignored ${stats.ignoredRows} rows for ${unknownStaffList.length} unknown staff members (only tracking your configured staff)`
      });
    }

    return { issues, warnings, stats };
  },


  /**
   * Validate Appointment CSV
   */
  validateAppointmentData: function(data) {
    const issues = [];
    const warnings = [];
    const stats = {
      totalRows: data.length,
      validRows: 0,
      errorRows: 0,
      warningRows: 0
    };

    const requiredColumns = ['Invoice No', 'Appointment Date', 'Status', 'Service Category', 'Rebooked', 'Booked By'];
    const presentColumns = data.length > 0 ? Object.keys(data[0]) : [];
    
    const missingColumns = requiredColumns.filter(col => !presentColumns.includes(col));
    if (missingColumns.length > 0) {
      issues.push({
        type: 'critical',
        message: `Missing required columns: ${missingColumns.join(', ')}`
      });
      stats.errorRows = data.length;
      return { issues, warnings, stats };
    }

    data.forEach((row, index) => {
      const rowNum = index + 2;
      let hasError = false;
      let hasWarning = false;

      // Validate date
      const date = parseDateConsistent(row['Appointment Date']);
      if (!date) {
        issues.push({
          type: 'error',
          row: rowNum,
          message: `Invalid date: "${row['Appointment Date']}"`
        });
        hasError = true;
      }

      // Check staff member
      if (row['Booked By'] && !this.knownStaff.includes(row['Booked By'])) {
        warnings.push({
          type: 'warning',
          row: rowNum,
          message: `Unknown staff member: "${row['Staff Name']}"`
        });
        hasWarning = true;
      }

      if (hasError) {
        stats.errorRows++;
      } else if (hasWarning) {
        stats.warningRows++;
        stats.validRows++;
      } else {
        stats.validRows++;
      }
    });

    return { issues, warnings, stats };
  },

  /**
   * Show validation preview modal
   */
  showValidationPreview: function() {
    const results = this.validateAllFiles();
    
    if (!results) {
      showNotification('Please upload data files first', 'error');
      return;
    }

    // Create modal overlay
    const overlay = document.createElement('div');
    overlay.id = 'validationOverlay';
    overlay.style.cssText = `
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      z-index: 10001;
      display: flex;
      align-items: center;
      justify-content: center;
    `;

    // Create modal content
    const modal = document.createElement('div');
    modal.style.cssText = `
      background: white;
      border-radius: 10px;
      padding: 30px;
      max-width: 800px;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    `;

    let modalHTML = '<h2 style="margin-bottom: 20px; color: #333;">Data Validation Preview</h2>';
    
    // Generate summary for each file
    let totalIssues = 0;
    let totalWarnings = 0;
    let canProcess = true;

    Object.entries(results).forEach(([fileType, validation]) => {
      if (!validation) return;

      const { issues, warnings, stats } = validation;
      totalIssues += issues.length;
      totalWarnings += warnings.length;

      // Check for critical issues
      const criticalIssues = issues.filter(i => i.type === 'critical');
      if (criticalIssues.length > 0) {
        canProcess = false;
      }

      modalHTML += `
        <div style="margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
          <h3 style="color: #007bff; margin-bottom: 10px; text-transform: capitalize;">
            ${fileType} Data
          </h3>
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 10px;">
            <div>
              <span style="color: #28a745;">‚úì Valid Rows:</span> 
              <strong>${stats.validRows}</strong>
            </div>
            <div>
              <span style="color: #ffc107;">‚ö† Warnings:</span> 
              <strong>${stats.warningRows}</strong>
            </div>
            <div>
              <span style="color: #dc3545;">‚úó Errors:</span> 
              <strong>${stats.errorRows}</strong>
            </div>
          </div>
      `;

      // Show first 5 issues
      if (issues.length > 0) {
        modalHTML += '<div style="margin-top: 10px;">';
        modalHTML += '<strong style="color: #dc3545;">Issues:</strong><ul style="margin: 5px 0; padding-left: 20px;">';
        issues.slice(0, 5).forEach(issue => {
          modalHTML += `<li style="color: #dc3545; font-size: 13px;">
            ${issue.row ? `Row ${issue.row}: ` : ''}${issue.message}
          </li>`;
        });
        if (issues.length > 5) {
          modalHTML += `<li style="color: #666; font-size: 13px;">... and ${issues.length - 5} more issues</li>`;
        }
        modalHTML += '</ul></div>';
      }

      // Show first 3 warnings
      if (warnings.length > 0) {
        modalHTML += '<div style="margin-top: 10px;">';
        modalHTML += '<strong style="color: #ffc107;">Warnings:</strong><ul style="margin: 5px 0; padding-left: 20px;">';
        warnings.slice(0, 3).forEach(warning => {
          modalHTML += `<li style="color: #856404; font-size: 13px;">
            ${warning.row ? `Row ${warning.row}: ` : ''}${warning.message}
          </li>`;
        });
        if (warnings.length > 3) {
          modalHTML += `<li style="color: #666; font-size: 13px;">... and ${warnings.length - 3} more warnings</li>`;
        }
        modalHTML += '</ul></div>';
      }

      modalHTML += '</div>';
    });

    // Summary section
    modalHTML += `
      <div style="padding: 15px; background: ${canProcess ? '#d4edda' : '#f8d7da'}; 
                  border-radius: 8px; margin-bottom: 20px;">
        <h4 style="color: ${canProcess ? '#155724' : '#721c24'}; margin-bottom: 10px;">
          ${canProcess ? '‚úì Ready to Process' : '‚úó Cannot Process - Critical Issues Found'}
        </h4>
        <p style="color: ${canProcess ? '#155724' : '#721c24'}; margin: 0; font-size: 14px;">
          Total Issues: ${totalIssues} | Total Warnings: ${totalWarnings}
        </p>
        ${!canProcess ? '<p style="color: #721c24; margin: 5px 0 0 0; font-size: 13px;">Please fix critical issues before processing.</p>' : ''}
      </div>
    `;

    // Action buttons
    modalHTML += `
      <div style="display: flex; gap: 10px; justify-content: flex-end;">
        <button onclick="DataValidator.closeValidationPreview()" style="
          padding: 10px 20px;
          background: #6c757d;
          color: white;
          border: none;
          border-radius: 5px;
          cursor: pointer;
          font-size: 14px;
        ">Cancel</button>
        ${canProcess ? `
          <button onclick="DataValidator.processAfterValidation()" style="
            padding: 10px 20px;
            background: #28a745;
            color: white;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            font-weight: bold;
          ">Process Anyway</button>
        ` : ''}
      </div>
    `;

    modal.innerHTML = modalHTML;
    overlay.appendChild(modal);
    document.body.appendChild(overlay);

    // Close on overlay click
    overlay.addEventListener('click', (e) => {
      if (e.target === overlay) {
        this.closeValidationPreview();
      }
    });
  },

  /**
   * Close validation preview
   */
  closeValidationPreview: function() {
    const overlay = document.getElementById('validationOverlay');
    if (overlay) {
      overlay.remove();
    }
  },

  /**
   * Process after validation
   */
  processAfterValidation: function() {
    this.closeValidationPreview();
    // Call your existing processAllData function
    processAllData();
  }
};

// ============================================
// INTEGRATION WITH EXISTING CODE
// ============================================

/**
 * Enhanced processAllData function with validation
 * REPLACE your existing processAllData function with this
 */
function processAllDataWithValidation() {
  // First show validation preview
  DataValidator.showValidationPreview();
}

// ============================================
// ADD VALIDATION BUTTON TO UI
// ============================================

// Add this function to create the validation button
function addValidationButton() {
  // Wait for DOM to be ready
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', addValidationButton);
    return;
  }

  // Find the Process All Data button
  const processButton = document.querySelector('button[onclick="processAllData()"]');
  
  if (processButton) {
    // Create validation button
    const validationButton = document.createElement('button');
    validationButton.textContent = '‚úì Validate Data First';
    validationButton.style.cssText = `
      background: #17a2b8;
      color: white;
      border: none;
      padding: 10px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 13px;
      width: 100%;
      margin-bottom: 5px;
      font-weight: bold;
    `;
    validationButton.onclick = () => DataValidator.showValidationPreview();
    
    // Insert before process button
    processButton.parentNode.insertBefore(validationButton, processButton);
    
    // Update process button to use validation
    processButton.onclick = () => processAllDataWithValidation();
    processButton.textContent = '‚ö° Process All Data';
    processButton.style.background = '#dc3545';
  }
}
// Initialize validation button when ready
// addValidationButton(); 
let currentUser = null;
let currentPeriod = 'current';

let uploadedData = {
  appointments: null,
  memberships: null,
  sales: null,
  oot: null,
  payroll: null,
  bonusStructure: null  // ADD THIS LINE
};
// Track when files were uploaded
let uploadTimestamps = {
  appointments: null,
  memberships: null,
  sales: null,
  oot: null,
  payroll: null,
  bonusStructure: null
};

// Function to format timestamp for display
function formatTimestamp(timestamp) {
  if (!timestamp) return 'Never';
  const date = new Date(timestamp);
  const now = new Date();
  const diffMs = now - date;
  const diffMins = Math.floor(diffMs / 60000);
  const diffHours = Math.floor(diffMs / 3600000);
  const diffDays = Math.floor(diffMs / 86400000);
  
  if (diffMins < 1) return 'Just now';
  if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
  if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
  if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
  
  return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
}

// Function to update the timestamp display
function updateUploadTimestamps() {
  const container = document.getElementById('uploadTimestampsDisplay');
  if (!container) return;
  
  let html = '<h4 style="font-size: 15px; margin-bottom: 15px; color: #495057; font-weight: 600;">üìÖ Last Upload Times</h4>';
  html += '<div style="display: flex; flex-direction: column; gap: 8px; font-size: 13px;">';
  
  const files = [
    { name: 'Appointments', key: 'appointments', icon: 'üìÖ' },
    { name: 'Memberships', key: 'memberships', icon: 'üë•' },
    { name: 'Sales', key: 'sales', icon: 'üí∞' },
    { name: 'OOT', key: 'oot', icon: 'üìç' },
    { name: 'Payroll', key: 'payroll', icon: '‚è∞' },
    { name: 'Bonus', key: 'bonusStructure', icon: 'üíµ' }
  ];
  
  files.forEach(file => {
    const timestamp = uploadTimestamps[file.key];
    const statusColor = timestamp ? '#16a34a' : '#dc2626';
    const statusIcon = timestamp ? '‚úì' : '‚úó';
    
    html += `
      <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 4px;">
        <span>${file.icon} ${file.name}:</span>
        <span style="color: ${statusColor}; font-weight: 500; font-size: 12px;">
          ${statusIcon} ${formatTimestamp(timestamp)}
        </span>
      </div>
    `;
  });
  
  // Add overall status
  const allTimestamps = Object.values(uploadTimestamps).filter(t => t !== null);
  if (allTimestamps.length > 0) {
    const oldestUpload = new Date(Math.min(...allTimestamps.map(t => new Date(t))));
    const ageInHours = (new Date() - oldestUpload) / 3600000;
    let statusColor = '#16a34a';
    let statusText = 'Data is current';
    
    if (ageInHours > 24) {
      statusColor = '#dc2626';
      statusText = 'Data needs refresh';
    } else if (ageInHours > 12) {
      statusColor = '#f59e0b';
      statusText = 'Consider updating';
    }
    
    html += `
      <div style="margin-top: 10px; padding-top: 10px; border-top: 1px solid #dee2e6; text-align: center;">
        <span style="color: ${statusColor}; font-weight: 600; font-size: 12px;">
          ${statusText}
        </span>
      </div>
    `;
  } else {
    html += `
      <div style="margin-top: 10px; padding: 10px; background: #fef2f2; border-radius: 4px; text-align: center;">
        <span style="color: #dc2626; font-size: 12px;">
          No files uploaded yet
        </span>
      </div>
    `;
  }
  
  html += '</div>';
  container.innerHTML = html;
}
let payrollData = null;
let payPeriods = [];
let parsedAppointments = null;
let parsedMemberships = null;
let parsedSales = null;
let parsedOOT = null;

// // Initial staff data - this is what gets modified by period selection
let staffData = {
  'Angela McNally': { 
    enhance: 12, enhanceGoal: 28, member: 4, memberGoal: 6, 
    rebook: 42, hours: 68, eligibleGuests: 133,
    totalGuests: 180, prevPerformance: 85, tenureMonths: 14
  },
  'Anna Mercadante': { 
    enhance: 8, enhanceGoal: 25, member: 1, memberGoal: 4, 
    rebook: 38, hours: 60, eligibleGuests: 100,
    totalGuests: 150, prevPerformance: 72, tenureMonths: 8
  },
  'Madison Jeske': { 
    enhance: 17, enhanceGoal: 25, member: 5, memberGoal: 3, 
    rebook: 35, hours: 55, eligibleGuests: 167,
    totalGuests: 140, prevPerformance: 88, tenureMonths: 12
  },
  'Di Fisher': { 
    enhance: 3, enhanceGoal: 17, member: 0, memberGoal: 3, 
    rebook: 25, hours: 40, eligibleGuests: 0,
    totalGuests: 95, prevPerformance: 45, tenureMonths: 3
  },
  'Edward Franklin': { 
    enhance: 11, enhanceGoal: 31, member: 5, memberGoal: 4, 
    rebook: 35, hours: 72, eligibleGuests: 125,
    totalGuests: 190, prevPerformance: 78, tenureMonths: 10
  },
  'Mariaelena Parra': { 
    enhance: 2, enhanceGoal: 11, member: 0, memberGoal: 2, 
    rebook: 15, hours: 28, eligibleGuests: 0,
    totalGuests: 65, prevPerformance: 40, tenureMonths: 2
  },
  'Cheyenne Bringham': { 
    enhance: 1, enhanceGoal: 11, member: 0, memberGoal: 2, 
    rebook: 18, hours: 25, eligibleGuests: 0,
    totalGuests: 58, prevPerformance: 38, tenureMonths: 1
  }
};

// Initialize bonuses for staffData using the new tier system
Object.keys(staffData).forEach(name => {
  const bonusCalc = calculateBonus(staffData[name]);
  staffData[name].bonus = bonusCalc.total;
});

const staffPasswords = {
  'Angela McNally': '1001',
  'Anna Mercadante': '1004', 
  'Madison Jeske': '1002',
  'Di Fisher': '1003',
  'Edward Franklin': '1005',
  'Mariaelena Parra': '1006',
  'Cheyenne Bringham': '1007'
};

// Simple Staff Management Functions
function openSimpleStaffManager() {
    document.getElementById('simpleStaffManager').style.display = 'block';
    
    // Populate the remove dropdown
    const select = document.getElementById('quickRemoveSelect');
    select.innerHTML = '<option value="">Select staff to remove...</option>';
    Object.keys(staffPasswords).forEach(name => {
        select.innerHTML += `<option value="${name}">${name}</option>`;
    });
}

function closeSimpleStaffManager() {
    document.getElementById('simpleStaffManager').style.display = 'none';
}

function quickAddStaff() {
    const name = document.getElementById('quickStaffName').value.trim();
    const id = document.getElementById('quickStaffID').value.trim();
    
    if (!name || !id) {
        alert('Please enter both name and ID');
        return;
    }
    
    // Add to staffPasswords
    staffPasswords[name] = id;
    
    // Add to staffData with default values
    staffData[name] = {
        enhance: 0, enhanceGoal: 10, member: 0, memberGoal: 2,
        rebook: 0, hours: 0, eligibleGuests: 0,
        totalGuests: 0, prevPerformance: 0, tenureMonths: 0
    };
    
    // Update the login dropdown
    const loginSelect = document.getElementById('staffSelect');
    if (loginSelect) {
        loginSelect.innerHTML += `<option value="${name}">${name}</option>`;
    }
    
    // Clear inputs
    document.getElementById('quickStaffName').value = '';
    document.getElementById('quickStaffID').value = '';
    
    alert(`${name} added successfully with ID ${id}`);
    closeSimpleStaffManager();
}

function quickRemoveStaff() {
    const name = document.getElementById('quickRemoveSelect').value;
    
    if (!name) {
        alert('Please select a staff member to remove');
        return;
    }
    
    if (confirm(`Are you sure you want to remove ${name}?`)) {
        // Remove from staffPasswords
        delete staffPasswords[name];
        
        // Remove from staffData
        delete staffData[name];
        
        // Update the login dropdown
        const loginSelect = document.getElementById('staffSelect');
        if (loginSelect) {
            const options = loginSelect.querySelectorAll('option');
            options.forEach(option => {
                if (option.value === name) {
                    option.remove();
                }
            });
        }
        
        alert(`${name} removed successfully`);
        closeSimpleStaffManager();
    }
}

// Centralized date parsing function
function parseDateConsistent(dateStr) {
  if (!dateStr) return null;
  dateStr = dateStr.trim();
  
  // Handle M/D/YY or M/D/YYYY format
  const parts = dateStr.split('/');
  if (parts.length === 3) {
    const month = parseInt(parts[0]) - 1; // JS months are 0-based
    const day = parseInt(parts[1]);
    let year = parseInt(parts[2]);
    if (year < 100) {
      // For business data from 2000s onwards
      year = 2000 + year;
    }
    return new Date(year, month, day);
  }
  
  // Try parsing as standard date string
  const parsed = new Date(dateStr);
  if (!isNaN(parsed)) return parsed;
  
  return null;
}

// ========================================
// FIX CONVERSION RATE CALCULATION
// ========================================


function calculateTrueConversionRate(membershipsSold, eligibleGuests) {
  const trueConversionRate = eligibleGuests > 0 ? 
    (membershipsSold / eligibleGuests * 100) : 0;
  
  return {
    eligibleProspects: eligibleGuests,
    conversionRate: trueConversionRate.toFixed(1)
  };
}


// Centralized bonus calculation function
function calculateBonus(staffData) {
  // Validate input data
  if (!staffData || staffData.enhance === undefined || staffData.member === undefined) {
    return {
      enhanceBonus: 0,
      membershipBonus: 0,
      performanceBonus: 0,
      total: 0,
      status: 'error',
      message: 'Missing required data'
    };
  }
  
  // Calculate enhancement bonus based on goal achievement
  const enhanceGoal = staffData.enhanceGoal || calculateFairEnhancementGoal(staffData.hours || 0, staffData.tenureMonths || 6);
  const enhancePercent = enhanceGoal > 0 ? (staffData.enhance / enhanceGoal * 100) : 0;
  
  let enhanceRate;
  if (enhancePercent >= 90) {
    enhanceRate = BONUS_RATES.enhancement.tier3; // $0.90
  } else if (enhancePercent >= 80) {
    enhanceRate = BONUS_RATES.enhancement.tier2; // $0.80
  } else {
    enhanceRate = BONUS_RATES.enhancement.tier1; // $0.70
  }
  
  const enhanceBonus = staffData.enhance * enhanceRate;
  
  // Calculate membership bonus with tiered structure
  let membershipBonus = 0;
  const memberships = staffData.member || 0;
  
  if (memberships >= 15) {
    membershipBonus = memberships * BONUS_RATES.membership.tier3; // $20
  } else if (memberships >= 10) {
    membershipBonus = memberships * BONUS_RATES.membership.tier2; // $15
  } else if (memberships >= 1) {
    membershipBonus = memberships * BONUS_RATES.membership.tier1; // $10
  }
  
  // Calculate performance bonus (simplified - no multiplier)
  let performanceBonus = 0;
  if (staffData.hours && staffData.eligibleGuests !== undefined) {
    const performanceScore = calculatePerformanceScore(staffData);
    if (performanceScore >= PERFORMANCE_THRESHOLDS.good) {
      performanceBonus = BONUS_RATES.performanceBonus;
    }
  }
  
  return {
    enhanceBonus: parseFloat(enhanceBonus.toFixed(2)),
    membershipBonus: parseFloat(membershipBonus.toFixed(2)),
    performanceBonus: parseFloat(performanceBonus.toFixed(2)),
    total: parseFloat((enhanceBonus + membershipBonus + performanceBonus).toFixed(2)),
    status: 'calculated',
    enhanceRate,
    enhancePercent: enhancePercent.toFixed(1),
    membershipTier: memberships >= 15 ? 3 : memberships >= 10 ? 2 : 1
  };
}


/// Complete period data - WITHOUT hardcoded bonuses
const periodData = {
  current: {
    'Angela McNally': { enhance: 12, enhanceGoal: 28, member: 4, memberGoal: 6, rebook: 42, hours: 68, eligibleGuests: 133, totalGuests: 180, prevPerformance: 85, tenureMonths: 14 },
    'Anna Mercadante': { enhance: 8, enhanceGoal: 25, member: 1, memberGoal: 4, rebook: 38, hours: 60, eligibleGuests: 100, totalGuests: 150, prevPerformance: 72, tenureMonths: 8 },
    'Madison Jeske': { enhance: 17, enhanceGoal: 25, member: 5, memberGoal: 3, rebook: 35, hours: 55, eligibleGuests: 167, totalGuests: 140, prevPerformance: 88, tenureMonths: 12 },
    'Di Fisher': { enhance: 3, enhanceGoal: 17, member: 0, memberGoal: 3, rebook: 25, hours: 40, eligibleGuests: 0, totalGuests: 95, prevPerformance: 45, tenureMonths: 3 },
    'Edward Franklin': { enhance: 11, enhanceGoal: 31, member: 5, memberGoal: 4, rebook: 35, hours: 72, eligibleGuests: 125, totalGuests: 190, prevPerformance: 78, tenureMonths: 10 },
    'Mariaelena Parra': { enhance: 2, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 15, hours: 28, eligibleGuests: 0, totalGuests: 65, prevPerformance: 40, tenureMonths: 2 },
    'Cheyenne Bringham': { enhance: 1, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 18, hours: 25, eligibleGuests: 0, totalGuests: 58, prevPerformance: 38, tenureMonths: 1 }
  },
  aug10: {
    'Angela McNally': { enhance: 9, enhanceGoal: 28, member: 3, memberGoal: 6, rebook: 38, hours: 65, eligibleGuests: 60, totalGuests: 170, prevPerformance: 82, tenureMonths: 14 },
    'Anna Mercadante': { enhance: 6, enhanceGoal: 25, member: 2, memberGoal: 4, rebook: 35, hours: 58, eligibleGuests: 50, totalGuests: 145, prevPerformance: 70, tenureMonths: 8 },
    'Madison Jeske': { enhance: 14, enhanceGoal: 25, member: 3, memberGoal: 3, rebook: 32, hours: 52, eligibleGuests: 75, totalGuests: 135, prevPerformance: 85, tenureMonths: 12 },
    'Di Fisher': { enhance: 5, enhanceGoal: 17, member: 1, memberGoal: 3, rebook: 28, hours: 42, eligibleGuests: 20, totalGuests: 100, prevPerformance: 43, tenureMonths: 3 },
    'Edward Franklin': { enhance: 8, enhanceGoal: 31, member: 4, memberGoal: 4, rebook: 30, hours: 70, eligibleGuests: 80, totalGuests: 185, prevPerformance: 75, tenureMonths: 10 },
    'Mariaelena Parra': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 10, hours: 26, eligibleGuests: 0, totalGuests: 60, prevPerformance: 35, tenureMonths: 2 },
    'Cheyenne Bringham': { enhance: 2, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 20, hours: 27, eligibleGuests: 0, totalGuests: 62, prevPerformance: 35, tenureMonths: 1 }
  },
  jul27: {
    'Angela McNally': { enhance: 10, enhanceGoal: 28, member: 4, memberGoal: 6, rebook: 40, hours: 70, eligibleGuests: 80, totalGuests: 175, prevPerformance: 80, tenureMonths: 14 },
    'Anna Mercadante': { enhance: 7, enhanceGoal: 25, member: 1, memberGoal: 4, rebook: 33, hours: 55, eligibleGuests: 40, totalGuests: 140, prevPerformance: 68, tenureMonths: 8 },
    'Madison Jeske': { enhance: 15, enhanceGoal: 25, member: 4, memberGoal: 3, rebook: 34, hours: 58, eligibleGuests: 100, totalGuests: 145, prevPerformance: 83, tenureMonths: 12 },
    'Di Fisher': { enhance: 4, enhanceGoal: 17, member: 0, memberGoal: 3, rebook: 22, hours: 38, eligibleGuests: 0, totalGuests: 85, prevPerformance: 40, tenureMonths: 3 },
    'Edward Franklin': { enhance: 9, enhanceGoal: 31, member: 3, memberGoal: 4, rebook: 32, hours: 68, eligibleGuests: 60, totalGuests: 180, prevPerformance: 73, tenureMonths: 10 },
    'Mariaelena Parra': { enhance: 1, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 12, hours: 30, eligibleGuests: 0, totalGuests: 70, prevPerformance: 32, tenureMonths: 2 },
    'Cheyenne Bringham': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 15, hours: 22, eligibleGuests: 0, totalGuests: 50, prevPerformance: 30, tenureMonths: 1 }
  },
  jul13: {
    'Angela McNally': { enhance: 11, enhanceGoal: 28, member: 3, memberGoal: 6, rebook: 36, hours: 66, eligibleGuests: 75, totalGuests: 165, prevPerformance: 78, tenureMonths: 14 },
    'Anna Mercadante': { enhance: 5, enhanceGoal: 25, member: 2, memberGoal: 4, rebook: 30, hours: 50, eligibleGuests: 40, totalGuests: 125, prevPerformance: 65, tenureMonths: 8 },
    'Madison Jeske': { enhance: 13, enhanceGoal: 25, member: 3, memberGoal: 3, rebook: 31, hours: 54, eligibleGuests: 90, totalGuests: 140, prevPerformance: 80, tenureMonths: 12 },
    'Di Fisher': { enhance: 3, enhanceGoal: 17, member: 1, memberGoal: 3, rebook: 24, hours: 36, eligibleGuests: 25, totalGuests: 80, prevPerformance: 38, tenureMonths: 3 },
    'Edward Franklin': { enhance: 10, enhanceGoal: 31, member: 4, memberGoal: 4, rebook: 33, hours: 74, eligibleGuests: 100, totalGuests: 195, prevPerformance: 71, tenureMonths: 10 },
    'Mariaelena Parra': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 8, hours: 24, eligibleGuests: 0, totalGuests: 55, prevPerformance: 30, tenureMonths: 2 },
    'Cheyenne Bringham': { enhance: 1, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 17, hours: 20, eligibleGuests: 0, totalGuests: 45, prevPerformance: 28, tenureMonths: 1 }
  },
  jun29: {
    'Angela McNally': { enhance: 9, enhanceGoal: 28, member: 3, memberGoal: 6, rebook: 35, hours: 64, eligibleGuests: 70, totalGuests: 160, prevPerformance: 75, tenureMonths: 14 },
    'Anna Mercadante': { enhance: 6, enhanceGoal: 25, member: 1, memberGoal: 4, rebook: 32, hours: 52, eligibleGuests: 35, totalGuests: 130, prevPerformance: 62, tenureMonths: 8 },
    'Madison Jeske': { enhance: 12, enhanceGoal: 25, member: 3, memberGoal: 3, rebook: 30, hours: 50, eligibleGuests: 85, totalGuests: 135, prevPerformance: 77, tenureMonths: 12 },
    'Di Fisher': { enhance: 2, enhanceGoal: 17, member: 0, memberGoal: 3, rebook: 20, hours: 34, eligibleGuests: 0, totalGuests: 75, prevPerformance: 35, tenureMonths: 3 },
    'Edward Franklin': { enhance: 8, enhanceGoal: 31, member: 3, memberGoal: 4, rebook: 30, hours: 66, eligibleGuests: 55, totalGuests: 175, prevPerformance: 68, tenureMonths: 10 },
    'Mariaelena Parra': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 7, hours: 22, eligibleGuests: 0, totalGuests: 50, prevPerformance: 28, tenureMonths: 2 },
    'Cheyenne Bringham': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 14, hours: 18, eligibleGuests: 0, totalGuests: 40, prevPerformance: 25, tenureMonths: 1 }
  },
  jun15: {
    'Angela McNally': { enhance: 8, enhanceGoal: 28, member: 3, memberGoal: 6, rebook: 33, hours: 62, eligibleGuests: 65, totalGuests: 155, prevPerformance: 72, tenureMonths: 14 },
    'Anna Mercadante': { enhance: 5, enhanceGoal: 25, member: 1, memberGoal: 4, rebook: 30, hours: 50, eligibleGuests: 30, totalGuests: 125, prevPerformance: 60, tenureMonths: 8 },
    'Madison Jeske': { enhance: 11, enhanceGoal: 25, member: 2, memberGoal: 3, rebook: 28, hours: 48, eligibleGuests: 80, totalGuests: 130, prevPerformance: 74, tenureMonths: 12 },
    'Di Fisher': { enhance: 2, enhanceGoal: 17, member: 0, memberGoal: 3, rebook: 18, hours: 32, eligibleGuests: 0, totalGuests: 70, prevPerformance: 32, tenureMonths: 3 },
    'Edward Franklin': { enhance: 7, enhanceGoal: 31, member: 3, memberGoal: 4, rebook: 28, hours: 64, eligibleGuests: 50, totalGuests: 170, prevPerformance: 65, tenureMonths: 10 },
    'Mariaelena Parra': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 6, hours: 20, eligibleGuests: 0, totalGuests: 45, prevPerformance: 25, tenureMonths: 2 },
    'Cheyenne Bringham': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 12, hours: 16, eligibleGuests: 0, totalGuests: 35, prevPerformance: 22, tenureMonths: 1 }
  },
  jun1: {
    'Angela McNally': { enhance: 7, enhanceGoal: 28, member: 2, memberGoal: 6, rebook: 30, hours: 60, eligibleGuests: 60, totalGuests: 150, prevPerformance: 70, tenureMonths: 14 },
    'Anna Mercadante': { enhance: 4, enhanceGoal: 25, member: 1, memberGoal: 4, rebook: 28, hours: 48, eligibleGuests: 25, totalGuests: 120, prevPerformance: 58, tenureMonths: 8 },
    'Madison Jeske': { enhance: 10, enhanceGoal: 25, member: 2, memberGoal: 3, rebook: 26, hours: 46, eligibleGuests: 75, totalGuests: 125, prevPerformance: 71, tenureMonths: 12 },
    'Di Fisher': { enhance: 1, enhanceGoal: 17, member: 0, memberGoal: 3, rebook: 16, hours: 30, eligibleGuests: 0, totalGuests: 65, prevPerformance: 30, tenureMonths: 3 },
    'Edward Franklin': { enhance: 6, enhanceGoal: 31, member: 2, memberGoal: 4, rebook: 26, hours: 62, eligibleGuests: 45, totalGuests: 165, prevPerformance: 62, tenureMonths: 10 },
    'Mariaelena Parra': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 5, hours: 18, eligibleGuests: 0, totalGuests: 40, prevPerformance: 22, tenureMonths: 2 },
    'Cheyenne Bringham': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 10, hours: 14, eligibleGuests: 0, totalGuests: 30, prevPerformance: 20, tenureMonths: 1 }
  },
  may18: {
    'Angela McNally': { enhance: 6, enhanceGoal: 28, member: 2, memberGoal: 6, rebook: 28, hours: 58, eligibleGuests: 55, totalGuests: 145, prevPerformance: 68, tenureMonths: 14 },
    'Anna Mercadante': { enhance: 4, enhanceGoal: 25, member: 1, memberGoal: 4, rebook: 26, hours: 46, eligibleGuests: 22, totalGuests: 115, prevPerformance: 55, tenureMonths: 8 },
    'Madison Jeske': { enhance: 9, enhanceGoal: 25, member: 2, memberGoal: 3, rebook: 24, hours: 44, eligibleGuests: 70, totalGuests: 120, prevPerformance: 68, tenureMonths: 12 },
    'Di Fisher': { enhance: 1, enhanceGoal: 17, member: 0, memberGoal: 3, rebook: 14, hours: 28, eligibleGuests: 0, totalGuests: 60, prevPerformance: 28, tenureMonths: 3 },
    'Edward Franklin': { enhance: 5, enhanceGoal: 31, member: 2, memberGoal: 4, rebook: 24, hours: 60, eligibleGuests: 40, totalGuests: 160, prevPerformance: 60, tenureMonths: 10 },
    'Mariaelena Parra': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 4, hours: 16, eligibleGuests: 0, totalGuests: 35, prevPerformance: 20, tenureMonths: 2 },
    'Cheyenne Bringham': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 8, hours: 12, eligibleGuests: 0, totalGuests: 25, prevPerformance: 18, tenureMonths: 1 }
  },
  may4: {
    'Angela McNally': { enhance: 5, enhanceGoal: 28, member: 2, memberGoal: 6, rebook: 26, hours: 56, eligibleGuests: 50, totalGuests: 140, prevPerformance: 65, tenureMonths: 14 },
    'Anna Mercadante': { enhance: 3, enhanceGoal: 25, member: 0, memberGoal: 4, rebook: 24, hours: 44, eligibleGuests: 0, totalGuests: 110, prevPerformance: 52, tenureMonths: 8 },
    'Madison Jeske': { enhance: 8, enhanceGoal: 25, member: 1, memberGoal: 3, rebook: 22, hours: 42, eligibleGuests: 65, totalGuests: 115, prevPerformance: 65, tenureMonths: 12 },
    'Di Fisher': { enhance: 0, enhanceGoal: 17, member: 0, memberGoal: 3, rebook: 12, hours: 26, eligibleGuests: 0, totalGuests: 55, prevPerformance: 25, tenureMonths: 3 },
    'Edward Franklin': { enhance: 4, enhanceGoal: 31, member: 1, memberGoal: 4, rebook: 22, hours: 58, eligibleGuests: 35, totalGuests: 155, prevPerformance: 58, tenureMonths: 10 },
    'Mariaelena Parra': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 3, hours: 14, eligibleGuests: 0, totalGuests: 30, prevPerformance: 18, tenureMonths: 2 },
    'Cheyenne Bringham': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 6, hours: 10, eligibleGuests: 0, totalGuests: 20, prevPerformance: 15, tenureMonths: 1 }
  },
  apr20: {
    'Angela McNally': { enhance: 4, enhanceGoal: 28, member: 1, memberGoal: 6, rebook: 24, hours: 54, eligibleGuests: 45, totalGuests: 135, prevPerformance: 62, tenureMonths: 14 },
    'Anna Mercadante': { enhance: 3, enhanceGoal: 25, member: 0, memberGoal: 4, rebook: 22, hours: 42, eligibleGuests: 0, totalGuests: 105, prevPerformance: 50, tenureMonths: 8 },
    'Madison Jeske': { enhance: 7, enhanceGoal: 25, member: 1, memberGoal: 3, rebook: 20, hours: 40, eligibleGuests: 60, totalGuests: 110, prevPerformance: 62, tenureMonths: 12 },
    'Di Fisher': { enhance: 0, enhanceGoal: 17, member: 0, memberGoal: 3, rebook: 10, hours: 24, eligibleGuests: 0, totalGuests: 50, prevPerformance: 22, tenureMonths: 3 },
    'Edward Franklin': { enhance: 3, enhanceGoal: 31, member: 1, memberGoal: 4, rebook: 20, hours: 56, eligibleGuests: 30, totalGuests: 150, prevPerformance: 55, tenureMonths: 10 },
    'Mariaelena Parra': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 2, hours: 12, eligibleGuests: 0, totalGuests: 25, prevPerformance: 15, tenureMonths: 2 },
    'Cheyenne Bringham': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 4, hours: 8, eligibleGuests: 0, totalGuests: 15, prevPerformance: 12, tenureMonths: 1 }
  },
  apr6: {
    'Angela McNally': { enhance: 3, enhanceGoal: 28, member: 1, memberGoal: 6, rebook: 22, hours: 52, eligibleGuests: 40, totalGuests: 130, prevPerformance: 60, tenureMonths: 14 },
    'Anna Mercadante': { enhance: 2, enhanceGoal: 25, member: 0, memberGoal: 4, rebook: 20, hours: 40, eligibleGuests: 0, totalGuests: 100, prevPerformance: 48, tenureMonths: 8 },
    'Madison Jeske': { enhance: 6, enhanceGoal: 25, member: 1, memberGoal: 3, rebook: 18, hours: 38, eligibleGuests: 55, totalGuests: 105, prevPerformance: 60, tenureMonths: 12 },
    'Di Fisher': { enhance: 0, enhanceGoal: 17, member: 0, memberGoal: 3, rebook: 8, hours: 22, eligibleGuests: 0, totalGuests: 45, prevPerformance: 20, tenureMonths: 3 },
    'Edward Franklin': { enhance: 2, enhanceGoal: 31, member: 1, memberGoal: 4, rebook: 18, hours: 54, eligibleGuests: 25, totalGuests: 145, prevPerformance: 52, tenureMonths: 10 },
    'Mariaelena Parra': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 1, hours: 10, eligibleGuests: 0, totalGuests: 20, prevPerformance: 12, tenureMonths: 2 },
    'Cheyenne Bringham': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 2, hours: 6, eligibleGuests: 0, totalGuests: 10, prevPerformance: 10, tenureMonths: 1 }
  },
  mar23: {
    'Angela McNally': { enhance: 2, enhanceGoal: 28, member: 1, memberGoal: 6, rebook: 20, hours: 50, eligibleGuests: 35, totalGuests: 125, prevPerformance: 58, tenureMonths: 14 },
    'Anna Mercadante': { enhance: 2, enhanceGoal: 25, member: 0, memberGoal: 4, rebook: 18, hours: 38, eligibleGuests: 0, totalGuests: 95, prevPerformance: 45, tenureMonths: 8 },
    'Madison Jeske': { enhance: 5, enhanceGoal: 25, member: 0, memberGoal: 3, rebook: 16, hours: 36, eligibleGuests: 0, totalGuests: 100, prevPerformance: 58, tenureMonths: 12 },
    'Di Fisher': { enhance: 0, enhanceGoal: 17, member: 0, memberGoal: 3, rebook: 6, hours: 20, eligibleGuests: 0, totalGuests: 40, prevPerformance: 18, tenureMonths: 3 },
    'Edward Franklin': { enhance: 1, enhanceGoal: 31, member: 0, memberGoal: 4, rebook: 16, hours: 52, eligibleGuests: 0, totalGuests: 140, prevPerformance: 50, tenureMonths: 10 },
    'Mariaelena Parra': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 0, hours: 8, eligibleGuests: 0, totalGuests: 15, prevPerformance: 10, tenureMonths: 2 },
    'Cheyenne Bringham': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 0, hours: 4, eligibleGuests: 0, totalGuests: 5, prevPerformance: 8, tenureMonths: 1 }
  },
  mar9: {
    'Angela McNally': { enhance: 2, enhanceGoal: 28, member: 0, memberGoal: 6, rebook: 18, hours: 48, eligibleGuests: 0, totalGuests: 120, prevPerformance: 55, tenureMonths: 14 },
    'Anna Mercadante': { enhance: 1, enhanceGoal: 25, member: 0, memberGoal: 4, rebook: 16, hours: 36, eligibleGuests: 0, totalGuests: 90, prevPerformance: 42, tenureMonths: 8 },
    'Madison Jeske': { enhance: 4, enhanceGoal: 25, member: 0, memberGoal: 3, rebook: 14, hours: 34, eligibleGuests: 0, totalGuests: 95, prevPerformance: 55, tenureMonths: 12 },
    'Di Fisher': { enhance: 0, enhanceGoal: 17, member: 0, memberGoal: 3, rebook: 4, hours: 18, eligibleGuests: 0, totalGuests: 35, prevPerformance: 15, tenureMonths: 3 },
    'Edward Franklin': { enhance: 1, enhanceGoal: 31, member: 0, memberGoal: 4, rebook: 14, hours: 50, eligibleGuests: 0, totalGuests: 135, prevPerformance: 48, tenureMonths: 10 },
    'Mariaelena Parra': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 0, hours: 6, eligibleGuests: 0, totalGuests: 10, prevPerformance: 8, tenureMonths: 2 },
    'Cheyenne Bringham': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 0, hours: 2, eligibleGuests: 0, totalGuests: 2, prevPerformance: 5, tenureMonths: 1 }
  },
  feb23: {
    'Angela McNally': { enhance: 1, enhanceGoal: 28, member: 0, memberGoal: 6, rebook: 16, hours: 46, eligibleGuests: 0, totalGuests: 115, prevPerformance: 52, tenureMonths: 14 },
    'Anna Mercadante': { enhance: 1, enhanceGoal: 25, member: 0, memberGoal: 4, rebook: 14, hours: 34, eligibleGuests: 0, totalGuests: 85, prevPerformance: 40, tenureMonths: 8 },
    'Madison Jeske': { enhance: 3, enhanceGoal: 25, member: 0, memberGoal: 3, rebook: 12, hours: 32, eligibleGuests: 0, totalGuests: 90, prevPerformance: 52, tenureMonths: 12 },
    'Di Fisher': { enhance: 0, enhanceGoal: 17, member: 0, memberGoal: 3, rebook: 2, hours: 16, eligibleGuests: 0, totalGuests: 30, prevPerformance: 12, tenureMonths: 3 },
    'Edward Franklin': { enhance: 0, enhanceGoal: 31, member: 0, memberGoal: 4, rebook: 12, hours: 48, eligibleGuests: 0, totalGuests: 130, prevPerformance: 45, tenureMonths: 10 },
    'Mariaelena Parra': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 0, hours: 4, eligibleGuests: 0, totalGuests: 5, prevPerformance: 5, tenureMonths: 2 },
    'Cheyenne Bringham': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 0, hours: 0, eligibleGuests: 0, totalGuests: 0, prevPerformance: 0, tenureMonths: 1 }
  },
  feb9: {
    'Angela McNally': { enhance: 1, enhanceGoal: 28, member: 0, memberGoal: 6, rebook: 14, hours: 44, eligibleGuests: 0, totalGuests: 110, prevPerformance: 50, tenureMonths: 14 },
    'Anna Mercadante': { enhance: 0, enhanceGoal: 25, member: 0, memberGoal: 4, rebook: 12, hours: 32, eligibleGuests: 0, totalGuests: 80, prevPerformance: 38, tenureMonths: 8 },
    'Madison Jeske': { enhance: 2, enhanceGoal: 25, member: 0, memberGoal: 3, rebook: 10, hours: 30, eligibleGuests: 0, totalGuests: 85, prevPerformance: 50, tenureMonths: 12 },
    'Di Fisher': { enhance: 0, enhanceGoal: 17, member: 0, memberGoal: 3, rebook: 0, hours: 14, eligibleGuests: 0, totalGuests: 25, prevPerformance: 10, tenureMonths: 3 },
    'Edward Franklin': { enhance: 0, enhanceGoal: 31, member: 0, memberGoal: 4, rebook: 10, hours: 46, eligibleGuests: 0, totalGuests: 125, prevPerformance: 42, tenureMonths: 10 },
    'Mariaelena Parra': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 0, hours: 2, eligibleGuests: 0, totalGuests: 2, prevPerformance: 2, tenureMonths: 2 },
    'Cheyenne Bringham': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 0, hours: 0, eligibleGuests: 0, totalGuests: 0, prevPerformance: 0, tenureMonths: 1 }
  },
  jan26: {
    'Angela McNally': { enhance: 0, enhanceGoal: 28, member: 0, memberGoal: 6, rebook: 12, hours: 42, eligibleGuests: 0, totalGuests: 105, prevPerformance: 48, tenureMonths: 14 },
    'Anna Mercadante': { enhance: 0, enhanceGoal: 25, member: 0, memberGoal: 4, rebook: 10, hours: 30, eligibleGuests: 0, totalGuests: 75, prevPerformance: 35, tenureMonths: 8 },
    'Madison Jeske': { enhance: 1, enhanceGoal: 25, member: 0, memberGoal: 3, rebook: 8, hours: 28, eligibleGuests: 0, totalGuests: 80, prevPerformance: 48, tenureMonths: 12 },
    'Di Fisher': { enhance: 0, enhanceGoal: 17, member: 0, memberGoal: 3, rebook: 0, hours: 12, eligibleGuests: 0, totalGuests: 20, prevPerformance: 8, tenureMonths: 3 },
    'Edward Franklin': { enhance: 0, enhanceGoal: 31, member: 0, memberGoal: 4, rebook: 8, hours: 44, eligibleGuests: 0, totalGuests: 120, prevPerformance: 40, tenureMonths: 10 },
    'Mariaelena Parra': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 0, hours: 0, eligibleGuests: 0, totalGuests: 0, prevPerformance: 0, tenureMonths: 2 },
    'Cheyenne Bringham': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 0, hours: 0, eligibleGuests: 0, totalGuests: 0, prevPerformance: 0, tenureMonths: 1 }
  },
  jan12: {
    'Angela McNally': { enhance: 0, enhanceGoal: 28, member: 0, memberGoal: 6, rebook: 10, hours: 40, eligibleGuests: 0, totalGuests: 100, prevPerformance: 45, tenureMonths: 14 },
    'Anna Mercadante': { enhance: 0, enhanceGoal: 25, member: 0, memberGoal: 4, rebook: 8, hours: 28, eligibleGuests: 0, totalGuests: 70, prevPerformance: 32, tenureMonths: 8 },
    'Madison Jeske': { enhance: 0, enhanceGoal: 25, member: 0, memberGoal: 3, rebook: 6, hours: 26, eligibleGuests: 0, totalGuests: 75, prevPerformance: 45, tenureMonths: 12 },
    'Di Fisher': { enhance: 0, enhanceGoal: 17, member: 0, memberGoal: 3, rebook: 0, hours: 10, eligibleGuests: 0, totalGuests: 15, prevPerformance: 5, tenureMonths: 3 },
    'Edward Franklin': { enhance: 0, enhanceGoal: 31, member: 0, memberGoal: 4, rebook: 6, hours: 42, eligibleGuests: 0, totalGuests: 115, prevPerformance: 38, tenureMonths: 10 },
    'Mariaelena Parra': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 0, hours: 0, eligibleGuests: 0, totalGuests: 0, prevPerformance: 0, tenureMonths: 2 },
    'Cheyenne Bringham': { enhance: 0, enhanceGoal: 11, member: 0, memberGoal: 2, rebook: 0, hours: 0, eligibleGuests: 0, totalGuests: 0, prevPerformance: 0, tenureMonths: 1 }
  }
};

// Function to initialize bonuses for all periods
function initializePeriodBonuses() {
  Object.keys(periodData).forEach(period => {
    Object.keys(periodData[period]).forEach(name => {
      const staffData = periodData[period][name];
      const bonusCalc = calculateBonus(staffData);
      periodData[period][name].bonus = bonusCalc.total;
    });
  });
}

// Call this function after periodData is defined
initializePeriodBonuses();

// Performance Trend Chart Function - Enhanced Version
function generateTrendChart(staffName) {
  const periods = ['jan12', 'jan26', 'feb9', 'feb23', 'mar9', 'mar23', 'apr6', 'apr20', 'may4', 'may18', 'jun1', 'jun15', 'jun29', 'jul13', 'jul27', 'aug10', 'current'];
  const periodLabels = ['Jan 12', 'Jan 26', 'Feb 9', 'Feb 23', 'Mar 9', 'Mar 23', 'Apr 6', 'Apr 20', 'May 4', 'May 18', 'Jun 1', 'Jun 15', 'Jun 29', 'Jul 13', 'Jul 27', 'Aug 10', 'Current'];
  
  const scores = periods.map(p => {
    if (periodData[p] && periodData[p][staffName]) {
      return calculatePerformanceScore(periodData[p][staffName]);
    }
    return 0;
  });
  
  const maxScore = Math.max(...scores, 100);
  const chartWidth = 800;
  const chartHeight = 300;
  const padding = 40;
  const usableWidth = chartWidth - (padding * 2);
  const usableHeight = chartHeight - (padding * 2);
  
  // Create path for area fill
  const areaPoints = scores.map((score, i) => {
    const x = (i * (usableWidth / (scores.length - 1))) + padding;
    const y = chartHeight - padding - ((score / maxScore) * usableHeight);
    return `${x},${y}`;
  }).join(' ');
  
  const areaPath = `${areaPoints} ${chartWidth - padding},${chartHeight - padding} ${padding},${chartHeight - padding}`;
  
  const chartHTML = `
    <div class="performance-chart-container" style="background: linear-gradient(135deg, #374151 0%, #4b5563 100%); padding: 30px; border-radius: 20px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); margin: 20px 0;">
      <h3 style="color: white; margin-bottom: 5px; font-size: 24px; font-weight: 700;">üìà Performance Trend</h3>
      <p style="color: rgba(255,255,255,0.8); font-size: 14px; margin-bottom: 20px;">Your journey over the last 17 pay periods</p>
      
      <svg width="100%" height="${chartHeight}" viewBox="0 0 ${chartWidth} ${chartHeight}" style="display: block;">
        <!-- Gradient definitions -->
        <defs>
          <linearGradient id="areaGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color:#4facfe;stop-opacity:0.8" />
            <stop offset="100%" style="stop-color:#00f2fe;stop-opacity:0.1" />
          </linearGradient>
          <linearGradient id="lineGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" style="stop-color:#4facfe" />
            <stop offset="100%" style="stop-color:#00f2fe" />
          </linearGradient>
          <filter id="glow">
            <feGaussianBlur stdDeviation="4" result="coloredBlur"/>
            <feMerge>
              <feMergeNode in="coloredBlur"/>
              <feMergeNode in="SourceGraphic"/>
            </feMerge>
          </filter>
        </defs>
        
        <!-- Grid lines -->
        ${[0, 25, 50, 75, 100].map(val => {
          const y = chartHeight - padding - ((val / maxScore) * usableHeight);
          return `
            <line x1="${padding}" y1="${y}" x2="${chartWidth - padding}" y2="${y}" 
                  stroke="rgba(255,255,255,0.1)" stroke-width="1"/>
            <text x="${padding - 10}" y="${y + 5}" font-size="11" fill="rgba(255,255,255,0.6)" text-anchor="end">${val}%</text>
          `;
        }).join('')}
        
        <!-- X-axis labels -->
        ${scores.map((score, i) => {
          const x = (i * (usableWidth / (scores.length - 1))) + padding;
          if (i % 2 === 0 || i === scores.length - 1) {
            return `
              <text x="${x}" y="${chartHeight - 15}" font-size="10" fill="rgba(255,255,255,0.6)" text-anchor="middle">
                ${periodLabels[i]}
              </text>
            `;
          }
          return '';
        }).join('')}
        
        <!-- Area fill -->
        <polygon points="${areaPath}" fill="url(#areaGradient)" opacity="0.6">
          <animate attributeName="opacity" from="0" to="0.6" dur="1s" fill="freeze"/>
        </polygon>
        
        <!-- The line -->
        <polyline points="${areaPoints}" 
                  fill="none" 
                  stroke="url(#lineGradient)" 
                  stroke-width="4"
                  stroke-linejoin="round"
                  stroke-linecap="round"
                  filter="url(#glow)">
          <animate attributeName="stroke-dasharray" from="0 1000" to="1000 0" dur="2s" fill="freeze"/>
        </polyline>
        
        <!-- Data points -->
        ${scores.map((score, i) => {
          const x = (i * (usableWidth / (scores.length - 1))) + padding;
          const y = chartHeight - padding - ((score / maxScore) * usableHeight);
          const isCurrentPeriod = i === scores.length - 1;
          const delay = i * 0.1;
          return `
            <g>
              <circle cx="${x}" cy="${y}" r="${isCurrentPeriod ? 8 : 5}" 
                      fill="${isCurrentPeriod ? '#00ff88' : 'white'}" 
                      stroke="${isCurrentPeriod ? 'white' : 'none'}" 
                      stroke-width="${isCurrentPeriod ? 3 : 0}"
                      opacity="0">
                <animate attributeName="opacity" from="0" to="1" dur="0.5s" begin="${delay}s" fill="freeze"/>
                <animate attributeName="r" from="0" to="${isCurrentPeriod ? 8 : 5}" dur="0.5s" begin="${delay}s" fill="freeze"/>
              </circle>
              ${isCurrentPeriod ? `
                <circle cx="${x}" cy="${y}" r="12" fill="none" stroke="#00ff88" stroke-width="2" opacity="0.5">
                  <animate attributeName="r" from="8" to="20" dur="2s" repeatCount="indefinite"/>
                  <animate attributeName="opacity" from="0.8" to="0" dur="2s" repeatCount="indefinite"/>
                </circle>
                <text x="${x}" y="${y - 15}" font-size="14" font-weight="bold" fill="#00ff88" text-anchor="middle">
                  ${score}%
                </text>
              ` : `
                <title>${periodLabels[i]}: ${score}%</title>
              `}
            </g>
          `;
        }).join('')}
        
        <!-- Trend indicator -->
        ${(() => {
          const recentScores = scores.slice(-3);
          const trend = recentScores[2] - recentScores[0];
          const trendColor = trend > 0 ? '#00ff88' : trend < 0 ? '#ff4757' : '#ffd93d';
          const trendSymbol = trend > 0 ? '‚Üë' : trend < 0 ? '‚Üì' : '‚Üí';
          return `
            <g transform="translate(${chartWidth - 100}, 30)">
              <rect x="-10" y="-20" width="90" height="35" rx="8" fill="rgba(0,0,0,0.3)"/>
              <text x="35" y="0" font-size="16" font-weight="bold" fill="${trendColor}" text-anchor="middle">
                ${trendSymbol} ${Math.abs(trend).toFixed(1)}%
              </text>
              <text x="35" y="-8" font-size="10" fill="rgba(255,255,255,0.6)" text-anchor="middle">TREND</text>
            </g>
          `;
        })()}
      </svg>
      
      <!-- Stats below chart -->
      <div style="display: flex; justify-content: space-around; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.2);">
        <div style="text-align: center;">
          <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 5px;">LOWEST</div>
          <div style="color: white; font-size: 20px; font-weight: bold;">${Math.min(...scores)}%</div>
        </div>
        <div style="text-align: center;">
          <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 5px;">AVERAGE</div>
          <div style="color: white; font-size: 20px; font-weight: bold;">${Math.round(scores.reduce((a,b) => a+b, 0) / scores.length)}%</div>
        </div>
        <div style="text-align: center;">
          <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 5px;">HIGHEST</div>
          <div style="color: white; font-size: 20px; font-weight: bold;">${Math.max(...scores)}%</div>
        </div>
        <div style="text-align: center;">
          <div style="color: rgba(255,255,255,0.6); font-size: 12px; margin-bottom: 5px;">CURRENT</div>
          <div style="color: #00ff88; font-size: 20px; font-weight: bold;">${scores[scores.length - 1]}%</div>
        </div>
      </div>
    </div>
  `;
  
  return chartHTML;
}

// CSV parser function
function parseCSV(text) {
  const lines = text.split('\n');
  const headers = lines[0].split(',').map(h => h.trim());
  const data = [];
  
  for (let i = 1; i < lines.length; i++) {
    if (lines[i].trim()) {
      const values = lines[i].split(',');
      const row = {};
      headers.forEach((header, index) => {
        row[header] = values[index] ? values[index].trim() : '';
      });
      data.push(row);
    }
  }
  return data;
}

// Utility functions
function showNotification(message, type) {
  const notification = document.createElement('div');
  notification.className = `notification ${type}`;
  notification.textContent = message;
  document.body.appendChild(notification);
  
  setTimeout(() => {
    notification.remove();
  }, 3000);
}

// Calculate conversion rate goal based on tenure
function getConversionGoal(tenureMonths) {
  if (tenureMonths >= 3) return 10.0;  // Standard goal for anyone over 3 months
  if (tenureMonths >= 2) return 7.0;   // Mid-range for 2-3 months
  return 5.0;  // New employee goal (under 2 months)
}

// Calculate fair enhancement goals based on hours worked and tenure
function calculateFairEnhancementGoal(hoursWorked, tenureMonths) {
  const enhancementsPerHour = 0.35;
  const calculatedGoal = Math.round(hoursWorked * enhancementsPerHour);
  
  // Apply minimums based on tenure
  if (tenureMonths >= 3) {
    return Math.max(calculatedGoal, 5); // Minimum 5 for experienced staff
  } else {
    return Math.max(calculatedGoal, 3); // Minimum 3 for new staff
  }
}

// Calculate true performance score with conversion-based metrics
function calculatePerformanceScore(data) {
  // Handle edge case: no hours worked
  if (!data.hours || data.hours === 0) {
    // Could still give points for memberships/enhancements if they exist from other periods
    // but for now, return 0 for no hours worked
    return 0;
  }
  
  const convGoal = getConversionGoal(data.tenureMonths);
  const actualConv = data.eligibleGuests > 0 ? 
    (data.member / data.eligibleGuests * 100) : 0;
  
  const convScore = Math.min((actualConv / convGoal) * 40, 40);
  const enhancePerHour = data.enhance / data.hours;
  const enhanceScore = Math.min(enhancePerHour * 60, 30);
  const rebookScore = Math.min((data.rebook / 20) * 20, 20);
  const productivityScore = Math.min(((data.member + data.enhance) / data.hours) * 10, 10);
  
  return Math.round(convScore + enhanceScore + rebookScore + productivityScore);
}

// Login functions
function loginStaff() {
  const name = document.getElementById('staffSelect').value;
  const password = document.getElementById('staffPassword').value;
  
  if (!name) {
    showNotification('Please select your name', 'error');
    return;
  }
  
  if (staffPasswords[name] === password) {
    currentUser = name;
    showStaffDashboard();
    showNotification(`Welcome, ${name}!`, 'success');
  } else {
    showNotification('Invalid Staff ID', 'error');
  }
}

function loginAdmin() {
  const password = document.getElementById('adminPassword').value;
  
  if (!password) {
    showNotification('Please enter password', 'error');
    return;
  }
  
  // Use Firebase authentication with your admin email and password
  auth.signInWithEmailAndPassword('admin@salesdashboard.com', password)
    .then((userCredential) => {
      currentUser = 'admin';
      showAdminDashboard();
      showNotification('Admin access granted', 'success');
    })
    .catch((error) => {
      console.error('Login error:', error.code, error.message);
      
      if (error.code === 'auth/wrong-password') {
        showNotification('Incorrect admin password', 'error');
      } else if (error.code === 'auth/user-not-found') {
        showNotification('Admin user not found - check Firebase setup', 'error');
      } else if (error.code === 'auth/invalid-email') {
        showNotification('Invalid email format', 'error');
      } else if (error.code === 'auth/too-many-requests') {
        showNotification('Too many failed attempts. Try again later.', 'error');
      } else {
        showNotification('Login failed: ' + error.message, 'error');
      }
    });
}
function showStaffDashboard() {
  document.getElementById('loginSection').classList.add('hidden');
  document.getElementById('staffView').classList.remove('hidden');
  document.getElementById('adminView').classList.add('hidden');
  
  const data = staffData[currentUser];
  
  document.getElementById('staffName').textContent = currentUser;
  document.getElementById('staffTitle').textContent = `Performance Dashboard - ${currentUser}`;
  document.getElementById('hoursWorked').textContent = `${data.hours} hrs`;

const convGoal = getConversionGoal(data.tenureMonths); 
const actualConv = data.eligibleGuests > 0 ? 
  (data.member / data.eligibleGuests * 100) : 0;
const adjustedEnhanceGoal = calculateFairEnhancementGoal(data.hours, data.tenureMonths);

document.getElementById('enhanceValue').textContent = data.enhance;
document.getElementById('enhanceAdjusted').textContent = adjustedEnhanceGoal;

const enhancePercent = Math.round((data.enhance / adjustedEnhanceGoal) * 100);
const enhanceStatus = document.getElementById('enhanceStatus');
const enhanceMessage = document.getElementById('enhanceMessage');
// ... rest of the function continues
  
  if (enhancePercent >= 100) {
    enhanceStatus.textContent = '100% - Goal Achieved!';
    enhanceStatus.className = 'status-badge status-green';
    enhanceMessage.textContent = 'Excellent work!';
  } else if (enhancePercent >= 75) {
  enhanceStatus.textContent = `${enhancePercent}% - Almost There!`;
  enhanceStatus.className = 'status-badge status-green';
  enhanceMessage.textContent = `Keep pushing!`;
} else {
  enhanceStatus.textContent = `${enhancePercent}% of adjusted goal`;
  enhanceStatus.className = 'status-badge status-yellow';
  enhanceMessage.textContent = `Focus on enhancements`;
}
  document.getElementById('memberValue').textContent = data.member;
  document.getElementById('convGoal').textContent = `${convGoal}%`;
  document.getElementById('convActual').textContent = `${actualConv.toFixed(1)}%`;
  document.getElementById('eligibleGuestsCount').textContent = data.eligibleGuests;
  
  const convPercent = Math.round((actualConv / convGoal) * 100);
  const memberStatus = document.getElementById('memberStatus');
  const memberMessage = document.getElementById('memberMessage');
  
  if (convPercent >= 100) {
    memberStatus.textContent = 'Conversion Goal Met!';
    memberStatus.className = 'status-badge status-green';
    memberMessage.textContent = `Exceeding ${convGoal}% target!`;
  } else if (convPercent >= 75) {
    memberStatus.textContent = `${convPercent}% of Goal`;
    memberStatus.className = 'status-badge status-yellow';
    memberMessage.textContent = `Close to ${convGoal}% target`;
  } else {
    memberStatus.textContent = `${convPercent}% of Goal`;
    memberStatus.className = 'status-badge status-red';
    memberMessage.textContent = `Target: ${convGoal}% conversion`;
  }
  
  document.getElementById('rebookValue').textContent = `${data.rebook}%`;
  document.getElementById('totalGuestsServed').textContent = data.totalGuests;
  const rebookStatus = document.getElementById('rebookStatus');
  const rebookMessage = document.getElementById('rebookMessage');
  
  if (data.rebook >= 20) {
    rebookStatus.textContent = 'Target Met!';
    rebookStatus.className = 'status-badge status-green';
    rebookMessage.textContent = 'Great client relationships!';
  } else {
    rebookStatus.textContent = 'Below Target';
    rebookStatus.className = 'status-badge status-yellow';
    rebookMessage.textContent = 'Focus on follow-ups';
  }
  
  const performanceScore = calculatePerformanceScore(data);
  document.getElementById('overallValue').textContent = `${performanceScore}%`;
  const overallStatus = document.getElementById('overallStatus');
  const overallMessage = document.getElementById('overallMessage');
  
  const trend = performanceScore - data.prevPerformance;
  const trendElement = document.getElementById('performanceTrend');
  if (trend > 0) {
    trendElement.innerHTML = `<span class="trend-up">‚Üë ${trend}%</span>`;
  } else if (trend < 0) {
    trendElement.innerHTML = `<span class="trend-down">‚Üì ${Math.abs(trend)}%</span>`;
  } else {
    trendElement.innerHTML = `<span class="trend-neutral">‚Üí 0%</span>`;
  }
  
  if (performanceScore >= 80) {
    overallStatus.textContent = 'Excellent!';
    overallStatus.className = 'status-badge status-green';
    overallMessage.textContent = 'Top performer!';
  } else if (performanceScore >= 60) {
    overallStatus.textContent = 'Good Work!';
    overallStatus.className = 'status-badge status-green';
    overallMessage.textContent = 'Above average';
  } else {
    overallStatus.textContent = 'Room to Grow';
    overallStatus.className = 'status-badge status-yellow';
    overallMessage.textContent = 'Keep improving';
  }
  
  
  updateComparisonTable(data);
  
 const bonusCalc = calculateBonus(data);
const enhanceBonus = bonusCalc.enhanceBonus;
const membershipBonus = bonusCalc.membershipBonus;
const performanceBonus = bonusCalc.performanceBonus;
const totalBonus = bonusCalc.total;
  
  document.getElementById('totalBonus').textContent = `${totalBonus.toFixed(2)}`;
  document.getElementById('enhanceBonus').textContent = `${enhanceBonus.toFixed(2)}`;
  document.getElementById('membershipBonus').textContent = `${membershipBonus.toFixed(2)}`;
  document.getElementById('performanceBonus').textContent = `${performanceBonus.toFixed(2)}`;

// Add the trend chart
  const chartContainer = document.getElementById('performanceTrendChart');
  if (chartContainer) {
    chartContainer.innerHTML = generateTrendChart(currentUser);
  }
  
  generatePerformanceTips(data, actualConv, convGoal);
}
// Tab switching function
function switchTab(tab) {
  const performanceTab = document.getElementById('performanceTab');
  const achievementsTab = document.getElementById('achievementsTab');
  const tabButtons = document.querySelectorAll('.tab-btn');
  
  if (tab === 'performance') {
    performanceTab.style.display = 'block';
    achievementsTab.style.display = 'none';
    tabButtons[0].classList.add('active');
    tabButtons[1].classList.remove('active');
    tabButtons[0].style.borderBottom = '3px solid #007bff';
    tabButtons[1].style.borderBottom = '3px solid transparent';
  } else if (tab === 'achievements') {
    performanceTab.style.display = 'none';
    achievementsTab.style.display = 'block';
    tabButtons[0].classList.remove('active');
    tabButtons[1].classList.add('active');
    tabButtons[0].style.borderBottom = '3px solid transparent';
    tabButtons[1].style.borderBottom = '3px solid #007bff';
    loadTeamAchievements();
  }
}

function updateComparisonTable(userData) {
  const allStaff = Object.values(staffData);
  
  const avgConv = allStaff.reduce((sum, s) => {
    return sum + (s.eligibleGuests > 0 ? (s.member / s.eligibleGuests * 100) : 0);
  }, 0) / allStaff.length;
  
  const avgMemPerHour = allStaff.reduce((sum, s) => sum + (s.member / s.hours), 0) / allStaff.length;
  const avgEnhPerHour = allStaff.reduce((sum, s) => sum + (s.enhance / s.hours), 0) / allStaff.length;
  const avgRebook = allStaff.reduce((sum, s) => sum + s.rebook, 0) / allStaff.length;
  
  const topConv = Math.max(...allStaff.map(s => s.eligibleGuests > 0 ? (s.member / s.eligibleGuests * 100) : 0));
  const topMemPerHour = Math.max(...allStaff.map(s => s.member / s.hours));
  const topEnhPerHour = Math.max(...allStaff.map(s => s.enhance / s.hours));
  const topRebook = Math.max(...allStaff.map(s => s.rebook));
  
  const yourConv = userData.eligibleGuests > 0 ? (userData.member / userData.eligibleGuests * 100) : 0;
  document.getElementById('yourConv').textContent = `${yourConv.toFixed(1)}%`;
  document.getElementById('avgConv').textContent = `${avgConv.toFixed(1)}%`;
  document.getElementById('topConv').textContent = `${topConv.toFixed(1)}%`;
  
  document.getElementById('yourMemPerHour').textContent = (userData.member / userData.hours).toFixed(3);
  document.getElementById('avgMemPerHour').textContent = avgMemPerHour.toFixed(3);
  document.getElementById('topMemPerHour').textContent = topMemPerHour.toFixed(3);
  
  document.getElementById('yourEnhPerHour').textContent = (userData.enhance / userData.hours).toFixed(3);
  document.getElementById('avgEnhPerHour').textContent = avgEnhPerHour.toFixed(3);
  document.getElementById('topEnhPerHour').textContent = topEnhPerHour.toFixed(3);
  
  document.getElementById('yourRebook').textContent = `${userData.rebook}%`;
  document.getElementById('avgRebook').textContent = `${Math.round(avgRebook)}%`;
  document.getElementById('topRebook').textContent = `${topRebook}%`;
}

function generatePerformanceTips(data, actualConv, convGoal) {
  const tips = [];
  
  if (actualConv < convGoal) {
    tips.push(`Focus on conversion: Your target is ${convGoal}%, currently at ${actualConv.toFixed(1)}%`);
    tips.push('Identify eligible guests early and tailor your approach');
  }
  
  if (data.rebook < 20) {
    tips.push('Build stronger connections - ask about future visit plans');
    tips.push('Follow up with guests after their experience');
  }
  
  if (data.enhance / data.hours < 0.2) {
    tips.push('Aim for at least one enhancement every 5 hours worked');
    tips.push('Identify enhancement opportunities during initial consultations');
  }
  
  if (data.hours < 60) {
    tips.push('Consider picking up additional shifts to increase opportunities');
  }
  
  if (tips.length === 0) {
    tips.push('You\'re performing well! Keep maintaining your high standards');
    tips.push('Consider mentoring newer team members');
  }
  
  document.getElementById('performanceTips').innerHTML = tips.map(tip => `<li>${tip}</li>`).join('');
  document.getElementById('quickActionsPanel').style.display = 'block';  // ADD THIS LINE
}  // This closes showStaffDashboard

function showAdminDashboard() { 
  document.getElementById('loginSection').classList.add('hidden');
  document.getElementById('staffView').classList.add('hidden');
  document.getElementById('adminView').classList.remove('hidden');
  
  const staffArray = Object.values(staffData);
  const totalHours = staffArray.reduce((sum, s) => sum + s.hours, 0);
  
  const avgConv = staffArray.reduce((sum, s) => {
    return sum + (s.eligibleGuests > 0 ? (s.member / s.eligibleGuests * 100) : 0);
  }, 0) / staffArray.length;
  
  const avgRebook = Math.round(staffArray.reduce((sum, s) => sum + s.rebook, 0) / staffArray.length);
  const totalBonus = staffArray.reduce((sum, s) => {
    const bonusCalc = calculateBonus(s);
    return sum + bonusCalc.total;
  }, 0);
  
  document.getElementById('totalHours').textContent = totalHours;
  document.getElementById('avgConvAdmin').textContent = `${avgConv.toFixed(1)}%`;
  document.getElementById('avgRebookAdmin').textContent = `${avgRebook}%`;
  document.getElementById('totalTeamBonus').textContent = `$${totalBonus.toFixed(2)}`;
  
  const performers = Object.entries(staffData)
    .map(([name, data]) => ({ name, score: calculatePerformanceScore(data) }))
    .sort((a, b) => b.score - a.score)
    .slice(0, 3);
  
  document.getElementById('topPerformers').innerHTML = performers
    .map((p, i) => `<li>${p.name} (${p.score}%)</li>`)
    .join('');
  
  let tableHTML = '';
  Object.entries(staffData).forEach(([name, data]) => {
    const performance = calculatePerformanceScore(data);
    const actualConv = data.eligibleGuests > 0 ? 
      (data.member / data.eligibleGuests * 100) : 0;
    const convGoal = getConversionGoal(data.tenureMonths);
    const adjustedEnhanceGoal = calculateFairEnhancementGoal(data.hours, data.tenureMonths);
    
    const bonusCalc = calculateBonus(data);
    
    tableHTML += `
    <tr>
      <td>${name}</td>
      <td>${data.hours}</td>
      <td>${data.member}</td>
      <td style="font-weight: bold; color: ${actualConv >= convGoal ? '#28a745' : '#dc3545'}">
        ${actualConv.toFixed(1)}%
      </td>
      <td>${convGoal}%</td>
      <td style="color: ${data.enhance >= adjustedEnhanceGoal ? '#28a745' : '#dc3545'}">
        ${data.enhance}
      </td>
      <td>${adjustedEnhanceGoal}</td>
      <td>20%</td>
      <td style="color: ${data.rebook >= 20 ? '#28a745' : '#dc3545'}">${data.rebook}%</td>
      <td>$${bonusCalc.total.toFixed(2)}</td>
      <td>
        <div class="performance-bar">
          <div class="performance-fill" style="width: ${performance}%"></div>
        </div>
        ${performance}%
      </td>
    </tr>`;
  });
  
  document.getElementById('teamTableBody').innerHTML = tableHTML;
  document.getElementById('quickActionsPanel').style.display = 'block';
  updateUploadTimestamps();  // THIS IS THE NEW LINE ADDED
}

function changeStaffPeriod() {
  const selector = document.getElementById('staffPeriodSelector');
  const selectedPeriod = selector.value;
  currentPeriod = selectedPeriod;
  
  const periodText = selector.options[selector.selectedIndex].text;
  document.getElementById('staffPeriodDisplay').textContent = periodText;
  document.getElementById('bonusPeriodDisplay').textContent = periodText;
  
  if (periodData[selectedPeriod] && periodData[selectedPeriod][currentUser]) {
    staffData[currentUser] = { ...periodData[selectedPeriod][currentUser] };
    showStaffDashboard();
    showNotification(`Viewing: ${periodText}`, 'success');
  } else {
    showNotification('No data available for this period', 'error');
  }
}

function changePeriod() {
  const selector = document.getElementById('periodSelector');
  const selectedPeriod = selector.value;
  currentPeriod = selectedPeriod;
  
  if (periodData[selectedPeriod]) {
    Object.keys(periodData[selectedPeriod]).forEach(name => {
      staffData[name] = { ...periodData[selectedPeriod][name] };
    });
    
    showAdminDashboard();
    
    const periodText = selector.options[selector.selectedIndex].text;
    showNotification(`Viewing: ${periodText}`, 'success');
  } else {
    showNotification('No data available for this period', 'error');
  }
}

// CSV Upload handlers
function handleAppointmentUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    uploadedData.appointments = e.target.result;
    uploadTimestamps.appointments = new Date().toISOString();  // ADD THIS
    updateUploadTimestamps();  // ADD THIS
    showNotification('Appointment data loaded', 'success');
  };
  reader.readAsText(file);
}

function handleMembershipUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    uploadedData.memberships = e.target.result;
    uploadTimestamps.memberships = new Date().toISOString();  // ADD THIS
    updateUploadTimestamps();  // ADD THIS
    showNotification('Membership data loaded', 'success');
  };
  reader.readAsText(file);
}

function handleSalesUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    uploadedData.sales = e.target.result;
    uploadTimestamps.sales = new Date().toISOString();  // ADD THIS
    updateUploadTimestamps();  // ADD THIS
    showNotification('Sales data loaded', 'success');
  };
  reader.readAsText(file);
}

function handleOOTUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    uploadedData.oot = e.target.result;
    uploadTimestamps.oot = new Date().toISOString();  // ADD THIS
    updateUploadTimestamps();  // ADD THIS
    showNotification('OOT data loaded', 'success');
  };
  reader.readAsText(file);
}

function handlePayrollUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    uploadedData.payroll = e.target.result;
    uploadTimestamps.payroll = new Date().toISOString();  // ADD THIS
    updateUploadTimestamps();  // ADD THIS
    payrollData = parseCSV(e.target.result);
    extractPayPeriods();
    showNotification('Payroll hours data loaded', 'success');
  };
  reader.readAsText(file);
}
// Handle bonus structure CSV upload
function handleBonusUpload(event) {
  const file = event.target.files[0];
  if (!file) return;
  
  const reader = new FileReader();
  reader.onload = function(e) {
    uploadedData.bonusStructure = e.target.result;
    localStorage.setItem('bonusStructure', e.target.result);
    
    try {
      const bonusData = parseCSV(e.target.result);
      updateBonusRates(bonusData);
      
// Update button to show loaded state
const btn = document.getElementById('bonusUploadBtn');
if (btn) {
  btn.style.background = '#e8f5e9';
  btn.style.borderColor = '#4caf50';
  btn.innerHTML = 
    '<span style="font-size: 16px;">üíµ</span>' +
    '<span>Bonus Structure ‚úì</span>' +
    '<span style="margin-left: auto; color: #4caf50; font-size: 12px;">LOADED</span>';
}
      showNotification('Bonus structure loaded and saved', 'success');
    } catch (error) {
      showNotification('Error loading bonus structure: ' + error.message, 'error');
    }
  };
  reader.readAsText(file);
}

// Update bonus rates from CSV data
function updateBonusRates(bonusData) {
  // Clear and rebuild rates
  BONUS_RATES = {
    enhancement: {},
    membership: {},
    performanceBonus: 0
  };
  
  bonusData.forEach(row => {
    const bonusType = (row['Bonus Type'] || '').toLowerCase().trim();
    const tier = parseInt(row['Tier'] || 0);
    const rate = parseFloat(row['Rate'] || 0);
    
    if (bonusType === 'enhancement' && tier) {
      BONUS_RATES.enhancement[`tier${tier}`] = rate;
    } else if (bonusType === 'membership' && tier) {
      BONUS_RATES.membership[`tier${tier}`] = rate;
    } else if (bonusType === 'performance') {
      BONUS_RATES.performanceBonus = rate;
    }
  });
  
  console.log('Updated bonus rates:', BONUS_RATES);
  
  // Only recalculate if we have data loaded
  if (staffData && Object.keys(staffData).length > 0) {
    recalculateAllBonuses();
  }
}

// Recalculate all bonuses with new rates
function recalculateAllBonuses() {
  // Recalculate current staff data
  if (typeof staffData !== 'undefined' && staffData) {
    Object.keys(staffData).forEach(name => {
      if (typeof calculateBonus === 'function') {
        const bonusCalc = calculateBonus(staffData[name]);
        staffData[name].bonus = bonusCalc.total;
      }
    });
  }
  
  // Recalculate period data
  if (typeof periodData !== 'undefined' && periodData) {
    Object.keys(periodData).forEach(period => {
      if (periodData[period]) {
        Object.keys(periodData[period]).forEach(name => {
          if (typeof calculateBonus === 'function') {
            const bonusCalc = calculateBonus(periodData[period][name]);
            periodData[period][name].bonus = bonusCalc.total;
          }
        });
      }
    });
  }
  
  // Refresh current view
  if (typeof currentUser !== 'undefined') {
    if (currentUser === 'admin') {
      if (typeof showAdminDashboard === 'function') {
        showAdminDashboard();
      }
    } else if (currentUser && currentUser !== 'admin') {
      if (typeof showStaffDashboard === 'function') {
        showStaffDashboard();
      }
    }
  }
  
  showNotification('All bonuses recalculated with new rates', 'info');
}

function extractPayPeriods() {
  const uniquePeriods = new Set();
  payPeriods = [];
  
  if (!payrollData) return;
  
  payrollData.forEach(row => {
    const key = `${row['Period Start']}_${row['Period End']}`;
    if (!uniquePeriods.has(key) && row['Period Start'] && row['Period End']) {
      uniquePeriods.add(key);
      payPeriods.push({
        start: new Date(row['Period Start']),
        end: new Date(row['Period End']),
        label: `${row['Period Start']} - ${row['Period End']}`,
        startStr: row['Period Start'],
        endStr: row['Period End']
      });
    }
  });
  
  payPeriods.sort((a, b) => b.start - a.start);
  updatePayPeriodDropdown();
}

function updatePayPeriodDropdown() {
  const dropdown = document.getElementById('payPeriodSelect');
  const filterDiv = document.getElementById('payPeriodFilter');
  
  if (!dropdown || !filterDiv) return;
  
  dropdown.innerHTML = '<option value="all">All Periods</option>';
  
  if (payPeriods.length > 0) {
    payPeriods.forEach((period, index) => {
      dropdown.innerHTML += `<option value="${index}">${period.label}</option>`;
    });
    filterDiv.style.display = 'block';
  }
}

function filterByPayPeriod(value) {
  if (value === 'all') {
    processAllData();
    return;
  }
  
  const index = parseInt(value);
  if (index >= 0 && index < payPeriods.length) {
    const period = payPeriods[index];
    showNotification(`Filtering data for period: ${period.label}`, 'success');
    processFilteredData(period);
  }
}
function processFilteredData(period) {
  parsedAppointments = uploadedData.appointments ? parseCSV(uploadedData.appointments) : null;
  parsedMemberships = uploadedData.memberships ? parseCSV(uploadedData.memberships) : null;
  parsedSales = uploadedData.sales ? parseCSV(uploadedData.sales) : null;
  parsedOOT = uploadedData.oot ? parseCSV(uploadedData.oot) : null;
  
  const startDate = period.start;
  const endDate = period.end;
  
  const filteredSales = parsedSales ? 
    parsedSales.filter(row => {
      const rowDate = parseDateConsistent(row['Sale Date']);
      return rowDate >= startDate && rowDate <= endDate;
    }) : [];
  
  const filteredOOT = parsedOOT ? 
    parsedOOT.filter(row => {
      const rowDate = parseDateConsistent(row['Sales Date']);
      return rowDate >= startDate && rowDate <= endDate;
    }) : [];
  
  const filteredMemberships = parsedMemberships ? 
    parsedMemberships.filter(row => {
      const rowDate = parseDateConsistent(row['Sale Date']);
      return rowDate >= startDate && rowDate <= endDate;
    }) : [];
  
  const filteredPayroll = payrollData ? 
    payrollData.filter(row => {
      const rowStart = parseDateConsistent(row['Period Start']);
      return rowStart >= startDate && rowStart <= endDate;
    }) : [];
  
  const ootInvoices = new Set(filteredOOT.map(row => row['Invoice No']));
  // Process each staff member
  Object.keys(staffData).forEach(staffName => {
    
  const membershipsSold = filteredMemberships
      .filter(row => row['Sold By'] === staffName)
      .length;
    
    const staffSales = filteredSales.filter(row => row['ClosedBy'] === staffName);
    
    const eligibleGuests = staffSales.filter(row => {
      const isExistingMember = row['Member'] === 'Yes' || row['Member'] === 'TRUE';
      const isOOT = ootInvoices.has(row['Invoice No']);
      return !isExistingMember && !isOOT;
    }).length;
    
  // Count only Enhancement sales (not Massage)
      const enhancements = staffSales.filter(row => {
  const category = (row['Category'] || '').trim().toLowerCase();
  // Match any category that starts with 'enhancement'
  return category.startsWith('enhancement');
}).length;

const staffHours = filteredPayroll
  .filter(row => row['Name'] === staffName)
  .reduce((sum, row) => {
    // Handle empty or invalid hours values
    const hours = row['Hourly Hours'];
    if (hours === '' || hours === null || hours === undefined) {
      return sum; // Skip empty values
    }
    const parsedHours = parseFloat(hours);
    return sum + (isNaN(parsedHours) ? 0 : parsedHours);
  }, 0);
    
    // Recalculate enhancement goal using fair system
staffData[staffName].enhanceGoal = calculateFairEnhancementGoal(staffData[staffName].hours, staffData[staffName].tenureMonths);
const bonusCalc = calculateBonus(staffData[staffName]);
staffData[staffName].bonus = bonusCalc.total;
  });  // <- This line stays as is, it closes the forEach
  
  showAdminDashboard();
showNotification(`Data updated for period: ${period.label}`, 'success');
}  // <- This closes the processFilteredData function

function validateCSVColumns(data, requiredColumns, dataType) {
  if (!data || data.length === 0) {
    showNotification(`No ${dataType} data found`, 'error');
    return false;
  }
  
  const actualColumns = Object.keys(data[0]);
  const missing = requiredColumns.filter(col => !actualColumns.includes(col));
  
  if (missing.length > 0) {
    showNotification(`Missing columns in ${dataType}: ${missing.join(', ')}`, 'error');
    console.error(`${dataType} has columns:`, actualColumns);
    console.error(`Missing required:`, missing);
    return false;
  }
  
  return true;
}

function processAllData() {
  if (!uploadedData.appointments && !uploadedData.memberships && !uploadedData.sales && !uploadedData.oot) {
    showNotification('Please upload at least one data file first', 'error');
    return;
  }
  
  // Clear previous periodData to prevent memory leak
  Object.keys(periodData).forEach(period => {
    periodData[period] = {};
  });
  
  parsedAppointments = uploadedData.appointments ? parseCSV(uploadedData.appointments) : null;
  parsedMemberships = uploadedData.memberships ? parseCSV(uploadedData.memberships) : null;
  parsedSales = uploadedData.sales ? parseCSV(uploadedData.sales) : null;
  parsedOOT = uploadedData.oot ? parseCSV(uploadedData.oot) : null;
  
  const validations = [
    {
      data: parsedSales,
      columns: ['Sale Date', 'ClosedBy', 'Invoice No', 'Category', 'Member'],
      type: 'Sales'
    },
    {
      data: parsedMemberships,
      columns: ['Sale Date', 'Sold By'],
      type: 'Memberships'
    },
    {
      data: parsedOOT,
      columns: ['Sales Date', 'Invoice No'],
      type: 'OOT'
    }
  ];
    
  // Validate each data source if it exists
  validations.forEach(validation => {
    if (validation.data && !validateCSVColumns(validation.data, validation.columns, validation.type)) {
      console.error(`Validation failed for ${validation.type}`);
    }
  });

  // Define period ranges for processing
  const periodRanges = {
    current: { start: new Date('2025-08-24'), end: new Date('2025-09-06') },
    aug10: { start: new Date('2025-08-10'), end: new Date('2025-08-23') },
    jul27: { start: new Date('2025-07-27'), end: new Date('2025-08-09') },
    jul13: { start: new Date('2025-07-13'), end: new Date('2025-07-26') },
    jun29: { start: new Date('2025-06-29'), end: new Date('2025-07-12') },
    jun15: { start: new Date('2025-06-15'), end: new Date('2025-06-28') },
    jun1: { start: new Date('2025-06-01'), end: new Date('2025-06-14') },
    may18: { start: new Date('2025-05-18'), end: new Date('2025-05-31') },
    may4: { start: new Date('2025-05-04'), end: new Date('2025-05-17') },
    apr20: { start: new Date('2025-04-20'), end: new Date('2025-05-03') },
    apr6: { start: new Date('2025-04-06'), end: new Date('2025-04-19') },
    mar23: { start: new Date('2025-03-23'), end: new Date('2025-04-05') },
    mar9: { start: new Date('2025-03-09'), end: new Date('2025-03-22') },
    feb23: { start: new Date('2025-02-23'), end: new Date('2025-03-08') },
    feb9: { start: new Date('2025-02-09'), end: new Date('2025-02-22') },
    jan26: { start: new Date('2025-01-26'), end: new Date('2025-02-08') },
    jan12: { start: new Date('2025-01-12'), end: new Date('2025-01-25') }
  };

  // Process data for each period
  Object.keys(periodRanges).forEach(periodKey => {
    const period = periodRanges[periodKey];
    const periodStaffData = {};
    
    // Filter data for this period
const periodSales = parsedSales ? 
  parsedSales.filter(row => {
    const rowDate = parseDateConsistent(row['Sale Date']);
    return rowDate >= period.start && rowDate <= period.end;  // Changed < to <=
  }) : [];

const periodOOT = parsedOOT ? 
  parsedOOT.filter(row => {
    const rowDate = parseDateConsistent(row['Sales Date']);
    return rowDate >= period.start && rowDate <= period.end;  // Changed < to <=
  }) : [];

const periodMemberships = parsedMemberships ? 
  parsedMemberships.filter(row => {
    const rowDate = parseDateConsistent(row['Sale Date']);
    if (!rowDate) return false;
    return rowDate >= period.start && rowDate <= period.end;  // Changed < to <=
  }) : [];
    
 const periodPayroll = payrollData ? 
  payrollData.reduce((acc, row) => {
    // First check if this is one of your known staff
    if (!Object.keys(staffData).includes(row['Name'])) {
      return acc; // Skip unknown staff members
    }
    
    const rowStart = parseDateConsistent(row['Period Start']);
    const rowEnd = parseDateConsistent(row['Period End']);
    
    if (!rowStart || !rowEnd) return acc;
    
    const periodStart = period.start.getTime();
    const periodEnd = period.end.getTime();
    const payStart = rowStart.getTime();
    const payEnd = rowEnd.getTime();
    
    // Check if pay period overlaps with the analysis period
    if (payStart <= periodEnd && payEnd >= periodStart) {
      // Calculate the actual overlap
      const overlapStart = Math.max(payStart, periodStart);
      const overlapEnd = Math.min(payEnd, periodEnd);
      const payPeriodDuration = payEnd - payStart;
      const overlapDuration = overlapEnd - overlapStart;
      
      // Only include if there's actual overlap and valid duration
      if (payPeriodDuration > 0 && overlapDuration > 0) {
        const proportion = overlapDuration / payPeriodDuration;
        
        // Handle empty hours gracefully
        const hourlyHours = row['Hourly Hours'] === '' || row['Hourly Hours'] === null || row['Hourly Hours'] === undefined 
          ? 0 
          : parseFloat(row['Hourly Hours']) || 0;
        
        acc.push({
          ...row,
          // Adjust numeric fields proportionally
          'Hourly Hours': hourlyHours * proportion,
          // Keep metadata for transparency
          '_original_hours': row['Hourly Hours'],
          '_is_prorated': proportion < 1,
          '_prorate_ratio': proportion
        });
      }
    }
    
    return acc;
  }, []) : [];
    
    const ootInvoices = new Set(periodOOT.map(row => row['Invoice No']));
    
    // Calculate data for each staff member for this period
    Object.keys(staffData).forEach(staffName => {
      const staffHours = periodPayroll
        .filter(row => row['Name'] === staffName)
        .reduce((sum, row) => sum + parseFloat(row['Hourly Hours'] || 0), 0);
      
      const membershipsSold = periodMemberships
        .filter(row => row['Sold By'] === staffName)
        .length;
      
      const staffSales = periodSales.filter(row => row['ClosedBy'] === staffName);
      
      const eligibleGuests = staffSales.filter(row => {
  const isExistingMember = row['Member'] === 'Yes' || row['Member'] === 'TRUE';
  const isOOT = ootInvoices.has(row['Invoice No']);
  return !isExistingMember && !isOOT;
}).length;

// Count only Enhancement sales (not Massage) - includes ALL guests (local, OOT, members, non-members)
const enhancementRows = staffSales.filter(row => {
  const category = (row['Category'] || '').trim().toLowerCase();
  // Use startsWith to catch "enhancement", "enhancements", etc.
  return category.startsWith('enhancement');
});

const enhancements = enhancementRows.length;
      
// Keep existing goals and tenure from original data
const originalData = periodData[periodKey] && periodData[periodKey][staffName] ? 
  periodData[periodKey][staffName] : staffData[staffName];

// Build the updated data, preserving original values when no new data exists
periodStaffData[staffName] = {
  enhance: enhancements,
  enhanceGoal: calculateFairEnhancementGoal(
    staffHours > 0 ? staffHours : originalData.hours,
    originalData.tenureMonths || 6
  ),
  member: membershipsSold,
  memberGoal: originalData.memberGoal || 2,
  rebook: originalData.rebook || 0,
  hours: staffHours > 0 ? Math.round(staffHours) : originalData.hours,
  eligibleGuests: eligibleGuests,
  totalGuests: staffSales.length,
  prevPerformance: originalData.prevPerformance || 0,
  tenureMonths: originalData.tenureMonths || 6
};
      
  // Calculate bonus for this period using the actual values
const bonusCalc = calculateBonus(periodStaffData[staffName]);  
periodStaffData[staffName].bonus = bonusCalc.total;           
});
    
    // Update periodData with calculated values
    periodData[periodKey] = periodStaffData;
  });
  
  // Update current staffData with current period only if it has valid data
  if (periodData.current && Object.keys(periodData.current).length > 0) {
    // Check if the processed data has valid values before overwriting
    let hasValidData = false;
    Object.values(periodData.current).forEach(staff => {
      if (staff.hours > 0 || staff.enhance > 0) {
        hasValidData = true;
      }
    });
    
    if (hasValidData) {
      staffData = { ...periodData.current };
    } else {
      console.log('Warning: Processed data appears to be empty, keeping original data');
    }
  }
  
  showAdminDashboard();
  showNotification('All periods processed from CSV data!', 'success');
}
function logout() {
  currentUser = null;
  currentPeriod = 'current';
  document.getElementById('loginSection').classList.remove('hidden');
  document.getElementById('staffView').classList.add('hidden');
  document.getElementById('adminView').classList.add('hidden');
  
  document.getElementById('staffSelect').value = '';
  document.getElementById('staffPassword').value = '';
  document.getElementById('adminPassword').value = '';
  
  uploadedData = {
    appointments: null,
    memberships: null,
    sales: null,
    oot: null,
    payroll: null
  };
  const quickPanel = document.getElementById('quickActionsPanel');
  if (quickPanel) quickPanel.style.display = 'none';
  
  stopAutoSave();  
  clearAutoSave();
  
  showNotification('Logged out successfully', 'success');
}
const AUTO_SAVE_KEY = 'dashboardAutoSave';
const AUTO_SAVE_INTERVAL = 30000;
let autoSaveTimer = null;

function autoSaveUploads() {
  try {
    const saveData = {
      timestamp: new Date().toISOString(),
      uploadedData: uploadedData,
      staffData: staffData,
      periodData: periodData,
      currentPeriod: currentPeriod,
      payrollData: payrollData,
      payPeriods: payPeriods
    };
    
    const jsonString = JSON.stringify(saveData);
    sessionStorage.setItem(AUTO_SAVE_KEY, jsonString);
    console.log('Auto-saved at', new Date().toLocaleTimeString());
    
  } catch (error) {
    console.error('Auto-save failed:', error);
  }
}

function restoreAutoSave() {
  try {
    const saved = sessionStorage.getItem(AUTO_SAVE_KEY);
    
    if (!saved) {
      showNotification('No auto-saved data found', 'info');
      return false;
    }
    
    const saveData = JSON.parse(saved);
    const savedTime = new Date(saveData.timestamp);
    const hoursSince = (Date.now() - savedTime) / 3600000;
    
    if (hoursSince < 24) {
      const timeString = savedTime.toLocaleString();
      const restore = confirm(`Found auto-saved data from ${timeString}. Would you like to restore it?`);
      
      if (restore) {
        uploadedData = saveData.uploadedData || {
          appointments: null,
          memberships: null,
          sales: null,
          oot: null,
          payroll: null
        };
        
        staffData = saveData.staffData || staffData;
        periodData = saveData.periodData || periodData;
        currentPeriod = saveData.currentPeriod || 'current';
        payrollData = saveData.payrollData || null;
        payPeriods = saveData.payPeriods || [];
        
        if (payPeriods.length > 0) {
          updatePayPeriodDropdown();
        }
        
        if (currentUser === 'admin') {
          showAdminDashboard();
        }
        
        showNotification('Previous session restored successfully', 'success');
        return true;
      }
    } else {
      sessionStorage.removeItem(AUTO_SAVE_KEY);
      showNotification('Auto-saved data expired and was cleared', 'info');
    }
  } catch (error) {
    console.error('Failed to restore auto-save:', error);
    sessionStorage.removeItem(AUTO_SAVE_KEY);
    showNotification('Failed to restore saved data', 'error');
  }
  
  return false;
}

function startAutoSave() {
  stopAutoSave();
  autoSaveUploads();
  autoSaveTimer = setInterval(autoSaveUploads, AUTO_SAVE_INTERVAL);
}

function stopAutoSave() {
  if (autoSaveTimer) {
    clearInterval(autoSaveTimer);
    autoSaveTimer = null;
  }
}

function clearAutoSave() {
  sessionStorage.removeItem(AUTO_SAVE_KEY);
  console.log('Auto-saved data cleared');
}

window.addEventListener('error', function(event) {
  console.error('Unexpected error:', event.error);
  autoSaveUploads();
  showNotification('An error occurred. Your data has been auto-saved.', 'warning');
});

window.addEventListener('beforeunload', function(event) {
  autoSaveUploads();
});

window.addEventListener('load', function() {
  setTimeout(function() {
    const restored = restoreAutoSave();
    if (restored) {
      console.log('Auto-saved data restored');
    }
  }, 500);
});
// Quick Actions Panel Functions
function exportToCSV() {
  const rows = [['Name', 'Hours', 'Enhancements', 'Memberships', 'Conversion%', 'Rebook%', 'Bonus']];
  Object.entries(staffData).forEach(([name, data]) => {
    const conv = data.eligibleGuests > 0 ? (data.member / data.eligibleGuests * 100).toFixed(1) : '0';
    const bonusCalc = calculateBonus(data);
    rows.push([name, data.hours, data.enhance, data.member, conv, data.rebook, bonusCalc.total.toFixed(2)]);
  });
  
  const csvContent = rows.map(e => e.join(",")).join("\n");
  const blob = new Blob([csvContent], { type: 'text/csv' });
  const url = window.URL.createObjectURL(blob);
  const a = document.createElement('a');
  a.href = url;
  a.download = `performance_${currentPeriod}_${new Date().toISOString().split('T')[0]}.csv`;
  a.click();
  window.URL.revokeObjectURL(url);
  showNotification('Data exported successfully', 'success');
}

function printDashboard() {
  const quickActions = document.querySelector('.quick-actions');
  if (quickActions) quickActions.style.display = 'none';
  window.print();
  if (quickActions) quickActions.style.display = 'block';
}

function refreshData() {
  if (currentUser === 'admin') {
    showAdminDashboard();
  } else if (currentUser) {
    showStaffDashboard();
  }
  showNotification('Dashboard refreshed', 'success');
}

function toggleQuickActions() {
  const panel = document.querySelector('.quick-actions');
  if (panel.classList.contains('minimized')) {
    panel.classList.remove('minimized');
  } else {
    panel.classList.add('minimized');
  }
  }
// DOMContentLoaded should be SEPARATE, not inside toggleQuickActions
document.addEventListener('DOMContentLoaded', function() {
  console.log('Enhanced Performance Dashboard initialized');
  
  // Debug appointment input
  const appointmentInput = document.getElementById('appointmentFile');
  if (appointmentInput) {
    console.log('Appointment input found at initialization');
  } else {
    console.log('ERROR: Appointment input NOT found at initialization');
  }
  
  // Bonus auto-load code
  const savedBonus = localStorage.getItem('bonusStructure');
  if (savedBonus) {
    uploadedData.bonusStructure = savedBonus;
    try {
      const bonusData = parseCSV(savedBonus);
      updateBonusRates(bonusData);
      
      const btn = document.getElementById('bonusUploadBtn');
      if (btn) {
        btn.style.background = '#e8f5e9';
        btn.style.borderColor = '#4caf50';
        btn.innerHTML = 
          '<span style="font-size: 16px;">üíµ</span>' +
          '<span>Bonus Structure ‚úì</span>' +
          '<span style="margin-left: auto; color: #4caf50; font-size: 12px;">LOADED</span>';
      }
      
      console.log('Bonus structure auto-loaded from saved settings');
    } catch (error) {
      console.error('Error loading saved bonus structure:', error);
    }
  }
});
</script>
<div cla...
});
</script>
<div class="quick-actions" id="quickActionsPanel" style="display: none;">
  <div class="quick-actions-header" onclick="toggleQuickActions()">
    <span>‚ö°</span>
  </div>
  <div class="quick-actions-buttons">
    <button onclick="exportToCSV()" class="quick-action-btn" title="Export Data">
      <span class="action-icon">üìä</span>
      <span class="action-label">Export</span>
    </button>
    <button onclick="printDashboard()" class="quick-action-btn" title="Print">
      <span class="action-icon">üñ®Ô∏è</span>
      <span class="action-label">Print</span>
    </button>
    <button onclick="refreshData()" class="quick-action-btn" title="Refresh">
      <span class="action-icon">üîÑ</span>
      <span class="action-label">Refresh</span>
    </button>
  </div>
</div>

<style>
/* Enhanced Font Sizes for Better Readability */
body { font-size: 16px !important; }
.header h1 { font-size: 28px !important; }
.login-header h2 { font-size: 36px !important; }
.login-box h3 { font-size: 28px !important; }
.login-box p { font-size: 16px !important; }
.login-form input, .login-form select { font-size: 16px !important; }
.login-btn { font-size: 18px !important; }

/* Stats cards */
.stat-value { font-size: 56px !important; }
.stat-label { font-size: 14px !important; }
.stat-goal { font-size: 16px !important; }
.status-badge { font-size: 14px !important; }
.metric-row { font-size: 15px !important; }
.hours-indicator { font-size: 13px !important; }

/* Efficiency section */
.efficiency-value { font-size: 28px !important; }
.efficiency-label { font-size: 14px !important; }

/* Tables */
.team-table th { font-size: 15px !important; }
.team-table td { font-size: 15px !important; }
.comparison-table th { font-size: 16px !important; }
.comparison-table td { font-size: 16px !important; }
.comparison-table h3 { font-size: 20px !important; }

/* Bonus section */
.bonus-total { font-size: 42px !important; }
.bonus-section h3 { font-size: 18px !important; }

/* Admin section */
.admin-card h3 { font-size: 20px !important; }
.admin-card h4 { font-size: 16px !important; }

/* Welcome section */
.welcome-section h2 { font-size: 26px !important; }
.welcome-section p { font-size: 16px !important; }

/* Tips section */
.tips-section h3 { font-size: 18px !important; }
.tips-section li { font-size: 16px !important; }
tips-section h3 { font-size: 18px !important; }
.tips-section li { font-size: 16px !important; }  /* <- Line 3293 */

/* Quick Actions Panel Styles - ADD ALL THIS STARTING AT LINE 3294 */
.quick-actions {
  position: fixed;
  right: 20px;
  bottom: 20px;
  background: white;
  padding: 15px;
  border-radius: 15px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.15);
  z-index: 1000;
  transition: all 0.3s ease;
}

.quick-actions.minimized {
  padding: 10px;
}

.quick-actions.minimized .quick-actions-buttons {
  display: none;
}

.quick-actions-header {
  cursor: pointer;
  text-align: center;
  font-size: 20px;
  margin-bottom: 10px;
}

.quick-actions.minimized .quick-actions-header {
  margin-bottom: 0;
}

.quick-actions-buttons {
  display: flex;
  gap: 10px;
}

.quick-action-btn {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 10px;
  border: none;
  background: #f0f2f5;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
  min-width: 60px;
}

.quick-action-btn:hover {
  background: #e3f2fd;
  transform: translateY(-2px);
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.action-icon {
  font-size: 24px;
  margin-bottom: 4px;
}

.action-label {
  font-size: 11px;
  color: #666;
  font-weight: 600;
}

@media print {
  .quick-actions {
    display: none !important;
  }
}
</style>

<!-- Firebase Authentication -->
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>

<script>
// Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyD35d3diHbqdj2yrU8Mq1NQGvC4SXfZLr0",
  authDomain: "salesdashboard-e28a1.firebaseapp.com",
  databaseURL: "https://salesdashboard-e28a1-default-rtdb.firebaseio.com",
  projectId: "salesdashboard-e28a1",
  storageBucket: "salesdashboard-e28a1.firebasestorage.app",
  messagingSenderId: "497089067660",
  appId: "1:497089067660:web:92cee755dbbad692b5d9a9",
  measurementId: "G-9MZZ5DV3FW"
};

// Initialize Firebase
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();

// Map staff names to emails
const staffEmails = {
  'Angela McNally': 'angela.mcnally@salesdashboard.com',
  'Madison Jeske': 'madison.jeske@salesdashboard.com',
  'Di Fisher': 'di.fisher@salesdashboard.com',
  'Jessica Watts': 'Jessica.Watts@salesdashboard.com',
  'Nicole Rice': 'Nicole.Rice@salesdashboard.com',
};

// Check authentication state
auth.onAuthStateChanged((user) => {
  if (user) {
    console.log('User is signed in:', user.email);
  } else {
    document.getElementById('loginSection').classList.remove('hidden');
    document.getElementById('staffView').classList.add('hidden');
    document.getElementById('adminView').classList.add('hidden');
  }
});
</script>

</body>
</html>
