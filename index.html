<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Performance Dashboard - Enhanced</title>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: #f0f2f5; }
    .header { background: white; padding: 15px 30px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); display: flex; justify-content: space-between; align-items: center; }
    .header h1 { font-size: 24px; font-weight: 600; }
    .login-container { max-width: 900px; margin: 100px auto; padding: 20px; }
    .login-header { text-align: center; margin-bottom: 40px; }
    .login-header h2 { font-size: 32px; color: #333; }
    .login-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 40px; max-width: 800px; margin: 0 auto; }
    .login-box { background: white; padding: 40px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); text-align: center; }
    .login-box h3 { color: #007bff; font-size: 24px; margin-bottom: 10px; }
    .login-box p { color: #6c757d; margin-bottom: 30px; font-size: 14px; }
    .login-form { display: flex; flex-direction: column; gap: 15px; }
    .login-form input, .login-form select { padding: 12px; border: 1px solid #ddd; border-radius: 6px; font-size: 14px; width: 100%; }
    .login-btn { padding: 12px; border: none; border-radius: 6px; font-size: 16px; font-weight: 500; cursor: pointer; color: white; transition: all 0.3s; }
    .staff-login-btn { background: #28a745; }
    .staff-login-btn:hover { background: #218838; }
    .admin-login-btn { background: #007bff; }
    .admin-login-btn:hover { background: #0056b3; }
    .logout-btn { background: white; color: #dc3545; border: 1px solid #dc3545; padding: 8px 20px; border-radius: 5px; cursor: pointer; font-size: 14px; }
    .logout-btn:hover { background: #dc3545; color: white; }
    .hidden { display: none !important; }
    .notification { position: fixed; top: 20px; right: 20px; padding: 15px 20px; border-radius: 5px; z-index: 10000; box-shadow: 0 4px 12px rgba(0,0,0,0.15); max-width: 350px; animation: slideIn 0.3s ease; }
    @keyframes slideIn { from { transform: translateX(100%); } to { transform: translateX(0); } }
    .notification.success { background: #28a745; color: white; }
    .notification.error { background: #dc3545; color: white; }
    .staff-container { padding: 30px; max-width: 1400px; margin: 0 auto; }
    
    /* Enhanced Staff Dashboard Styles */
    .welcome-section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .period-selector-staff { margin-top: 10px; padding: 8px 16px; border-radius: 5px; border: 1px solid #ddd; font-size: 14px; }
    .stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 20px; margin-bottom: 20px; }
    .stat-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); text-align: center; transition: transform 0.3s; position: relative; }
    .stat-card:hover { transform: translateY(-5px); box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
    .stat-label { color: #666; font-size: 12px; text-transform: uppercase; margin-bottom: 10px; font-weight: 600; }
    .stat-value { font-size: 48px; font-weight: bold; color: #007bff; margin-bottom: 10px; }
    .stat-goal { font-size: 14px; color: #666; margin-bottom: 15px; }
    .status-badge { padding: 4px 8px; border-radius: 15px; font-size: 12px; font-weight: 600; display: inline-block; margin-bottom: 10px; color: white; }
    .status-green { background: #28a745; }
    .status-yellow { background: #ffc107; color: #333; }
    .status-red { background: #dc3545; }
    
    /* Metric displays */
    .metric-row { display: flex; justify-content: space-between; padding: 8px 0; border-bottom: 1px solid #eee; font-size: 13px; }
    .metric-label { color: #666; }
    .metric-value { font-weight: 600; color: #333; }
    .hours-indicator { position: absolute; top: 10px; right: 10px; background: #e3f2fd; color: #1976d2; padding: 4px 8px; border-radius: 12px; font-size: 11px; font-weight: 600; }
    
    .efficiency-section { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .efficiency-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 15px; }
    .efficiency-card { text-align: center; padding: 15px; background: #f8f9fa; border-radius: 8px; }
    .efficiency-value { font-size: 24px; font-weight: bold; color: #28a745; margin-bottom: 5px; }
    .efficiency-label { font-size: 12px; color: #666; }
    
    .comparison-table { background: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .comparison-table h3 { color: #333; margin-bottom: 15px; font-size: 18px; }
    .comparison-table table { width: 100%; border-collapse: collapse; font-size: 14px; }
    .comparison-table th { padding: 10px; text-align: left; border: 1px solid #dee2e6; font-weight: 600; background: #f8f9fa; }
    .comparison-table td { padding: 10px; border: 1px solid #dee2e6; text-align: center; }
    .user-row { background: #e3f2fd; font-weight: bold; }
    
    .bonus-section { background: linear-gradient(135deg, #374151, #4b5563); color: white; padding: 20px; border-radius: 10px; margin-bottom: 20px; text-align: center; }
    .bonus-total { font-size: 36px; font-weight: bold; margin-bottom: 20px; }
    .bonus-breakdown { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
    .bonus-item { background: rgba(255,255,255,0.1); padding: 15px; border-radius: 8px; text-align: center; }
    
    .tips-section { background: #e3f2fd; padding: 20px; border-radius: 10px; border-left: 4px solid #2196f3; }
    .tips-section h3 { color: #1976d2; margin-bottom: 10px; font-size: 16px; }
    .tips-section ul { list-style: none; padding: 0; }
    .tips-section li { padding: 5px 0; color: #555; font-size: 14px; }
    .tips-section li:before { content: "✔ "; color: #1976d2; font-weight: bold; margin-right: 8px; }
    
    /* Admin Dashboard Styles */
    .admin-container { padding: 30px; max-width: 1400px; margin: 0 auto; }
    .admin-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .admin-card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
    .admin-card h3 { color: #333; margin-bottom: 15px; font-size: 18px; }
    .team-table { width: 100%; border-collapse: collapse; }
    .team-table th { padding: 12px; text-align: left; background: #f8f9fa; border-bottom: 2px solid #dee2e6; font-size: 13px; }
    .team-table td { padding: 12px; border-bottom: 1px solid #dee2e6; font-size: 13px; }
    .performance-bar { height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; }
    .performance-fill { height: 100%; background: #28a745; transition: width 0.3s; }
    
    .trend-indicator { display: inline-block; margin-left: 5px; font-size: 12px; }
    .trend-up { color: #28a745; }
    .trend-down { color: #dc3545; }
    .trend-neutral { color: #6c757d; }
    
    @media (max-width: 768px) {
      .login-grid { grid-template-columns: 1fr; }
      .stats-grid { grid-template-columns: 1fr; }
      .bonus-breakdown { grid-template-columns: 1fr; }
      .efficiency-grid { grid-template-columns: 1fr; }
    }
    
    /* Fix layout issues */
    .staff-container > * {
      margin-bottom: 20px;
      clear: both;
    }
    
    .comparison-table {
      clear: both;
      width: 100%;
      margin-bottom: 20px;
    }
    
    .bonus-section {
      clear: both;
      width: 100%;
      margin-bottom: 20px;
    }
    
    .tips-section {
      clear: both;
      width: 100%;
      margin-bottom: 20px;
    }
    
    /* Ensure proper spacing between sections */
    .stats-grid {
      margin-bottom: 30px !important;
    }
    
    /* Fix table overflow */
    .comparison-table table {
      width: 100%;
      table-layout: auto;
    }
    
    .comparison-table td, .comparison-table th {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    
    /* Fix Performance Tips positioning */
    .tips-section {
      clear: both;
      width: 100%;
      margin: 20px 0;
      position: relative;
    }
    
    /* Fix grid layout for side-by-side sections */
    .staff-container {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }
    
    /* Stack Team Comparison and Bonus sections vertically */
    .comparison-table {
      width: 100%;
      margin-bottom: 20px;
    }
    
    .bonus-section {
      width: 100%;
      max-width: none;
      margin-bottom: 20px;
    }

    /* Quick Actions Panel Styles */
    .quick-actions {
      position: fixed;
      right: 20px;
      bottom: 20px;
      background: white;
      padding: 15px;
      border-radius: 15px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.15);
      z-index: 1000;
      transition: all 0.3s ease;
    }
    
    .quick-actions.minimized {
      padding: 10px;
    }
    
    .quick-actions.minimized .quick-actions-buttons {
      display: none;
    }
    
    .quick-actions-header {
      cursor: pointer;
      text-align: center;
      font-size: 20px;
      margin-bottom: 10px;
    }
    
    .quick-actions.minimized .quick-actions-header {
      margin-bottom: 0;
    }
    
    .quick-actions-buttons {
      display: flex;
      gap: 10px;
    }
    
    .quick-action-btn {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px;
      border: none;
      background: #f0f2f5;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 60px;
    }
    
    .quick-action-btn:hover {
      background: #e3f2fd;
      transform: translateY(-2px);
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    
    .action-icon {
      font-size: 24px;
      margin-bottom: 4px;
    }
    
    .action-label {
      font-size: 11px;
      color: #666;
      font-weight: 600;
    }
    
    @media print {
      .quick-actions {
        display: none !important;
      }
    }
  </style>
</head>
<body>
  <!-- LOGIN SECTION - Always visible unless logged in -->
  <div id="loginSection">
    <div class="header">
      <h1>Performance Dashboard</h1>
    </div>
    <div class="login-container">
      <div class="login-header">
        <h2>Performance Dashboard Login</h2>
      </div>
      <div class="login-grid">
        <div class="login-box">
          <h3>Staff Login</h3>
          <p>Experience Guides - Access your personal dashboard</p>
          <div class="login-form">
            <select id="staffSelect">
              <option value="">Select your name...</option>
              <!-- Options will be populated dynamically from CSV data -->
            </select>
            <input type="password" id="staffPassword" placeholder="Enter your Staff ID">
            <button class="login-btn staff-login-btn" onclick="loginStaff()">Login as Staff</button>
          </div>
        </div>
        <div class="login-box">
          <h3>Admin Login</h3>
          <p>Managers - Access all dashboards and reports</p>
          <div class="login-form">
            <input type="password" id="adminPassword" placeholder="Enter admin password">
            <button class="login-btn admin-login-btn" onclick="loginAdmin()">Login as Admin</button>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- STAFF VIEW - Hidden until staff login -->
  <div id="staffView" class="hidden">
    <div class="header">
      <h1 id="staffTitle">Performance Dashboard</h1>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
    
    <div class="staff-container">
      <div class="welcome-section">
        <h2>Welcome, <span id="staffName">Staff Member</span>!</h2>
        <p>Your Performance for <span id="staffPeriodDisplay">Current Period</span></p>
        <label for="staffPeriodSelector">Select Period:</label>
        <div id="staffPeriodDropdown"></div>
      </div>
      
      <div class="tips-section">
        <h3>Performance Tips</h3>
        <ul id="performanceTips">
          <li>Loading personalized tips...</li>
        </ul>
      </div>

      <div class="stats-grid">
        <div class="stat-card">
          <div class="hours-indicator" id="hoursWorked">0 hrs</div>
          <div class="stat-label">ENHANCEMENTS</div>
          <div class="stat-value" id="enhanceValue">0</div>
          <div class="stat-goal">Goal: <span id="enhanceAdjusted">0</span></div>
          <div class="status-badge" id="enhanceStatus">0%</div>
          <div id="enhanceMessage">Loading...</div>
        </div>

        <div class="stat-card">
          <div class="stat-label">MEMBERSHIPS</div>
          <div class="stat-value" id="memberValue">0</div>
          <div class="stat-goal">Conv Goal: <span id="convGoal">0%</span> | Actual: <span id="convActual">0%</span></div>
          <div class="status-badge" id="memberStatus">0%</div>
          <div id="memberMessage">Loading...</div>
          <div class="metric-row">
            <span class="metric-label">Eligible Guests:</span>
            <span class="metric-value" id="eligibleGuestsCount">0</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-label">REBOOK RATE</div>
          <div class="stat-value" id="rebookValue">0%</div>
          <div class="stat-goal">Target: 20%</div>
          <div class="status-badge" id="rebookStatus">Loading</div>
          <div id="rebookMessage">Loading...</div>
          <div class="metric-row">
            <span class="metric-label">Total Guests:</span>
            <span class="metric-value" id="totalGuestsServed">0</span>
          </div>
        </div>

        <div class="stat-card">
          <div class="stat-label">PERFORMANCE SCORE</div>
          <div class="stat-value" id="overallValue">0%</div>
          <div class="stat-goal">Adjusted for Hours & Conversion</div>
          <div class="status-badge" id="overallStatus">Loading</div>
          <div id="overallMessage">Loading...</div>
          <div class="metric-row">
            <span class="metric-label">Trend:</span>
            <span class="metric-value" id="performanceTrend">--</span>
          </div>
        </div>
      </div>
      
      <div class="comparison-table">
        <h3>Team Comparison</h3>
        <table>
          <thead>
            <tr>
              <th>Metric</th>
              <th>You</th>
              <th>Team Avg</th>
              <th>Top Performer</th>
            </tr>
          </thead>
          <tbody>
            <tr class="user-row">
              <td>Conversion Rate</td>
              <td id="yourConv">0%</td>
              <td id="avgConv">0%</td>
              <td id="topConv">0%</td>
            </tr>
            <tr>
              <td>Enhancements/Hour</td>
              <td id="yourEnhPerHour">0.00</td>
              <td id="avgEnhPerHour">0.00</td>
              <td id="topEnhPerHour">0.00</td>
            </tr>
            <tr class="user-row">
              <td>Members/Hour</td>
              <td id="yourMemPerHour">0.00</td>
              <td id="avgMemPerHour">0.00</td>
              <td id="topMemPerHour">0.00</td>
            </tr>
            <tr>
              <td>Rebook Rate</td>
              <td id="yourRebook">0%</td>
              <td id="avgRebook">0%</td>
              <td id="topRebook">0%</td>
            </tr>
          </tbody>
        </table>
      </div>
      
      <div class="bonus-section">
        <h3>My Bonus Earnings - <span id="bonusPeriodDisplay">Current Period</span></h3>
        <div class="bonus-total" id="totalBonus">$0.00</div>
        <div class="bonus-breakdown">
          <div class="bonus-item">
            <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">Enhancement</div>
            <div style="font-size: 24px; font-weight: bold;" id="enhanceBonus">$0.00</div>
          </div>
          <div class="bonus-item">
            <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">Membership</div>
            <div style="font-size: 24px; font-weight: bold;" id="membershipBonus">$0.00</div>
          </div>
          <div class="bonus-item">
            <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px;">Performance</div>
            <div style="font-size: 24px; font-weight: bold;" id="performanceBonus">$0.00</div>
          </div>
        </div>
      </div>

      <div id="performanceTrendChart"></div>
    </div>
  </div>
  
  <!-- ADMIN VIEW - Hidden until admin login -->
  <div id="adminView" class="hidden">
    <div class="header">
      <h1>Admin Dashboard - Team Overview</h1>
      <div style="display: flex; gap: 10px; align-items: center;">
        <div id="adminPeriodDropdown"></div>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </div>
    
    <div class="admin-container">
      <div class="admin-grid">
        <div class="admin-card">
          <h3>Team Summary</h3>
          <div style="display: flex; justify-content: space-between; margin: 10px 0;">
            <span>Total Staff:</span>
            <strong>7</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin: 10px 0;">
            <span>Total Hours:</span>
            <strong id="totalHours">0</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin: 10px 0;">
            <span>Avg Conversion:</span>
            <strong id="avgConvAdmin">0%</strong>
          </div>
          <div style="display: flex; justify-content: space-between; margin: 10px 0;">
            <span>Avg Rebook Rate:</span>
            <strong id="avgRebookAdmin">0%</strong>
          </div>
        </div>
        
        <div class="admin-card">
          <h3>Top Performers (Adjusted)</h3>
          <ol id="topPerformers" style="padding-left: 20px;">
            <li>Loading...</li>
          </ol>
        </div>
        
        <div class="admin-card">
          <h3>Total Individual Bonuses</h3>
          <div style="font-size: 32px; font-weight: bold; color: #4a5568; text-align: center; margin: 20px 0;">
            <span id="totalTeamBonus">$0.00</span>
          </div>
          <p style="text-align: center; color: #666; font-size: 14px;">Sum of All Staff Bonuses</p>
        </div>
      </div>
      
      <div class="admin-card">
        <h3>Full Team Performance</h3>
        <table class="team-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Hours</th>
              <th>Members</th>
              <th>Conv %</th>
              <th>Goal %</th>
              <th>Enhance</th>
              <th>Enh Goal</th>
              <th>Rebook Goal</th>
              <th>Rebook</th>
              <th>Bonus</th>
              <th>Score</th>
            </tr>
          </thead>
          <tbody id="teamTableBody">
            <tr>
              <td colspan="11" style="text-align: center;">Loading...</td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- Data Upload Section -->
      <div class="admin-card" style="margin-top: 20px;">
        <h3 style="font-size: 18px; margin-bottom: 20px; color: #333; border-bottom: 2px solid #007bff; padding-bottom: 10px;">
          <span style="color: #007bff;">📊</span> Data Management Center
        </h3>
        
        <div style="display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 15px; margin-bottom: 20px;">
          <!-- Left Column - File Uploads -->
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
            <h4 style="font-size: 15px; margin-bottom: 15px; color: #495057; font-weight: 600;">
              Import Data Files
            </h4>
            
            <div style="display: flex; flex-direction: column; gap: 10px;">
              <!-- Appointment Data -->
              <div class="upload-item" style="display: flex; align-items: center; gap: 10px;">
                <button onclick="document.getElementById('appointmentFile').click()" 
                        style="flex: 1; background: white; color: #495057; border: 1px solid #ced4da; 
                               padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; 
                               text-align: left; display: flex; align-items: center; gap: 8px;
                               transition: all 0.2s;"
                        onmouseover="this.style.background='#e3f2fd'; this.style.borderColor='#2196f3';"
                        onmouseout="this.style.background='white'; this.style.borderColor='#ced4da';">
                  <span style="font-size: 16px;">📅</span>
                  <span>Appointment Data</span>
                  <span style="margin-left: auto; color: #6c757d; font-size: 12px;">CSV</span>
                </button>
                <input type="file" id="appointmentFile" accept=".csv" style="display: none;" 
                       onchange="handleAppointmentUpload(event)">
              </div>
              
              <!-- Membership Data -->
              <div class="upload-item" style="display: flex; align-items: center; gap: 10px;">
                <button onclick="document.getElementById('membershipFile').click()" 
                        style="flex: 1; background: white; color: #495057; border: 1px solid #ced4da; 
                               padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; 
                               text-align: left; display: flex; align-items: center; gap: 8px;
                               transition: all 0.2s;"
                        onmouseover="this.style.background='#fff3e0'; this.style.borderColor='#ff9800';"
                        onmouseout="this.style.background='white'; this.style.borderColor='#ced4da';">
                  <span style="font-size: 16px;">👥</span>
                  <span>Membership Data</span>
                  <span style="margin-left: auto; color: #6c757d; font-size: 12px;">CSV</span>
                </button>
                <input type="file" id="membershipFile" accept=".csv" style="display: none;" 
                       onchange="handleMembershipUpload(event)">
              </div>
              
              <!-- Sales Data -->
              <div class="upload-item" style="display: flex; align-items: center; gap: 10px;">
                <button onclick="document.getElementById('salesFile').click()" 
                        style="flex: 1; background: white; color: #495057; border: 1px solid #ced4da; 
                               padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; 
                               text-align: left; display: flex; align-items: center; gap: 8px;
                               transition: all 0.2s;"
                        onmouseover="this.style.background='#e8f5e9'; this.style.borderColor='#4caf50';"
                        onmouseout="this.style.background='white'; this.style.borderColor='#ced4da';">
                  <span style="font-size: 16px;">💰</span>
                  <span>Sales Data</span>
                  <span style="margin-left: auto; color: #6c757d; font-size: 12px;">CSV</span>
                </button>
                <input type="file" id="salesFile" accept=".csv" style="display: none;" 
                       onchange="handleSalesUpload(event)">
              </div>
              
              <!-- OOT Data -->
              <div class="upload-item" style="display: flex; align-items: center; gap: 10px;">
                <button onclick="document.getElementById('ootFile').click()" 
                        style="flex: 1; background: white; color: #495057; border: 1px solid #ced4da; 
                               padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; 
                               text-align: left; display: flex; align-items: center; gap: 8px;
                               transition: all 0.2s;"
                        onmouseover="this.style.background='#f3e5f5'; this.style.borderColor='#9c27b0';"
                        onmouseout="this.style.background='white'; this.style.borderColor='#ced4da';">
                  <span style="font-size: 16px;">📋</span>
                  <span>OOT Data</span>
                  <span style="margin-left: auto; color: #6c757d; font-size: 12px;">CSV</span>
                </button>
                <input type="file" id="ootFile" accept=".csv" style="display: none;" 
                       onchange="handleOOTUpload(event)">
              </div>
              
              <!-- Payroll Hours -->
              <div class="upload-item" style="display: flex; align-items: center; gap: 10px;">
                <button onclick="document.getElementById('payrollFile').click()" 
                        style="flex: 1; background: white; color: #495057; border: 1px solid #ced4da; 
                               padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; 
                               text-align: left; display: flex; align-items: center; gap: 8px;
                               transition: all 0.2s;"
                        onmouseover="this.style.background='#fef4e7'; this.style.borderColor='#fd7e14';"
                        onmouseout="this.style.background='white'; this.style.borderColor='#ced4da';">
                  <span style="font-size: 16px;">⏰</span>
                  <span>Payroll Hours</span>
                  <span style="margin-left: auto; color: #6c757d; font-size: 12px;">CSV</span>
                </button>
                <input type="file" id="payrollFile" accept=".csv" style="display: none;" 
                       onchange="handlePayrollUpload(event)">
              </div>
              
              <!-- Bonus Structure -->
              <div class="upload-item" style="display: flex; align-items: center; gap: 10px;">
                <button onclick="document.getElementById('bonusFile').click()" 
                        id="bonusUploadBtn"
                        style="flex: 1; background: white; color: #495057; border: 1px solid #ced4da; 
                               padding: 10px 15px; border-radius: 6px; cursor: pointer; font-size: 14px; 
                               text-align: left; display: flex; align-items: center; gap: 8px;
                               transition: all 0.2s;"
                        onmouseover="this.style.background='#e0f7fa'; this.style.borderColor='#00acc1';"
                        onmouseout="this.style.background='white'; this.style.borderColor='#ced4da';">
                  <span style="font-size: 16px;">💵</span>
                  <span>Bonus Structure</span>
                  <span style="margin-left: auto; color: #6c757d; font-size: 12px;">CSV</span>
                </button>
                <input type="file" id="bonusFile" accept=".csv" style="display: none;" 
                       onchange="handleBonusUpload(event)">
              </div>
            </div>
          </div>

          <!-- Middle Column - Processing & Management -->
          <div style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
            <h4 style="font-size: 15px; margin-bottom: 15px; color: #495057; font-weight: 600;">
              Processing & Management
            </h4>
            
            <div style="display: flex; flex-direction: column; gap: 10px;">
              <!-- Validate Data Button -->
              <button onclick="DataValidator.showValidationPreview()" 
                      style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
                             color: white; border: none; padding: 12px 20px; 
                             border-radius: 6px; cursor: pointer; font-size: 14px; 
                             font-weight: 600; display: flex; align-items: center; 
                             justify-content: center; gap: 8px; transition: all 0.3s;
                             box-shadow: 0 2px 4px rgba(102, 126, 234, 0.3);"
                      onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(102, 126, 234, 0.4)';"
                      onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(102, 126, 234, 0.3)';">
                <span>✔</span> Validate Data First
              </button>
              
              <!-- Process All Data Button -->
              <button onclick="processAllData()" 
                      style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); 
                             color: white; border: none; padding: 12px 20px; 
                             border-radius: 6px; cursor: pointer; font-size: 14px; 
                             font-weight: 600; display: flex; align-items: center; 
                             justify-content: center; gap: 8px; transition: all 0.3s;
                             box-shadow: 0 2px 4px rgba(245, 87, 108, 0.3);"
                      onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 8px rgba(245, 87, 108, 0.4)';"
                      onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 4px rgba(245, 87, 108, 0.3)';">
                <span>⚡</span> Process All Data
              </button>
              
              <!-- Staff List Upload -->
              <button onclick="document.getElementById('staffListFile').click()" 
                      style="background: white; color: #495057; 
                             border: 2px solid #dee2e6; padding: 12px 20px; 
                             border-radius: 6px; cursor: pointer; font-size: 14px; 
                             font-weight: 600; display: flex; align-items: center; 
                             justify-content: center; gap: 8px; transition: all 0.3s;"
                      onmouseover="this.style.borderColor='#6c757d'; this.style.color='#6c757d'; this.style.background='#f8f9fa';"
                      onmouseout="this.style.borderColor='#dee2e6'; this.style.color='#495057'; this.style.background='white';">
                <span>👤</span> Update Staff List CSV
              </button>
              <input type="file" id="staffListFile" accept=".csv" style="display: none;" 
                     onchange="handleStaffListUpload(event)">
              
              <!-- Divider -->
              <div style="border-top: 1px solid #dee2e6; margin: 5px 0;"></div>
              
              <!-- Staff Management Button -->
              <button onclick="openSimpleStaffManager()" 
                      style="background: white; color: #495057; 
                             border: 2px solid #dee2e6; padding: 12px 20px; 
                             border-radius: 6px; cursor: pointer; font-size: 14px; 
                             font-weight: 600; display: flex; align-items: center; 
                             justify-content: center; gap: 8px; transition: all 0.3s;"
                      onmouseover="this.style.borderColor='#007bff'; this.style.color='#007bff'; this.style.background='#f8f9fa';"
                      onmouseout="this.style.borderColor='#dee2e6'; this.style.color='#495057'; this.style.background='white';">
                <span>👥</span> Quick Add/Remove Staff
              </button>
              
              <!-- Status Indicator -->
              <div style="margin-top: 10px; padding: 10px; background: white; border-radius: 6px; border: 1px solid #dee2e6;">
                <div style="display: flex; align-items: center; gap: 8px; font-size: 13px; color: #6c757d;">
                  <span style="width: 8px; height: 8px; background: #28a745; border-radius: 50%; display: inline-block;"></span>
                  <span>System Ready</span>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Right Column - Upload Timestamps -->
          <div id="uploadTimestampsDisplay" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #dee2e6;">
            <!-- This will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Enhanced Staff Manager Popup -->
  <div id="simpleStaffManager" style="display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 30px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.3); z-index: 10000; width: 500px; max-width: 90%;">
    <h3 style="margin-bottom: 20px; color: #333;">Staff Management Center</h3>
    
    <!-- Add New Staff Section -->
    <div style="margin-bottom: 25px; padding: 20px; background: #f8f9fa; border-radius: 8px;">
      <h4 style="font-size: 16px; margin-bottom: 15px; color: #28a745;">➕ Add New Staff Member</h4>
      <input type="text" id="quickStaffName" placeholder="Full Name (e.g., John Smith)" 
             style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
      <input type="email" id="quickStaffEmail" placeholder="Email (e.g., john.smith@company.com)" 
             style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
      <select id="quickStaffTenure" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
        <option value="0">New Hire (0-1 months)</option>
        <option value="1">1 month</option>
        <option value="2">2 months</option>
        <option value="3">3-6 months</option>
        <option value="6">6-12 months</option>
        <option value="12">1+ years</option>
      </select>
      <button onclick="addStaffMember()" style="background: #28a745; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: 600;">
        Add Staff Member
      </button>
    </div>
    
    <!-- Remove Staff Section -->
    <div style="margin-bottom: 20px; padding: 20px; background: #fff5f5; border-radius: 8px;">
      <h4 style="font-size: 16px; margin-bottom: 15px; color: #dc3545;">➖ Remove Staff Member</h4>
      <select id="quickRemoveSelect" style="width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 4px; font-size: 14px;">
        <option value="">Select staff to remove...</option>
      </select>
      <button onclick="removeStaffMember()" style="background: #dc3545; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: 600;">
        Remove Selected Staff
      </button>
    </div>
    
    <button onclick="closeSimpleStaffManager()" style="background: #6c757d; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; width: 100%; font-weight: 600;">
      Close
    </button>
  </div>

  <!-- Quick Actions Panel -->
  <div class="quick-actions" id="quickActionsPanel" style="display: none;">
    <div class="quick-actions-header" onclick="toggleQuickActions()">
      <span>⚡</span>
    </div>
    <div class="quick-actions-buttons">
      <button onclick="exportToCSV()" class="quick-action-btn" title="Export Data">
        <span class="action-icon">📊</span>
        <span class="action-label">Export</span>
      </button>
      <button onclick="printDashboard()" class="quick-action-btn" title="Print">
        <span class="action-icon">🖨️</span>
        <span class="action-label">Print</span>
      </button>
      <button onclick="refreshData()" class="quick-action-btn" title="Refresh">
        <span class="action-icon">🔄</span>
        <span class="action-label">Refresh</span>
      </button>
    </div>
  </div>

  <!-- Firebase Authentication Scripts - CORRECTED URLS -->
<script src="https://cdn.jsdelivr.net/npm/firebase@10.7.1/firebase-app-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/firebase@10.7.1/firebase-auth-compat.js"></script>
<script src="https://cdn.jsdelivr.net/npm/firebase@10.7.1/firebase-database-compat.js"></script>
  <!-- Main Application Script -->
  <script>
    // Firebase configuration
    const firebaseConfig = {
      apiKey: "AIzaSyD35d3diHbqdj2yrU8Mq1NQGvC4SXfZLr0",
      authDomain: "salesdashboard-e28a1.firebaseapp.com",
      databaseURL: "https://salesdashboard-e28a1-default-rtdb.firebaseio.com",
      projectId: "salesdashboard-e28a1",
      storageBucket: "salesdashboard-e28a1.appspot.com",
      messagingSenderId: "497089067660",
      appId: "1:497089067660:web:92cee755dbbad692b5d9a9",
      measurementId: "G-9MZZ5DV3FW"
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const database = firebase.database();

    // Global approved staff list
    window.APPROVED_STAFF = [
      'Angela McNally',
      'Anna Mercadante', 
      'Madison Jeske',
      'Di Fisher',
      'Edward Franklin',
      'Jessica Watts',
      'Nicole Rice'
    ];

    // Global variables
    let BONUS_RATES = {
      enhancement: { tier1: 0.70, tier2: 0.80, tier3: 0.90 },
      membership: { tier1: 10, tier2: 15, tier3: 20 },
      performanceBonus: 50
    };

    let currentUser = null;
    let currentPeriod = 'current';
    let staffData = {};
    let periodData = {};
    let uploadedData = {
      appointments: null,
      memberships: null,
      sales: null,
      oot: null,
      payroll: null,
      bonusStructure: null,
      staffList: null
    };
    let uploadTimestamps = {
      appointments: null,
      memberships: null,
      sales: null,
      oot: null,
      payroll: null,
      bonusStructure: null,
      staffList: null
    };
    let payrollData = null;
    let payPeriods = [];
    let parsedAppointments = null;
    let parsedMemberships = null;
    let parsedSales = null;
    let parsedOOT = null;

    const PERFORMANCE_THRESHOLDS = {
      excellent: 100,
      good: 80,
      acceptable: 60
    };

    const CONVERSION_CONFIG = {
      localNonMemberRate: 0.366
    };

    const DEFAULT_STAFF_STRUCTURE = {
      enhance: 0,
      enhanceGoal: 10,
      member: 0,
      memberGoal: 3,
      rebook: 0,
      hours: 0,
      eligibleGuests: 0,
      totalGuests: 0,
      prevPerformance: 0,
      tenureMonths: 0,
      bonus: 0
    };

    // Helper functions
    function normalizeName(name) {
      if (!name) return '';
      return name.split(' ')
        .map(word => word.charAt(0).toUpperCase() + word.slice(1).toLowerCase())
        .join(' ');
    }

    function showNotification(message, type = 'info') {
      const notification = document.createElement('div');
      notification.className = `notification ${type}`;
      notification.textContent = message;
      document.body.appendChild(notification);
      
      setTimeout(() => {
        notification.style.animation = 'slideOut 0.3s ease';
        setTimeout(() => notification.remove(), 300);
      }, 3000);
    }

// Replace your existing parseCSV function around line 865 with this improved version:
function parseCSV(text) {
  // Handle different input types
  if (typeof text === 'object') {
    console.warn('parseCSV received an object instead of string, skipping parse');
    return [];
  }
  
  if (typeof text !== 'string') {
    console.error('parseCSV expects a string, got:', typeof text);
    return [];
  }
  
  if (!text || text.trim() === '') {
    console.warn('parseCSV received empty string');
    return [];
  }
  
  try {
    const result = Papa.parse(text, {
      header: true,
      skipEmptyLines: true
    });
    
    if (result.errors && result.errors.length > 0) {
      console.warn('CSV parsing warnings:', result.errors);
    }
    
    return result.data || [];
  } catch (error) {
    console.error('CSV parsing error:', error);
    return [];
  }
}

function parseDateConsistent(dateStr, formats = null) {
  if (!dateStr) return null;

  try {
    const cleaned = String(dateStr).trim();
    let date = new Date(cleaned);
    if (!isNaN(date.getTime())) {
      return date;
    }

    const commonFormats = formats || [
      /^(\d{1,2})\/(\d{1,2})\/(\d{4})$/,
      /^(\d{1,2})-(\d{1,2})-(\d{4})$/,
      /^(\d{4})-(\d{1,2})-(\d{1,2})$/,
      /^(\d{1,2})\.(\d{1,2})\.(\d{4})$/
    ];

    for (const format of commonFormats) {
      const match = cleaned.match(format);
      if (match) {
        if (format.source.includes('(\\d{4})$')) {
          date = new Date(match[3], match[1] - 1, match[2]);
        } else {
          date = new Date(match[1], match[2] - 1, match[3]);
        }
        
        if (!isNaN(date.getTime())) {
          return date;
        }
      }
    }

    const serialNumber = parseFloat(cleaned);
    if (!isNaN(serialNumber) && serialNumber > 25569 && serialNumber < 100000) {
      date = new Date((serialNumber - 25569) * 86400 * 1000);
      if (!isNaN(date.getTime())) {
        return date;
      }
    }

    return null;
  } catch (error) {
    console.error('Date parsing error:', error, 'Input:', dateStr);
    return null;
  }
}

    function formatTimestamp(timestamp) {
      if (!timestamp) return 'Never';
      const date = new Date(timestamp);
      const now = new Date();
      const diffMs = now - date;
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);
      
      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins} min${diffMins > 1 ? 's' : ''} ago`;
      if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
      if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
      
      return date.toLocaleDateString() + ' ' + date.toLocaleTimeString();
    }

    function updateUploadTimestamps() {
      const container = document.getElementById('uploadTimestampsDisplay');
      if (!container) return;
      
      let html = '<h4 style="font-size: 15px; margin-bottom: 15px; color: #495057; font-weight: 600;">📅 Last Upload Times</h4>';
      html += '<div style="display: flex; flex-direction: column; gap: 8px; font-size: 13px;">';
      
      const files = [
        { name: 'Appointments', key: 'appointments', icon: '📅' },
        { name: 'Memberships', key: 'memberships', icon: '👥' },
        { name: 'Sales', key: 'sales', icon: '💰' },
        { name: 'OOT', key: 'oot', icon: '📋' },
        { name: 'Payroll', key: 'payroll', icon: '⏰' },
        { name: 'Bonus', key: 'bonusStructure', icon: '💵' }
      ];
      
      files.forEach(file => {
        const timestamp = uploadTimestamps[file.key];
        const statusColor = timestamp ? '#16a34a' : '#dc2626';
        const statusIcon = timestamp ? '✔' : '✗';
        
        html += `
          <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px; background: white; border-radius: 4px;">
            <span>${file.icon} ${file.name}:</span>
            <span style="color: ${statusColor}; font-weight: 500; font-size: 12px;">
              ${statusIcon} ${formatTimestamp(timestamp)}
            </span>
          </div>
        `;
      });
      
      html += '</div>';
      container.innerHTML = html;
    }

    // Initialize default staff
    function initializeDefaultStaff() {
      window.APPROVED_STAFF.forEach(staffName => {
        const normalized = normalizeName(staffName);
        staffData[normalized] = { ...DEFAULT_STAFF_STRUCTURE };
      });
    }

    // Calculation functions
    function getConversionGoal(tenureMonths) {
      if (tenureMonths >= 3) return 10.0;
      if (tenureMonths >= 2) return 7.0;
      return 5.0;
    }

    function calculateFairEnhancementGoal(hoursWorked, tenureMonths) {
      const enhancementsPerHour = 0.35;
      const calculatedGoal = Math.round(hoursWorked * enhancementsPerHour);
      
      if (tenureMonths >= 3) {
        return Math.max(calculatedGoal, 5);
      } else {
        return Math.max(calculatedGoal, 3);
      }
    }

    function calculatePerformanceScore(data) {
      if (!data.hours || data.hours === 0) {
        return 0;
      }
      
      const convGoal = getConversionGoal(data.tenureMonths);
      const actualConv = data.eligibleGuests > 0 ? 
        (data.member / data.eligibleGuests * 100) : 0;
      
      const convScore = Math.min((actualConv / convGoal) * 40, 40);
      const enhancePerHour = data.enhance / data.hours;
      const enhanceScore = Math.min(enhancePerHour * 60, 30);
      const rebookScore = Math.min((data.rebook / 20) * 20, 20);
      const productivityScore = Math.min(((data.member + data.enhance) / data.hours) * 10, 10);
      
      return Math.round(convScore + enhanceScore + rebookScore + productivityScore);
    }

    function calculateBonus(staffData) {
      if (!staffData || staffData.enhance === undefined || staffData.member === undefined) {
        return {
          enhanceBonus: 0,
          membershipBonus: 0,
          performanceBonus: 0,
          total: 0,
          status: 'error',
          message: 'Missing required data'
        };
      }
      
      const enhanceGoal = staffData.enhanceGoal || calculateFairEnhancementGoal(staffData.hours || 0, staffData.tenureMonths || 6);
      const enhancePercent = enhanceGoal > 0 ? (staffData.enhance / enhanceGoal * 100) : 0;
      
      let enhanceRate;
      if (enhancePercent >= 90) {
        enhanceRate = BONUS_RATES.enhancement.tier3;
      } else if (enhancePercent >= 80) {
        enhanceRate = BONUS_RATES.enhancement.tier2;
      } else {
        enhanceRate = BONUS_RATES.enhancement.tier1;
      }
      
      const enhanceBonus = staffData.enhance * enhanceRate;
      
      let membershipBonus = 0;
      const memberships = staffData.member || 0;
      
      if (memberships >= 15) {
        membershipBonus = memberships * BONUS_RATES.membership.tier3;
      } else if (memberships >= 10) {
        membershipBonus = memberships * BONUS_RATES.membership.tier2;
      } else if (memberships >= 1) {
        membershipBonus = memberships * BONUS_RATES.membership.tier1;
      }
      
      let performanceBonus = 0;
      if (staffData.hours && staffData.eligibleGuests !== undefined) {
        const performanceScore = calculatePerformanceScore(staffData);
        if (performanceScore >= PERFORMANCE_THRESHOLDS.good) {
          performanceBonus = BONUS_RATES.performanceBonus;
        }
      }
      
      return {
        enhanceBonus: parseFloat(enhanceBonus.toFixed(2)),
        membershipBonus: parseFloat(membershipBonus.toFixed(2)),
        performanceBonus: parseFloat(performanceBonus.toFixed(2)),
        total: parseFloat((enhanceBonus + membershipBonus + performanceBonus).toFixed(2)),
        status: 'calculated',
        enhanceRate,
        enhancePercent: enhancePercent.toFixed(1),
        membershipTier: memberships >= 15 ? 3 : memberships >= 10 ? 2 : 1
      };
    }

 // Replace the periodOptions array around line 1097 with this corrected version:
const periodOptions = [
  { value: "current", label: "Sep 21 - Oct 4, 2025 (Current)", disabled: false },
  { value: "sep7", label: "Sep 7-20, 2025", disabled: false },
  { value: "aug24", label: "Aug 24 - Sep 6, 2025", disabled: false },
  { value: "aug10", label: "Aug 10-23, 2025", disabled: false },
  { value: "jul27", label: "Jul 27 - Aug 9, 2025", disabled: false },
  { value: "jul13", label: "Jul 13-26, 2025", disabled: false },
  { value: "jun29", label: "Jun 29 - Jul 12, 2025", disabled: false },
  { value: "jun15", label: "Jun 15-28, 2025", disabled: false },
  { value: "jun1", label: "Jun 1-14, 2025", disabled: false },
  { value: "may18", label: "May 18-31, 2025", disabled: false },
  { value: "may4", label: "May 4-17, 2025", disabled: false },
  { value: "apr20", label: "Apr 20 - May 3, 2025", disabled: false },
  { value: "apr6", label: "Apr 6-19, 2025", disabled: false },
  { value: "mar23", label: "Mar 23 - Apr 5, 2025", disabled: false },
  { value: "mar9", label: "Mar 9-22, 2025", disabled: false },
  { value: "feb23", label: "Feb 23 - Mar 8, 2025", disabled: false },
  { value: "feb9", label: "Feb 9-22, 2025", disabled: false },
  { value: "jan26", label: "Jan 26 - Feb 8, 2025", disabled: false },
  { value: "jan12", label: "Jan 12-25, 2025", disabled: false },
  { value: "jan1", label: "Jan 1-11, 2025", disabled: false },
  
  // Future periods
  { value: "oct5", label: "Oct 5-18, 2025", disabled: false },
  { value: "oct19", label: "Oct 19 - Nov 1, 2025", disabled: false },
  { value: "nov2", label: "Nov 2-15, 2025", disabled: false },
  { value: "nov16", label: "Nov 16-29, 2025", disabled: false },
